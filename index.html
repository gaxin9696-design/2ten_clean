<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Movie / Anime</title>
  <style>
    :root{
      --bg:#0b0e14;
      --card:#111827;
      --muted:#9ca3af;
      --line:#1f2937;
      --accent:#22c55e;
      --accent2:#60a5fa;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(180deg, #070a10 0%, #0b0e14 25%, #06080d 100%);
      color:#e5e7eb;
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:10px 0 18px;border-bottom:1px solid var(--line)
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:40px;height:40px;border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(34,197,94,.6), rgba(96,165,250,.35));
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
    }
    .brand h1{font-size:18px;margin:0}
    .nav{display:flex;gap:8px;flex-wrap:wrap}
    .nav-btn{
      padding:8px 12px;border:1px solid var(--line);border-radius:999px;
      background:rgba(255,255,255,.03);cursor:pointer;
      font-weight:600;font-size:13px;color:#e5e7eb;
    }
    .nav-btn.active{
      border-color: rgba(34,197,94,.5);
      box-shadow: 0 0 0 3px rgba(34,197,94,.15) inset;
    }
    .searchbar{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      padding:18px 0 14px;
    }
    .input{
      flex: 1 1 320px;
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;
      background:rgba(255,255,255,.03);border:1px solid var(--line);
    }
    .input input{
      width:100%;border:none;outline:none;background:transparent;color:#e5e7eb;
      font-size:14px;
    }
    .pill{
      padding:8px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);color:#e5e7eb;
      font-size:13px;cursor:pointer;font-weight:600;
    }
    .pill:hover{border-color:rgba(255,255,255,.18)}
    .grid{
      display:grid;grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(4, 1fr);} }
    @media (max-width: 760px){ .grid{grid-template-columns: repeat(3, 1fr);} }
    @media (max-width: 520px){ .grid{grid-template-columns: repeat(2, 1fr);} }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:18px;overflow:hidden;
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
      display:flex;flex-direction:column;
    }
    .thumb{
      aspect-ratio: 2/3;
      width:100%;
      background: #0f172a;
      display:flex;align-items:center;justify-content:center;
      position:relative;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .badge{
      position:absolute;left:10px;top:10px;
      padding:6px 10px;border-radius:999px;
      font-size:12px;font-weight:800;
      background:rgba(0,0,0,.45);backdrop-filter: blur(8px);
      border:1px solid rgba(255,255,255,.12);
    }
    .badge.q{left:auto;right:10px}
    .meta{padding:12px 12px 14px;display:flex;flex-direction:column;gap:6px}
    .title{
      font-weight:800;font-size:14px;line-height:1.25;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
      min-height: 36px;
    }
    .sub{display:flex;gap:8px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
    .chip{
      padding:4px 8px;border:1px solid var(--line);border-radius:999px;
      background:rgba(255,255,255,.02);font-weight:700;color:#d1d5db;
    }
    .row{display:flex;justify-content:space-between;align-items:center;margin-top:4px}
    .imdb{font-weight:900;color:#fbbf24}
    .btn{
      display:inline-flex;gap:8px;align-items:center;justify-content:center;
      padding:9px 10px;border-radius:12px;border:1px solid rgba(34,197,94,.35);
      background:rgba(34,197,94,.10);
      font-weight:800;font-size:13px;
    }
    .btn:hover{background:rgba(34,197,94,.16)}
    .hero{
      margin:14px 0 18px;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.08);
      background: radial-gradient(circle at 20% 20%, rgba(96,165,250,.22), transparent 55%),
                  radial-gradient(circle at 80% 30%, rgba(34,197,94,.18), transparent 55%),
                  rgba(255,255,255,.02);
      overflow:hidden;
      position:relative;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
    }
    .hero-inner{display:grid;grid-template-columns: 1.1fr .9fr;gap:16px;padding:18px}
    @media (max-width: 860px){ .hero-inner{grid-template-columns:1fr;} }
    .hero h2{margin:0;font-size:22px}
    .hero p{margin:8px 0 0;color:#d1d5db;line-height:1.5}
    .hero-box{
      border-radius:18px;border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.25);
      padding:14px;
      display:flex;flex-direction:column;gap:10px;
    }
    .hero-preview{
      border-radius:16px;overflow:hidden;aspect-ratio: 16/9;
      background:#0b1222;border:1px solid rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:center;
      position:relative;
    }
    .hero-preview img{width:100%;height:100%;object-fit:cover;display:block}
    .hero-dots{display:flex;gap:6px;justify-content:center}
    .dot{
      width:8px;height:8px;border-radius:999px;
      background:rgba(255,255,255,.22);
      border:1px solid rgba(255,255,255,.18);
    }
    .dot.on{background:rgba(34,197,94,.75);border-color:rgba(34,197,94,.75)}
    footer{padding:22px 0 6px;color:var(--muted);font-size:12px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Movies / Anime Library</h1>
          <div style="color:var(--muted);font-size:12px;margin-top:2px">Browse ‚Ä¢ Filter ‚Ä¢ Watch</div>
        </div>
      </div>
      <nav class="nav">
        <button class="nav-btn active" data-kind="all">T·∫•t c·∫£</button>
        <button class="nav-btn" data-kind="movie">Movie</button>
        <button class="nav-btn" data-kind="anime">Anime</button>
      </nav>
    </header>

    <section class="hero" id="hero">
      <div class="hero-inner">
        <div>
          <h2>G·ª£i √Ω h√¥m nay</h2>
          <p>Ch·ªçn th·ªÉ lo·∫°i, t√¨m nhanh theo t√™n, l·ªçc ch·∫•t l∆∞·ª£ng/nƒÉm v√† b·∫•m Watch ƒë·ªÉ xem.</p>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
            <button class="pill" id="shuffleBtn">üé≤ Random</button>
            <button class="pill" id="clearFilter">üßπ Clear Filter</button>
          </div>
        </div>
        <div class="hero-box">
          <div class="hero-preview" id="heroPreview">
            <div style="color:var(--muted);font-weight:800">ƒêang t·∫£i...</div>
          </div>
          <div class="hero-dots" id="heroDots"></div>
        </div>
      </div>
    </section>

    <div class="searchbar">
      <div class="input">
        üîé
        <input id="q" placeholder="T√¨m theo t√™n / year / country..." autocomplete="off" />
      </div>
      <select class="pill" id="qualitySel">
        <option value="">Quality: All</option>
        <option>HD</option>
        <option>FHD</option>
        <option>4K</option>
      </select>
      <select class="pill" id="yearSel">
        <option value="">Year: All</option>
      </select>
      <select class="pill" id="countrySel">
        <option value="">Country: All</option>
      </select>
      <select class="pill" id="genreSel">
        <option value="">Genre: All</option>
      </select>
    </div>

    <div class="grid" id="grid"></div>

    <footer>
      ¬© <span id="yearNow"></span> ‚Ä¢ Local JSON/Supabase compatible
    </footer>
  </div>

  <script>
    // ================== CONFIG ==================
    // N·∫øu b·∫°n d√πng Supabase, ƒëi·ªÅn URL + anon key + t√™n table.
    // N·∫øu kh√¥ng, script s·∫Ω fallback d·ªØ li·ªáu demo ho·∫∑c b·∫°n t·ª± n·∫°p JSON.
    const SUPABASE_URL = "https://nzalaxolteaiafvuceqz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56YWxheG9sdGVhaWFmdnVjZXF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTY2MjAsImV4cCI6MjA4NTg3MjYyMH0.0eIz6cfB4Dr_g5Wja70tZCMvVfUKoI5H4D8MJBP49Bg";
    const TABLE = "movies";

    const STORAGE_KEY = "movieapp_data_cache_v1";

    // ================== STATE ==================
    const state = {
      kind: "all", // all | movie | anime
      q: "",
      quality: "",
      year: "",
      country: "",
      genre: "",
      items: [],
      heroItems: [],
      heroIndex: 0,
      heroTimer: null,
    };

    const el = {
      grid: document.getElementById("grid"),
      q: document.getElementById("q"),
      qualitySel: document.getElementById("qualitySel"),
      yearSel: document.getElementById("yearSel"),
      countrySel: document.getElementById("countrySel"),
      genreSel: document.getElementById("genreSel"),
      shuffleBtn: document.getElementById("shuffleBtn"),
      clearFilter: document.getElementById("clearFilter"),
      navBtns: [...document.querySelectorAll(".nav .nav-btn")],
      heroPreview: document.getElementById("heroPreview"),
      heroDots: document.getElementById("heroDots"),
      yearNow: document.getElementById("yearNow"),
    };

    function safeText(s){ return String(s ?? ""); }

    function escapeHtml(s){
      return safeText(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function pick(obj, keys){
      const o = {};
      for(const k of keys) o[k] = obj[k];
      return o;
    }

    function normalizeItem(x){
      // Map d·ªØ li·ªáu nhi·ªÅu format v·ªÅ 1 format chung
      return {
        id: safeText(x.id ?? x.slug ?? crypto.randomUUID()),
        title: safeText(x.title ?? x.name ?? "Untitled"),
        kind: safeText(x.kind ?? x.type ?? "movie"),
        year: safeText(x.year ?? ""),
        quality: safeText(x.quality ?? x.q ?? ""),
        imdb: safeText(x.imdb ?? x.rating ?? ""),
        country: safeText(x.country ?? x.nation ?? ""),
        genre: safeText(x.genre ?? x.categories ?? ""),
        poster: safeText(x.poster ?? x.thumb ?? x.image ?? ""),
        url: safeText(x.url ?? x.link ?? x.watch ?? ""),
      };
    }

    async function loadData(){
      // 1) localStorage cache
      const old = localStorage.getItem(STORAGE_KEY);
      if(old){
        try{
          const parsed = JSON.parse(old);
          if(Array.isArray(parsed) && parsed.length){
            state.items = parsed.map(normalizeItem);
            return;
          }
        }catch{}
      }

      // 2) Supabase (n·∫øu c√≥)
      if(SUPABASE_URL && SUPABASE_ANON_KEY){
        try{
          // load supabase dynamic
          const script = document.createElement("script");
          script.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2";
          document.head.appendChild(script);
          await new Promise((res, rej)=>{script.onload=res; script.onerror=rej;});

          const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          const { data, error } = await supabase.from(TABLE).select("*");
          if(error) throw error;

          state.items = (data ?? []).map(normalizeItem);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state.items));
          return;
        }catch(err){
          console.warn("Supabase load failed, fallback demo:", err);
        }
      }

      // 3) demo fallback
      const fallback = [
        {
          id: "demo1",
          title: "Demo Movie",
          kind: "movie",
          year: "2026",
          quality: "FHD",
          imdb: "6.8",
          country: "VN",
          genre: "Action",
          poster: "",
          url: "watch.html?url=",
        },
        {
          id: "demo2",
          title: "Demo Anime",
          kind: "anime",
          year: "2025",
          quality: "HD",
          imdb: "7.4",
          country: "JP",
          genre: "Fantasy",
          poster: "",
          url: "watch.html?url=",
        }
      ];
      state.items = fallback.map(normalizeItem);
    }

    function uniqueSorted(list){
      const set = new Set();
      list.forEach(v=>{
        const s = safeText(v).trim();
        if(s) set.add(s);
      });
      return [...set].sort((a,b)=>a.localeCompare(b));
    }

    function buildFilters(){
      // years numeric sort desc
      const years = uniqueSorted(state.items.map(x=>x.year)).sort((a,b)=>{
        const na=Number(a), nb=Number(b);
        if(!Number.isNaN(na) && !Number.isNaN(nb)) return nb-na;
        return b.localeCompare(a);
      });

      const countries = uniqueSorted(state.items.map(x=>x.country));
      const genres = uniqueSorted(state.items.map(x=>x.genre));

      // fill selects (keep first option)
      function fill(sel, arr){
        const first = sel.options[0];
        sel.innerHTML = "";
        sel.appendChild(first);
        arr.forEach(v=>{
          const opt=document.createElement("option");
          opt.value=v; opt.textContent=v;
          sel.appendChild(opt);
        });
      }
      fill(el.yearSel, years);
      fill(el.countrySel, countries);
      fill(el.genreSel, genres);
    }

    function applyFilters(items){
      const q = state.q.trim().toLowerCase();
      return items.filter(x=>{
        if(state.kind !== "all" && x.kind !== state.kind) return false;
        if(state.quality && x.quality !== state.quality) return false;
        if(state.year && x.year !== state.year) return false;
        if(state.country && x.country !== state.country) return false;
        if(state.genre && x.genre !== state.genre) return false;

        if(q){
          const hay = `${x.title} ${x.year} ${x.country} ${x.genre} ${x.quality}`.toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });
    }

    function cardHtml(x){
      const poster = x.poster ? `<img src="${escapeHtml(x.poster)}" alt="${escapeHtml(x.title)}">` : `<div style="color:var(--muted);font-weight:900">No Poster</div>`;
      const badgeKind = x.kind ? `<div class="badge">${escapeHtml(x.kind.toUpperCase())}</div>` : "";
      const badgeQ = x.quality ? `<div class="badge q">${escapeHtml(x.quality)}</div>` : "";
      const imdb = x.imdb ? `<div class="imdb">‚≠ê ${escapeHtml(x.imdb)}</div>` : `<div style="color:var(--muted);font-weight:900">‚Äî</div>`;
      const url = x.url || `watch.html?url=${encodeURIComponent(x.id)}`;
      return `
        <article class="card">
          <div class="thumb">
            ${poster}
            ${badgeKind}
            ${badgeQ}
          </div>
          <div class="meta">
            <div class="title">${escapeHtml(x.title)}</div>
            <div class="sub">
              ${x.year ? `<span class="chip">${escapeHtml(x.year)}</span>`:""}
              ${x.country ? `<span class="chip">${escapeHtml(x.country)}</span>`:""}
              ${x.genre ? `<span class="chip">${escapeHtml(x.genre)}</span>`:""}
            </div>
            <div class="row">
              ${imdb}
              <a class="btn" href="${escapeHtml(url)}">‚ñ∂ Watch</a>
            </div>
          </div>
        </article>
      `;
    }

    function render(){
      const filtered = applyFilters(state.items);
      el.grid.innerHTML = filtered.map(cardHtml).join("");
      buildHero(filtered);
    }

    function buildHero(filtered){
      // pick up to 5 items for hero
      const items = (filtered.length ? filtered : state.items).slice(0, 5);
      state.heroItems = items;
      state.heroIndex = 0;
      renderHero();
      renderHeroDots();
      resetHeroTimer();
    }

    function renderHero(){
      const x = state.heroItems[state.heroIndex];
      if(!x){
        el.heroPreview.innerHTML = `<div style="color:var(--muted);font-weight:900">No items</div>`;
        return;
      }
      const poster = x.poster ? `<img src="${escapeHtml(x.poster)}" alt="${escapeHtml(x.title)}">` : `<div style="color:var(--muted);font-weight:900">No Poster</div>`;
      const url = x.url || `watch.html?url=${encodeURIComponent(x.id)}`;
      el.heroPreview.innerHTML = `
        <a href="${escapeHtml(url)}" style="width:100%;height:100%;display:block;position:relative">
          ${poster}
          <div style="position:absolute;left:10px;bottom:10px;right:10px;
            padding:10px 12px;border-radius:14px;background:rgba(0,0,0,.45);
            border:1px solid rgba(255,255,255,.14);backdrop-filter: blur(10px);">
            <div style="font-weight:900">${escapeHtml(x.title)}</div>
            <div style="margin-top:4px;color:#d1d5db;font-size:12px;display:flex;gap:8px;flex-wrap:wrap">
              ${x.kind ? `<span class="chip">${escapeHtml(x.kind.toUpperCase())}</span>`:""}
              ${x.year ? `<span class="chip">${escapeHtml(x.year)}</span>`:""}
              ${x.quality ? `<span class="chip">${escapeHtml(x.quality)}</span>`:""}
              ${x.country ? `<span class="chip">${escapeHtml(x.country)}</span>`:""}
            </div>
          </div>
        </a>
      `;
      updateHeroDots();
    }

    function renderHeroDots(){
      el.heroDots.innerHTML = "";
      for(let i=0;i<state.heroItems.length;i++){
        const d=document.createElement("div");
        d.className="dot" + (i===state.heroIndex ? " on":"");
        d.addEventListener("click", ()=>{ state.heroIndex=i; renderHero(); });
        el.heroDots.appendChild(d);
      }
    }

    function updateHeroDots(){
      [...el.heroDots.querySelectorAll(".dot")]
        .forEach((d,i)=>d.classList.toggle("on", i===state.heroIndex));
    }

    function resetHeroTimer(){
      if(state.heroTimer) clearInterval(state.heroTimer);
      state.heroTimer = setInterval(()=>{
        if(!state.heroItems.length) return;
        state.heroIndex = (state.heroIndex + 1) % state.heroItems.length;
        renderHero();
      }, 3500);
    }

    function shuffle(){
      // Fisher-Yates
      const a = [...state.items];
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      state.items = a;
      render();
    }

    function clearFilters(){
      state.kind="all";
      state.q="";
      state.quality="";
      state.year="";
      state.country="";
      state.genre="";
      el.q.value="";
      el.qualitySel.value="";
      el.yearSel.value="";
      el.countrySel.value="";
      el.genreSel.value="";
      el.navBtns.forEach(b=>b.classList.toggle("active", b.dataset.kind==="all"));
      render();
    }

    function bind(){
      el.q.addEventListener("input", ()=>{
        state.q = el.q.value;
        render();
      });
      el.qualitySel.addEventListener("change", ()=>{
        state.quality = el.qualitySel.value;
        render();
      });
      el.yearSel.addEventListener("change", ()=>{
        state.year = el.yearSel.value;
        render();
      });
      el.countrySel.addEventListener("change", ()=>{
        state.country = el.countrySel.value;
        render();
      });
      el.genreSel.addEventListener("change", ()=>{
        state.genre = el.genreSel.value;
        render();
      });
      el.shuffleBtn.addEventListener("click", shuffle);
      el.clearFilter.addEventListener("click", clearFilters);
      el.navBtns.forEach(btn=>{
        btn.addEventListener("click", ()=>{
          state.kind = btn.dataset.kind;
          el.navBtns.forEach(b=>b.classList.toggle("active", b===btn));
          render();
        });
      });
    }

    (async function init(){
      el.yearNow.textContent = String(new Date().getFullYear());
      await loadData();
      buildFilters();
      bind();
      render();
    })();
  </script>
</body>
</html>
