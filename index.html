<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PhimApp ‚Ä¢ Home</title>
  <style>
    :root{
      --bg0:#0a0b10;
      --bg1:#0f1320;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.04);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.16);
      --text:#e9edf6;
      --muted:#a6b0c3;
      --muted2:#7f8aa6;
      --accent:#f1c55a;
      --accent2:#60a5fa;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --shadow2: 0 10px 30px rgba(0,0,0,.35);
      --r12:12px; --r16:16px; --r20:20px; --r24:24px;
      --max: 1180px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(900px 520px at 20% 8%, rgba(96,165,250,.18), transparent 58%),
        radial-gradient(900px 520px at 78% 12%, rgba(241,197,90,.12), transparent 58%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:var(--max);margin:0 auto;padding:18px}
    @media (max-width:540px){ .wrap{padding:14px} }

    .topbar{
      position:sticky; top:0; z-index:50;
      background: linear-gradient(180deg, rgba(10,11,16,.92), rgba(10,11,16,.75));
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .topbar-inner{
      max-width:var(--max);
      margin:0 auto;
      padding:12px 18px;
      display:flex; align-items:center; gap:14px;
    }
    .brand{display:flex; align-items:center; gap:10px; min-width: 160px; cursor:pointer;}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background:
        radial-gradient(circle at 30% 25%, rgba(241,197,90,.9), rgba(96,165,250,.35)),
        rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow2);
    }
    .brand .t1{font-weight:950; letter-spacing:.2px; line-height:1}
    .brand .t2{font-size:11px; color:var(--muted2); margin-top:2px}

    .search{
      flex: 1 1 auto;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      min-width: 240px;
    }
    .search input{
      width:100%;
      border:none; outline:none;
      background:transparent;
      color:var(--text);
      font-size:14px;
    }
    .search:focus-within{
      border-color: rgba(241,197,90,.45);
      box-shadow: 0 0 0 4px rgba(241,197,90,.12);
    }

    .menu{display:flex; align-items:center; gap:6px; flex: 0 0 auto;}
    .mitem{
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid transparent;
      color: rgba(233,237,246,.92);
      font-weight:800;
      font-size:13px;
      opacity:.92;
      cursor:pointer;
      white-space:nowrap;
      user-select:none;
    }
    .mitem:hover{border-color: rgba(255,255,255,.10); background: rgba(255,255,255,.03); opacity:1;}
    .mitem.active{
      border-color: rgba(241,197,90,.35);
      background: rgba(241,197,90,.10);
    }

    .member{
      margin-left:6px;
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
      user-select:none;
    }
    .member .dot{width:10px;height:10px;border-radius:999px;background: rgba(241,197,90,.9);box-shadow: 0 0 0 3px rgba(241,197,90,.14);}

    @media (max-width: 980px){
      .menu{display:none}
      .brand{min-width:auto}
    }

    .dropdown{position:relative; display:inline-block;}
    .dd-panel{
      position:absolute;
      top:44px; left:0;
      width: 240px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,11,16,.92);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow2);
      padding:8px;
      display:none;
      max-height: 280px;
      overflow:auto;
    }
    .dd-panel.open{display:block;}
    .dd-item{
      padding:10px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:800;
      color: rgba(233,237,246,.92);
      display:flex; align-items:center; justify-content:space-between;
      border:1px solid transparent;
      user-select:none;
    }
    .dd-item:hover{background: rgba(255,255,255,.05); border-color: rgba(255,255,255,.08);}
    .dd-item small{color:var(--muted2); font-weight:900}

    .section-title{
      display:flex; align-items:center; gap:10px;
      margin:18px 0 12px;
      font-weight:950;
      letter-spacing:.2px;
      font-size:26px;
    }
    .section-title .pill{
      margin-left:6px;
      display:inline-flex; align-items:center; justify-content:center;
      width:34px;height:34px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-size:16px;
      opacity:.9;
    }

    .hero{
      border-radius: var(--r24);
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    /* ‚úÖ banner layer (fix banner kh√¥ng hi·ªán) */
    .hero .hero-banner{
      position:absolute; inset:0;
      background-size: cover;
      background-position: center;
      filter: blur(0px);
      opacity:.22;
      transform: scale(1.02);
    }
    .hero .hero-banner::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(1200px 520px at 70% 50%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(180deg, rgba(10,11,16,.25), rgba(10,11,16,.75));
    }

    .hero-inner{
      position:relative;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:18px;
      padding:22px;
      min-height: 360px;
    }
    @media (max-width: 900px){ .hero-inner{grid-template-columns:1fr; min-height:unset} }

    .hero-left{display:flex; flex-direction:column; gap:12px; padding:10px 6px; max-width: 560px;}
    .hero-h1{font-size:34px;font-weight:980;letter-spacing:.2px;margin:0;line-height:1.12;}
    .hero-sub{color: rgba(233,237,246,.85);font-size:14px;margin-top:-4px;}

    .meta-row{display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;}
    .tag{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      font-weight:900;
      font-size:12px;
      color: rgba(233,237,246,.92);
    }
    .tag.imdb{border-color: rgba(241,197,90,.35); box-shadow: 0 0 0 3px rgba(241,197,90,.08) inset;}
    .hero-desc{margin:6px 0 0;color: rgba(233,237,246,.84);line-height:1.55;font-size:14px;max-width: 560px;}

    .hero-actions{display:flex; gap:12px; flex-wrap:wrap; margin-top:8px; align-items:center;}
    .btn-play{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      height:48px; padding:0 18px;
      border-radius: 999px;
      border:1px solid rgba(241,197,90,.35);
      background: linear-gradient(180deg, rgba(241,197,90,.95), rgba(241,197,90,.72));
      color:#14161f;
      font-weight:980;
      cursor:pointer;
      box-shadow: 0 16px 40px rgba(241,197,90,.16);
    }
    .btn-ghost{
      display:inline-flex; align-items:center; justify-content:center;
      height:44px; width:44px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      font-weight:950;
      color: rgba(233,237,246,.92);
      user-select:none;
    }
    .btn-ghost:hover{background: rgba(255,255,255,.10);}

    .hero-right{display:flex; align-items:flex-end; justify-content:flex-end; padding:10px 6px;}
    .preview-box{
      width:min(420px, 100%);
      border-radius: var(--r20);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .preview-media{
      aspect-ratio: 16/9;
      background: rgba(255,255,255,.05);
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:center;
      color: rgba(233,237,246,.78);
      font-weight:950;
      letter-spacing:.2px;
      background-size: cover;
      background-position: center;
    }
    .preview-info{padding:12px 12px 14px; display:flex; flex-direction:column; gap:8px;}
    .line{height:10px; border-radius:999px; background: rgba(255,255,255,.08);}
    .line.w60{width:60%}
    .line.w80{width:80%}
    .line.w40{width:40%}

    .carousel{
      margin-top:14px;
      border-radius: var(--r24);
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .carousel-inner{padding:14px 14px 16px;}
    .strip{display:flex; gap:10px; overflow:auto; padding-bottom: 4px; scroll-snap-type: x mandatory;}
    .strip::-webkit-scrollbar{height:10px}
    .strip::-webkit-scrollbar-thumb{background: rgba(255,255,255,.10); border-radius:999px;}

    .thumb{
      scroll-snap-align:start;
      width:92px; flex: 0 0 92px;
      aspect-ratio: 2/3;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(60px 60px at 30% 20%, rgba(241,197,90,.10), transparent 65%),
        radial-gradient(60px 60px at 70% 30%, rgba(96,165,250,.10), transparent 65%),
        rgba(0,0,0,.22);
      box-shadow: 0 10px 24px rgba(0,0,0,.30);
      position:relative;
      overflow:hidden;
      cursor:pointer;
      user-select:none;
      transition: .12s ease;
      background-size:cover;
      background-position:center;
    }
    .thumb:hover{border-color: rgba(255,255,255,.20); transform: translateY(-2px);}
    .thumb.active{
      border-color: rgba(241,197,90,.45);
      box-shadow: 0 0 0 4px rgba(241,197,90,.10) inset, 0 10px 24px rgba(0,0,0,.30);
    }
    .thumb::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.55));
      pointer-events:none;
      opacity:.9;
    }
    .thumb .tlabel{
      position:absolute; left:8px; right:8px; bottom:8px;
      padding:8px 8px;
      border-radius: 12px;
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.12);
      font-weight:950;
      font-size:11px;
      line-height:1.2;
      color: rgba(233,237,246,.95);
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
      z-index:2;
    }
    .thumb .fav{
      position:absolute; right:8px; top:8px;
      width:26px;height:26px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      font-size:14px;
      opacity:.95;
      z-index:2;
    }

    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.60);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:100;
    }
    .modal-backdrop.open{display:flex;}
    .modal{
      width:min(760px, 100%);
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,11,16,.92);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modal-title{font-weight:980}
    .modal-body{padding:14px 16px; color: rgba(233,237,246,.88); line-height:1.55;}
    .modal-close{
      border:none;
      background: rgba(255,255,255,.06);
      color: var(--text);
      width:38px;height:38px;border-radius:999px;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.12);
      font-weight:950;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: rgba(10,11,16,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding:10px 14px;
      box-shadow: var(--shadow2);
      color: rgba(233,237,246,.92);
      font-weight:900;
      font-size:13px;
      display:none;
      z-index:120;
      max-width:min(92vw, 760px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{display:block;}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand" id="homeBtn" title="V·ªÅ trang ch·ªß">
        <div class="logo"></div>
        <div>
          <div class="t1">PhimApp</div>
          <div class="t2">Load Supabase/localStorage ‚Ä¢ Stream Drive</div>
        </div>
      </div>

      <div class="search">
        <div>üîé</div>
        <input id="searchInput" placeholder="T√¨m ki·∫øm phim, di·ªÖn vi√™n..." />
      </div>

      <div class="menu">
        <div class="dropdown">
          <div class="mitem" id="btnGenre">Th·ªÉ lo·∫°i ‚ñæ</div>
          <div class="dd-panel" id="ddGenre"></div>
        </div>
        <div class="mitem" id="btnMovie">Phim L·∫ª</div>
        <div class="mitem" id="btnSeries">Phim B·ªô</div>
        <div class="dropdown">
          <div class="mitem" id="btnCountry">Qu·ªëc gia ‚ñæ</div>
          <div class="dd-panel" id="ddCountry"></div>
        </div>
        <a class="mitem" href="list.html">Danh s√°ch</a>
      </div>

      <div class="member" id="memberBtn" title="M·ªü trang Admin">
        <span class="dot"></span>
        <span>Th√†nh vi√™n</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="section-title">
      Kho T√†ng Anime M·ªõi Nh·∫•t
      <span class="pill">‚Ä∫</span>
    </div>

    <section class="hero">
      <!-- ‚úÖ banner layer -->
      <div class="hero-banner" id="heroBanner"></div>

      <div class="hero-inner">
        <div class="hero-left">
          <h1 class="hero-h1" id="heroTitle">‚Äî</h1>
          <div class="hero-sub" id="heroSub"></div>
          <div class="meta-row" id="heroMetaTop"></div>
          <div class="meta-row" id="heroMetaTags" style="margin-top:2px"></div>
          <p class="hero-desc" id="heroDesc"></p>
          <div class="hero-actions">
            <button class="btn-play" id="playBtn">‚ñ∂ Xem ngay</button>
            <button class="btn-ghost" id="favBtn" title="Y√™u th√≠ch">‚ô°</button>
            <button class="btn-ghost" id="infoBtn" title="Th√¥ng tin">i</button>
          </div>
        </div>

        <div class="hero-right">
          <div class="preview-box">
            <div class="preview-media" id="heroPoster">PREVIEW</div>
            <div class="preview-info">
              <div class="line w80"></div>
              <div class="line w60"></div>
              <div class="line w40"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="carousel">
      <div class="carousel-inner">
        <div class="strip" id="strip"></div>
      </div>
    </section>
  </div>

  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">Th√¥ng tin</div>
        <button class="modal-close" id="modalClose" aria-label="Close">‚úï</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <div class="toast" id="toast">Loaded</div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ================== CONFIG ==================
    // ‚ö†Ô∏è Anon key c√≥ th·ªÉ public, nh∆∞ng n√™n ƒë·∫∑t RLS + policy ƒë√∫ng.
    const SUPABASE_URL = "https://nzalaxolteaiafvuceqz.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR_ANON_KEY_HERE";
    const SUPABASE_TABLE = "movies";

    const LS_FAV = "phimapp_favs_v1";
    const LS_CACHE = "movieapp_data_cache_v1";

    // fallback demo (n·∫øu Supabase + cache r·ªóng)
    const DEMO = [
      {
        id:"demo1",
        kind:"movie",
        title:"Demo Movie",
        imdb:"7.0",
        quality:"HD",
        year:"2026",
        country:"VN",
        genre:"Demo",
        poster:"",
        banner:"",
        url:"",
        driveid:""
      },
    ];

    const state = {
      DATA: [],
      q: "",
      type: "all",
      genre: "",
      country: "",
      activeId: "",
      favs: new Set(),
    };

    const el = {
      searchInput: document.getElementById("searchInput"),
      strip: document.getElementById("strip"),

      heroTitle: document.getElementById("heroTitle"),
      heroSub: document.getElementById("heroSub"),
      heroMetaTop: document.getElementById("heroMetaTop"),
      heroMetaTags: document.getElementById("heroMetaTags"),
      heroDesc: document.getElementById("heroDesc"),
      heroPoster: document.getElementById("heroPoster"),
      heroBanner: document.getElementById("heroBanner"),

      playBtn: document.getElementById("playBtn"),
      favBtn: document.getElementById("favBtn"),
      infoBtn: document.getElementById("infoBtn"),

      btnGenre: document.getElementById("btnGenre"),
      ddGenre: document.getElementById("ddGenre"),
      btnCountry: document.getElementById("btnCountry"),
      ddCountry: document.getElementById("ddCountry"),

      btnMovie: document.getElementById("btnMovie"),
      btnSeries: document.getElementById("btnSeries"),

      memberBtn: document.getElementById("memberBtn"),
      homeBtn: document.getElementById("homeBtn"),

      modalBackdrop: document.getElementById("modalBackdrop"),
      modalClose: document.getElementById("modalClose"),
      modalTitle: document.getElementById("modalTitle"),
      modalBody: document.getElementById("modalBody"),

      toast: document.getElementById("toast"),
    };

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function toast(msg){
      el.toast.textContent = msg;
      el.toast.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> el.toast.classList.remove("show"), 1400);
    }

    function unique(list){
      const s = new Set();
      list.forEach(v=>{ if(String(v||"").trim()) s.add(String(v).trim()); });
      return [...s].sort((a,b)=>a.localeCompare(b));
    }

    // ===== Drive helpers (poster/banner/video) =====
    function extractDriveId(link){
      const s = String(link || "");
      let m = s.match(/\/file\/d\/([a-zA-Z0-9_-]+)/); if(m) return m[1];
      m = s.match(/open\?id=([a-zA-Z0-9_-]+)/); if(m) return m[1];
      m = s.match(/[?&]id=([a-zA-Z0-9_-]+)/); if(m) return m[1];
      return "";
    }

    // ‚úÖ FIX: thumbnail + fallback ƒë·ªÉ ·∫£nh hi·ªán ·ªïn ƒë·ªãnh h∆°n
    function driveThumbUrl(id, size=1400){
      return `https://drive.google.com/thumbnail?id=${encodeURIComponent(id)}&sz=w${size}`;
    }
    function driveUcViewUrl(id){
      return `https://drive.google.com/uc?export=view&id=${encodeURIComponent(id)}`;
    }
    function driveBgCss(id, size=1400){
      // CSS multiple backgrounds => fallback
      return `url('${driveThumbUrl(id,size)}'), url('${driveUcViewUrl(id)}')`;
    }

    function loadFavs(){
      try{
        const raw = localStorage.getItem(LS_FAV);
        const arr = JSON.parse(raw || "[]");
        state.favs = new Set(Array.isArray(arr) ? arr : []);
      }catch{
        state.favs = new Set();
      }
    }
    function saveFavs(){
      localStorage.setItem(LS_FAV, JSON.stringify([...state.favs]));
    }

    function readCache(){
      const s = localStorage.getItem(LS_CACHE);
      if(!s) return [];
      try{
        const arr = JSON.parse(s);
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }
    function writeCache(items){
      localStorage.setItem(LS_CACHE, JSON.stringify(items));
    }

    // ===== Map DB row -> UI item =====
    function mapDbRowToUi(row){
      const kind = String(row.kind ?? row.type ?? "movie");
      const type = (kind === "movie") ? "movie" : "series";

      const posterLink = String(row.poster ?? "");
      const bannerLink = String(row.banner ?? ""); // optional

      const posterId = extractDriveId(posterLink);
      const bannerId = extractDriveId(bannerLink);

      const poster_img = posterId ? driveBgCss(posterId, 1400) : "";
      const banner_img = bannerId ? driveBgCss(bannerId, 1800) : (posterId ? driveBgCss(posterId, 1800) : "");

      // ‚úÖ video driveid: ∆∞u ti√™n row.driveid, n·∫øu tr·ªëng th√¨ l·∫•y t·ª´ row.url (link Drive video)
      const driveid = String(row.driveid ?? "") || extractDriveId(row.url ?? "");

      return {
        id: String(row.id ?? ""),
        type,
        title: String(row.title ?? ""),
        sub: "",
        imdb: String(row.imdb ?? ""),
        quality: String(row.quality ?? ""),
        year: String(row.year ?? ""),
        tags: row.genre ? [String(row.genre)] : [],
        genre: String(row.genre ?? ""),
        country: String(row.country ?? ""),
        desc: String(row.desc ?? row.description ?? ""),
        poster: posterLink,
        banner: bannerLink,
        poster_img,
        banner_img,
        url: String(row.url ?? ""),
        driveid,
        kind,
      };
    }

    async function loadFromSupabase(){
      if(!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY==="YOUR_ANON_KEY_HERE") return [];
      try{
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const { data, error } = await sb
          .from(SUPABASE_TABLE)
          .select("id,title,kind,year,quality,imdb,country,genre,poster,banner,desc,description,url,driveid")
          .order("id", { ascending: false })
          .limit(200);
        if(error) throw error;
        return (data || []).map(mapDbRowToUi);
      }catch(e){
        console.warn("Supabase load failed:", e?.message || e);
        return [];
      }
    }

    async function bootstrapData(){
      const fromDb = await loadFromSupabase();
      if(fromDb.length){
        writeCache(fromDb);
        return { items: fromDb, source: "supabase" };
      }
      const fromCache = readCache();
      if(fromCache.length){
        return { items: fromCache, source: "localStorage" };
      }
      return { items: DEMO.map(mapDbRowToUi), source: "demo" };
    }

    function filteredItems(){
      const q = state.q.trim().toLowerCase();
      return state.DATA.filter(x=>{
        if(state.type !== "all" && x.type !== state.type) return false;
        if(state.genre && x.genre !== state.genre) return false;
        if(state.country && x.country !== state.country) return false;

        if(q){
          const hay = `${x.title} ${x.sub} ${x.year} ${x.genre} ${x.country} ${(x.tags||[]).join(" ")}`.toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });
    }

    function getActive(){
      return state.DATA.find(x=>x.id === state.activeId) || state.DATA[0];
    }

    function renderHero(){
      const x = getActive();
      if(!x){
        el.heroTitle.textContent = "Ch∆∞a c√≥ d·ªØ li·ªáu";
        el.heroSub.textContent = "";
        el.heroMetaTop.innerHTML = "";
        el.heroMetaTags.innerHTML = "";
        el.heroDesc.textContent = "";
        el.favBtn.textContent = "‚ô°";
        el.heroPoster.style.backgroundImage = "";
        el.heroPoster.textContent = "NO PREVIEW";
        el.heroBanner.style.backgroundImage = "";
        return;
      }

      el.heroTitle.textContent = x.title || "‚Äî";
      el.heroSub.textContent = x.sub || "";

      const top = [];
      if(x.imdb) top.push(`<span class="tag imdb">IMDb ${escapeHtml(x.imdb)}</span>`);
      if(x.quality) top.push(`<span class="tag">${escapeHtml(x.quality)}</span>`);
      if(x.year) top.push(`<span class="tag">${escapeHtml(x.year)}</span>`);
      el.heroMetaTop.innerHTML = top.join("");

      el.heroMetaTags.innerHTML = (x.tags || []).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("");
      el.heroDesc.textContent = x.desc || "";

      el.favBtn.textContent = state.favs.has(x.id) ? "‚ô•" : "‚ô°";
      el.favBtn.title = state.favs.has(x.id) ? "B·ªè y√™u th√≠ch" : "Y√™u th√≠ch";

      // ‚úÖ FIX poster: d√πng multiple url backgroundImage (kh√¥ng b·ªçc url() th√™m l·∫ßn n·ªØa)
      if(x.poster_img){
        el.heroPoster.style.backgroundImage = x.poster_img;
        el.heroPoster.textContent = "";
      }else{
        el.heroPoster.style.backgroundImage = "";
        el.heroPoster.textContent = "NO POSTER";
      }

      // ‚úÖ FIX banner
      if(x.banner_img){
        el.heroBanner.style.backgroundImage = x.banner_img;
      }else{
        el.heroBanner.style.backgroundImage = "";
      }
    }

    function renderStrip(){
      const items = filteredItems();
      if(items.length && !items.some(i=>i.id===state.activeId)){
        state.activeId = items[0].id;
      }

      el.strip.innerHTML = items.map(x=>{
        const isActive = x.id===state.activeId;
        const isFav = state.favs.has(x.id);

        // ‚úÖ FIX: poster_img ƒë√£ l√† "url('a'), url('b')" => kh√¥ng b·ªçc url() n·ªØa
        const bg = x.poster_img
          ? `style="background-image:${escapeHtml(x.poster_img)}"`
          : "";

        return `
          <div class="thumb ${isActive ? "active":""}" data-id="${escapeHtml(x.id)}" title="${escapeHtml(x.title)}" ${bg}>
            <div class="fav" title="Y√™u th√≠ch">${isFav ? "‚ô•" : "‚ô°"}</div>
            <div class="tlabel">${escapeHtml(x.title)}</div>
          </div>
        `;
      }).join("");

      [...el.strip.querySelectorAll(".thumb")].forEach(card=>{
        card.addEventListener("click", ()=>{
          const id = card.getAttribute("data-id");
          if(!id) return;
          state.activeId = id;
          renderHero();
          renderStrip();
        });
      });
    }

    function renderDropdowns(){
      const genres = unique(state.DATA.map(x=>x.genre));
      const countries = unique(state.DATA.map(x=>x.country));

      el.ddGenre.innerHTML = [
        `<div class="dd-item" data-v=""><span>T·∫•t c·∫£</span><small>${genres.length}</small></div>`,
        ...genres.map(g=>`<div class="dd-item" data-v="${escapeHtml(g)}"><span>${escapeHtml(g)}</span></div>`)
      ].join("");

      el.ddCountry.innerHTML = [
        `<div class="dd-item" data-v=""><span>T·∫•t c·∫£</span><small>${countries.length}</small></div>`,
        ...countries.map(c=>`<div class="dd-item" data-v="${escapeHtml(c)}"><span>${escapeHtml(c)}</span></div>`)
      ].join("");

      [...el.ddGenre.querySelectorAll(".dd-item")].forEach(it=>{
        it.addEventListener("click", ()=>{
          state.genre = it.getAttribute("data-v") || "";
          closeDropdowns();
          toast(state.genre ? `Genre: ${state.genre}` : "Genre: T·∫•t c·∫£");
          renderStrip();
          renderHero();
          syncMenuActive();
        });
      });

      [...el.ddCountry.querySelectorAll(".dd-item")].forEach(it=>{
        it.addEventListener("click", ()=>{
          state.country = it.getAttribute("data-v") || "";
          closeDropdowns();
          toast(state.country ? `Country: ${state.country}` : "Country: T·∫•t c·∫£");
          renderStrip();
          renderHero();
          syncMenuActive();
        });
      });
    }

    function syncMenuActive(){
      el.btnMovie.classList.toggle("active", state.type==="movie");
      el.btnSeries.classList.toggle("active", state.type==="series");
      el.btnGenre.classList.toggle("active", !!state.genre);
      el.btnCountry.classList.toggle("active", !!state.country);

      el.btnGenre.textContent = state.genre ? `Th·ªÉ lo·∫°i: ${state.genre} ‚ñæ` : "Th·ªÉ lo·∫°i ‚ñæ";
      el.btnCountry.textContent = state.country ? `Qu·ªëc gia: ${state.country} ‚ñæ` : "Qu·ªëc gia ‚ñæ";
    }

    function closeDropdowns(){
      el.ddGenre.classList.remove("open");
      el.ddCountry.classList.remove("open");
    }
    function toggleDropdown(which){
      if(which==="genre"){
        const open = el.ddGenre.classList.toggle("open");
        el.ddCountry.classList.remove("open");
        return open;
      }
      if(which==="country"){
        const open = el.ddCountry.classList.toggle("open");
        el.ddGenre.classList.remove("open");
        return open;
      }
      return false;
    }

    function openModal(title, html){
      el.modalTitle.textContent = title;
      el.modalBody.innerHTML = html;
      el.modalBackdrop.classList.add("open");
      el.modalBackdrop.setAttribute("aria-hidden","false");
    }
    function closeModal(){
      el.modalBackdrop.classList.remove("open");
      el.modalBackdrop.setAttribute("aria-hidden","true");
    }

    function bind(){
      el.searchInput.addEventListener("input", ()=>{
        state.q = el.searchInput.value;
        renderStrip();
        renderHero();
      });

      el.btnGenre.addEventListener("click", (e)=>{ e.stopPropagation(); toggleDropdown("genre"); });
      el.btnCountry.addEventListener("click", (e)=>{ e.stopPropagation(); toggleDropdown("country"); });

      el.btnMovie.addEventListener("click", ()=>{
        state.type = (state.type==="movie") ? "all" : "movie";
        toast(state.type==="movie" ? "Filter: Movie" : "Filter: All");
        renderStrip(); renderHero(); syncMenuActive();
      });
      el.btnSeries.addEventListener("click", ()=>{
        state.type = (state.type==="series") ? "all" : "series";
        toast(state.type==="series" ? "Filter: Series" : "Filter: All");
        renderStrip(); renderHero(); syncMenuActive();
      });

      document.addEventListener("click", ()=> closeDropdowns());

      // ‚úÖ STREAM: b·∫•m xem ngay -> watch.html?id=<movieId>
      // watch.html s·∫Ω l·∫•y driveid t·ª´ cache b·∫±ng movieId, kh√¥ng b·ªã nh·∫ßm.
      el.playBtn.addEventListener("click", ()=>{
        const x = getActive();
        if(!x) return;
        if(!x.driveid){
          toast("‚ùå Thi·∫øu driveid (video). H√£y nh·∫≠p Watch URL (Drive video) ·ªü Admin.");
          return;
        }
        location.href = `watch.html?id=${encodeURIComponent(x.id)}`;
      });

      el.favBtn.addEventListener("click", ()=>{
        const x = getActive();
        if(!x) return;
        if(state.favs.has(x.id)){
          state.favs.delete(x.id);
          toast("ƒê√£ b·ªè y√™u th√≠ch");
        }else{
          state.favs.add(x.id);
          toast("ƒê√£ th√™m y√™u th√≠ch");
        }
        saveFavs();
        renderHero();
        renderStrip();
      });

      el.infoBtn.addEventListener("click", ()=>{
        const x = getActive();
        if(!x) return;
        const html = `
          <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px">
            ${x.imdb ? `<span class="tag imdb">IMDb ${escapeHtml(x.imdb)}</span>`:""}
            ${x.quality ? `<span class="tag">${escapeHtml(x.quality)}</span>`:""}
            ${x.year ? `<span class="tag">${escapeHtml(x.year)}</span>`:""}
            ${x.genre ? `<span class="tag">${escapeHtml(x.genre)}</span>`:""}
            ${x.country ? `<span class="tag">${escapeHtml(x.country)}</span>`:""}
            <span class="tag">${escapeHtml(x.kind || x.type)}</span>
          </div>
          <div><b>Video driveid:</b> ${escapeHtml(x.driveid || "‚Äî")}</div>
          <div><b>Poster:</b> ${escapeHtml(x.poster || "‚Äî")}</div>
          <div><b>Banner:</b> ${escapeHtml(x.banner || "‚Äî")}</div>
          <div style="margin-top:10px;color:rgba(233,237,246,.78)">
            <b>ID:</b> ${escapeHtml(x.id)}
          </div>
        `;
        openModal(x.title || "Th√¥ng tin", html);
      });

      el.modalClose.addEventListener("click", closeModal);
      el.modalBackdrop.addEventListener("click", (e)=>{ if(e.target===el.modalBackdrop) closeModal(); });
      document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeModal(); });

      el.memberBtn.addEventListener("click", ()=>{ location.href = "test.html"; });

      el.homeBtn.addEventListener("click", ()=>{
        state.q=""; state.type="all"; state.genre=""; state.country="";
        el.searchInput.value="";
        toast("Reset filters");
        renderStrip(); renderHero(); syncMenuActive();
      });
    }

    (async function init(){
      loadFavs();

      const boot = await bootstrapData();
      state.DATA = boot.items || [];
      state.activeId = state.DATA[0]?.id || "";

      toast(`Loaded: ${boot.source} (${state.DATA.length})`);

      renderDropdowns();
      syncMenuActive();
      bind();
      renderStrip();
      renderHero();
    })();
  </script>
</body>
</html>
