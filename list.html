<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>List</title>
  <style>
    :root{
      --bg:#0b0e14;
      --card:#111827;
      --muted:#9ca3af;
      --line:#1f2937;
      --accent:#22c55e;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(180deg, #070a10 0%, #0b0e14 25%, #06080d 100%);
      color:#e5e7eb;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:10px 0 18px;border-bottom:1px solid var(--line)}
    h1{font-size:18px;margin:0}
    .bar{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0}
    .pill{
      padding:8px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);color:#e5e7eb;
      font-size:13px;cursor:pointer;font-weight:600;
    }
    .input{
      flex: 1 1 320px;
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;
      background:rgba(255,255,255,.03);border:1px solid var(--line);
    }
    .input input{
      width:100%;border:none;outline:none;background:transparent;color:#e5e7eb;
      font-size:14px;
    }
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th{font-size:12px;color:var(--muted);text-align:left;padding:0 10px}
    td{
      padding:12px 10px;
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-top:1px solid var(--line);
      border-bottom:1px solid var(--line);
      vertical-align:middle;
    }
    tr td:first-child{border-left:1px solid var(--line);border-top-left-radius:14px;border-bottom-left-radius:14px}
    tr td:last-child{border-right:1px solid var(--line);border-top-right-radius:14px;border-bottom-right-radius:14px}
    .chip{display:inline-block;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.02);font-weight:700;color:#d1d5db;font-size:12px}
    .btn{
      display:inline-flex;gap:8px;align-items:center;justify-content:center;
      padding:8px 10px;border-radius:12px;border:1px solid rgba(34,197,94,.35);
      background:rgba(34,197,94,.10);font-weight:800;font-size:13px;color:#e5e7eb;text-decoration:none;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(34,197,94,.16)}
    .muted{color:var(--muted)}
    .titlewrap{display:flex;align-items:center;gap:10px}
    .thumb{
      width:34px;height:48px;border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      background-size:cover;background-position:center;
      flex:0 0 auto;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Danh s√°ch</h1>
        <div class="muted" style="font-size:12px;margin-top:2px">List view + filter ‚Ä¢ Watch stream Drive</div>
      </div>
      <a class="pill" href="index.html">‚Üê Home</a>
    </header>

    <div class="bar">
      <div class="input">üîé <input id="q" placeholder="T√¨m theo t√™n / year / country..." autocomplete="off"></div>
      <select class="pill" id="genreSel"><option value="">Genre: All</option></select>
      <select class="pill" id="countrySel"><option value="">Country: All</option></select>
      <select class="pill" id="yearSel"><option value="">Year: All</option></select>
      <select class="pill" id="qualitySel">
        <option value="">Quality: All</option>
        <option>HD</option>
        <option>FHD</option>
        <option>4K</option>
      </select>
      <button class="pill" id="clearBtn">üßπ Clear</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Kind</th>
          <th>Year</th>
          <th>Country</th>
          <th>Genre</th>
          <th>Quality</th>
          <th>Watch</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <script>
    const STORAGE_KEY = "movieapp_data_cache_v1";

    const el = {
      q: document.getElementById("q"),
      genreSel: document.getElementById("genreSel"),
      countrySel: document.getElementById("countrySel"),
      yearSel: document.getElementById("yearSel"),
      qualitySel: document.getElementById("qualitySel"),
      clearBtn: document.getElementById("clearBtn"),
      tbody: document.getElementById("tbody"),
    };

    const state = { q:"", genre:"", country:"", year:"", quality:"", items:[] };

    function safeText(s){ return String(s ?? ""); }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // ===== Drive helpers =====
    function extractDriveId(link){
      const s = String(link || "");
      let m = s.match(/\/file\/d\/([a-zA-Z0-9_-]+)/); if(m) return m[1];
      m = s.match(/open\?id=([a-zA-Z0-9_-]+)/); if(m) return m[1];
      m = s.match(/[?&]id=([a-zA-Z0-9_-]+)/); if(m) return m[1];
      return "";
    }
    function driveImageUrl(id){
      return `https://drive.google.com/uc?export=view&id=${encodeURIComponent(id)}`;
    }

    // ===== Normalize cache row =====
    // Cache c·ªßa b·∫°n (index.html) c√≥ th·ªÉ l√† UI item: {id,type,title,year,quality,country,genre,poster,poster_img,driveid,...}
    // Admin/Supabase item: {id,title,kind,year,quality,country,genre,poster,url,driveid}
    function normalizeItem(x){
      const posterLink = safeText(x.poster ?? "");
      const posterId = extractDriveId(posterLink);
      const poster_img = safeText(x.poster_img ?? (posterId ? driveImageUrl(posterId) : ""));

      return {
        id: safeText(x.id ?? x.slug ?? crypto.randomUUID()),
        title: safeText(x.title ?? x.name ?? "Untitled"),
        kind: safeText(x.kind ?? x.type ?? "movie"),
        year: safeText(x.year ?? ""),
        quality: safeText(x.quality ?? x.q ?? ""),
        country: safeText(x.country ?? x.nation ?? ""),
        genre: safeText(x.genre ?? x.categories ?? ""),
        poster: posterLink,
        poster_img,
        driveid: safeText(x.driveid ?? ""), // ‚úÖ VIDEO drive id ƒë·ªÉ stream
      };
    }

    function fillSelect(sel, arr, keepFirst=true){
      const first = keepFirst ? sel.options[0] : null;
      sel.innerHTML = "";
      if(first) sel.appendChild(first);
      arr.forEach(v=>{
        const opt=document.createElement("option");
        opt.value=v; opt.textContent=v;
        sel.appendChild(opt);
      });
    }

    function buildDropdowns(){
      const gset = new Set(), cset = new Set(), yset = new Set();
      state.items.forEach(x=>{
        if(x.genre) gset.add(String(x.genre));
        if(x.country) cset.add(String(x.country));
        if(x.year) yset.add(String(x.year));
      });

      const genres = [...gset].sort((a,b)=>a.localeCompare(b));
      const countries = [...cset].sort((a,b)=>a.localeCompare(b));
      const years = [...yset].sort((a,b)=>{
        const na = Number(a), nb = Number(b);
        if(!Number.isNaN(na) && !Number.isNaN(nb)) return nb-na;
        return b.localeCompare(a);
      });

      fillSelect(el.genreSel, genres);
      fillSelect(el.countrySel, countries);
      fillSelect(el.yearSel, years);
    }

    function applyFilters(items){
      const q = state.q.trim().toLowerCase();
      return items.filter(x=>{
        if(state.genre && x.genre !== state.genre) return false;
        if(state.country && x.country !== state.country) return false;
        if(state.year && x.year !== state.year) return false;
        if(state.quality && x.quality !== state.quality) return false;

        if(q){
          const hay = `${x.title} ${x.year} ${x.country} ${x.genre} ${x.quality}`.toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });
    }

    // ‚úÖ Watch lu√¥n stream: watch.html?id=driveid
    function watchHref(x){
      if(!x.driveid) return "#";
      return `watch.html?id=${encodeURIComponent(x.driveid)}`;
    }

    function rowHtml(x){
      const thumbStyle = x.poster_img
        ? `style="background-image:url('${escapeHtml(x.poster_img)}')"`
        : "";

      const href = watchHref(x);
      const watchBtn = x.driveid
        ? `<a class="btn" href="${escapeHtml(href)}">‚ñ∂ Watch</a>`
        : `<span class="muted">Thi·∫øu driveid</span>`;

      return `
        <tr>
          <td>
            <div class="titlewrap">
              <div class="thumb" ${thumbStyle}></div>
              <div><strong>${escapeHtml(x.title)}</strong></div>
            </div>
          </td>
          <td><span class="chip">${escapeHtml(String(x.kind).toUpperCase())}</span></td>
          <td>${x.year ? `<span class="chip">${escapeHtml(x.year)}</span>` : `<span class="muted">‚Äî</span>`}</td>
          <td>${x.country ? `<span class="chip">${escapeHtml(x.country)}</span>` : `<span class="muted">‚Äî</span>`}</td>
          <td>${x.genre ? `<span class="chip">${escapeHtml(x.genre)}</span>` : `<span class="muted">‚Äî</span>`}</td>
          <td>${x.quality ? `<span class="chip">${escapeHtml(x.quality)}</span>` : `<span class="muted">‚Äî</span>`}</td>
          <td>${watchBtn}</td>
        </tr>
      `;
    }

    function render(){
      const filtered = applyFilters(state.items);
      el.tbody.innerHTML = filtered.map(rowHtml).join("");
    }

    function clearAll(){
      state.q=""; state.genre=""; state.country=""; state.year=""; state.quality="";
      el.q.value="";
      el.genreSel.value=""; el.countrySel.value=""; el.yearSel.value=""; el.qualitySel.value="";
      render();
    }

    function bind(){
      el.q.addEventListener("input", ()=>{ state.q = el.q.value; render(); });
      el.genreSel.addEventListener("change", ()=>{ state.genre = el.genreSel.value; render(); });
      el.countrySel.addEventListener("change", ()=>{ state.country = el.countrySel.value; render(); });
      el.yearSel.addEventListener("change", ()=>{ state.year = el.yearSel.value; render(); });
      el.qualitySel.addEventListener("change", ()=>{ state.quality = el.qualitySel.value; render(); });
      el.clearBtn.addEventListener("click", clearAll);
    }

    (function init(){
      const cached = localStorage.getItem(STORAGE_KEY);
      let data = [];
      if(cached){
        try{ data = JSON.parse(cached); }catch{}
      }
      if(!Array.isArray(data) || !data.length){
        data = [
          { id:"demo1", title:"Demo Movie", kind:"movie", year:"2026", country:"VN", genre:"Action", quality:"FHD", poster:"", driveid:"" },
          { id:"demo2", title:"Demo Anime", kind:"anime", year:"2025", country:"JP", genre:"Fantasy", quality:"HD", poster:"", driveid:"" },
        ];
      }

      state.items = data.map(normalizeItem);
      buildDropdowns();
      bind();
      render();
    })();
  </script>
</body>
</html>
