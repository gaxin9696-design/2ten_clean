<!-- =========================
     FILE: list.html (MERGED)
     FIX: Phim bộ/anime chỉ hiện 1 card (không trùng theo tập)
========================= -->
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Khoii – Danh sách phim. Lọc theo thể loại, quốc gia, loại phim, tìm kiếm nhanh." />
  <meta name="robots" content="index,follow" />
  <meta name="theme-color" content="#0b1224" />
  <title>Khoii - List</title>

  <style>
    :root{
      --bg0:#0b0f17; --bg1:#0b1224;
      --text:#e7edf9; --muted:rgba(231,237,249,.72);
      --line:rgba(255,255,255,.10); --line2:rgba(255,255,255,.16);
      --glass:rgba(18,24,36,.72); --glass2:rgba(18,24,36,.55);
      --accent:#f2c64f;
      --radius:22px;
      --shadow:0 18px 65px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,"Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 500px at 20% -10%, rgba(99,102,241,.18), transparent 55%),
        radial-gradient(900px 420px at 85% 10%, rgba(245,158,11,.10), transparent 55%),
        linear-gradient(180deg,var(--bg0),var(--bg1));
      overflow-x:hidden;
    }

    body::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      z-index:0;
      background-image:
        radial-gradient(circle, rgba(255,255,255,.22) 1px, transparent 1.2px),
        radial-gradient(circle, rgba(255,255,255,.14) 1px, transparent 1.25px);
      background-size:7px 7px, 14px 14px;
      background-position:0 0, 3px 3px;
      opacity:.10;
      mix-blend-mode:overlay;
      filter:blur(.15px);
    }

    .container{
      position:relative; z-index:1;
      max-width:1320px;
      margin:0 auto;
      padding:18px 22px 40px;
    }

    .topbar{display:flex;align-items:center;gap:16px}
    .brand{display:flex;align-items:center;gap:10px;min-width:170px;cursor:pointer}
    .brand-logo{
      width:44px;height:34px;border-radius:10px;
      display:grid;place-items:center;
      font-weight:900;letter-spacing:.6px;color:#0b1224;
      background:
        radial-gradient(18px 18px at 30% 35%, rgba(255,255,255,.22), transparent 60%),
        linear-gradient(135deg,#f59e0b,#fb7185);
      box-shadow:0 10px 25px rgba(245,158,11,.22);
      position:relative;overflow:hidden;user-select:none;
    }
    .brand-logo:before{
      content:"";position:absolute;inset:0;
      background:conic-gradient(from 220deg, rgba(0,0,0,.35), transparent 40%, rgba(0,0,0,.28));
      mix-blend-mode:overlay;
    }
    .brand-logo span{position:relative;z-index:1}
    .brand-name{font-weight:900;letter-spacing:.3px;font-size:18px;line-height:1.1}
    .brand-sub{font-size:11px;color:rgba(231,237,249,.55);margin-top:2px}

    .search{
      flex:1;max-width:620px;
      display:flex;align-items:center;gap:10px;
      padding:10px 14px;border-radius:12px;
      background:var(--glass);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 10px 30px rgba(0,0,0,.30);
      backdrop-filter:blur(14px);
    }
    .search input{
      width:100%;border:0;outline:0;background:transparent;
      color:var(--text);font-size:14px;
    }
    .search input::placeholder{color:rgba(231,237,249,.50)}

    .nav{display:flex;align-items:center;gap:14px;margin-left:6px}
    .nav a{
      color:rgba(231,237,249,.88);
      text-decoration:none;font-size:14px;
      display:inline-flex;align-items:center;gap:6px;
      padding:8px 10px;border-radius:10px;
    }
    .nav a:hover{background:rgba(255,255,255,.06)}
    .nav a.active{
      border:1px solid rgba(242,198,79,.35);
      background:rgba(242,198,79,.10);
    }
    .caret{
      width:10px;height:10px;opacity:.9;
      transform:translateY(1px);
    }

    .drop{position:relative}
    .drop-menu{
      position:absolute;
      top:calc(100% + 10px);
      left:0;
      display:none;
      width:520px;
      max-height:340px;
      overflow:auto;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(10,14,22,.92);
      box-shadow:0 18px 65px rgba(0,0,0,.55);
      backdrop-filter:blur(16px);
      z-index:50;
    }
    #menuCountry{width:560px}
    .drop.open .drop-menu{display:block}
    .drop-head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:10px;
    }
    .drop-head b{font-size:13px;letter-spacing:.2px}
    .drop-close{
      width:34px;height:34px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(18,24,36,.45);
      color:rgba(231,237,249,.92);
      cursor:pointer;
    }
    .drop-close:hover{background:rgba(255,255,255,.06)}
    .drop-grid{columns:4; column-gap:10px;}
    .drop-grid.cols-3{columns:3}
    .drop-item{
      break-inside:avoid;
      display:block;
      width:100%;
      margin:0 0 8px;
    }
    .drop-item a{
      display:block;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(18,24,36,.35);
      color:rgba(231,237,249,.88);
      text-decoration:none;
      font-size:13px;
      line-height:1.2;
    }
    .drop-item a:hover{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.16)}
    .drop-item a.on{
      border-color:rgba(242,198,79,.65);
      background:rgba(242,198,79,.12);
    }

    .member-btn{
      margin-left:auto;
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 14px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:var(--glass2);
      color:var(--text);cursor:pointer;
      backdrop-filter:blur(14px);
      box-shadow:0 10px 30px rgba(0,0,0,.24);
    }
    .member-btn:hover{border-color:var(--line2)}
    .member-btn svg{opacity:.95}

    .page-head{
      margin-top:18px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
    }
    .page-head h1{
      margin:0;
      font-size:26px;
      letter-spacing:.2px;
    }
    .page-head .count{
      font-size:13px;
      color:var(--muted);
    }

    .bar{
      margin-top:14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(10,14,22,.58);
      backdrop-filter:blur(10px);
      box-shadow:0 18px 50px rgba(0,0,0,.35);
    }
    .chips{display:flex;flex-wrap:wrap;gap:10px}
    .chip{
      padding:8px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(18,24,36,.45);
      color:rgba(231,237,249,.88);
      cursor:pointer;
      font-size:13px;
    }
    .chip:hover{background:rgba(255,255,255,.06)}
    .chip.on{
      border-color:rgba(242,198,79,.65);
      background:rgba(242,198,79,.12);
    }

    .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select{
      background:rgba(18,24,36,.45);
      color:rgba(231,237,249,.88);
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
    }

    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(18,24,36,.45);
      color:rgba(231,237,249,.92);
      padding:10px 14px;border-radius:999px;
      cursor:pointer;
      backdrop-filter:blur(14px);
      box-shadow:0 10px 30px rgba(0,0,0,.24);
      display:inline-flex;align-items:center;gap:10px;
      white-space:nowrap;
    }
    .btn:hover{border-color:rgba(255,255,255,.20); background:rgba(255,255,255,.06)}

    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns:repeat(7, minmax(0, 1fr));
      gap:14px;
    }
    .card{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(18,24,36,.40);
      overflow:hidden;
      box-shadow:0 18px 50px rgba(0,0,0,.35);
      cursor:pointer;
      transition:transform .14s ease, border-color .14s ease;
      position:relative;
    }
    .card:hover{transform:translateY(-4px); border-color:rgba(255,255,255,.22)}
    .card::after{
      content:"";
      position:absolute;inset:0;pointer-events:none;border-radius:inherit;
      background-image:radial-gradient(circle, rgba(255,255,255,.10) 1px, transparent 1.35px);
      background-size:8px 8px;
      opacity:.18;mix-blend-mode:overlay;z-index:1;
    }
    .img{height:220px;background:#000;border-bottom:1px solid rgba(255,255,255,.10);position:relative;z-index:2}
    .img img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{padding:10px 10px 12px;position:relative;z-index:2}
    .meta b{display:block;font-size:13px;line-height:1.25}
    .meta small{display:block;margin-top:6px;color:rgba(231,237,249,.65)}
    .tag{
      position:absolute; top:10px; left:10px;
      padding:6px 8px;border-radius:999px;
      font-size:11px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(10,14,22,.65);
      backdrop-filter:blur(10px);
      z-index:3;
    }

    .footer{
      margin-top:18px;
      display:flex;justify-content:center;
    }
    .loadmore{
      padding:12px 16px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(18,24,36,.45);
      color:rgba(231,237,249,.92);
      cursor:pointer;
    }
    .loadmore:hover{background:rgba(255,255,255,.06)}

    @media (max-width:1200px){ .grid{grid-template-columns:repeat(6, minmax(0, 1fr));} }
    @media (max-width:1020px){
      .grid{grid-template-columns:repeat(5, minmax(0, 1fr));}
      .brand-sub{display:none}
    }
    @media (max-width:980px){
      .nav{display:none}
      .member-btn span{display:none}
      .drop-menu{left:auto;right:0;width:min(560px, 92vw)}
      #menuCountry{width:min(560px, 92vw)}
      #menuGenre{width:min(520px, 92vw)}
      .drop-grid{columns:3}
    }
    @media (max-width:820px){ .grid{grid-template-columns:repeat(4, minmax(0, 1fr));} }
    @media (max-width:640px){
      .grid{grid-template-columns:repeat(2, minmax(0, 1fr));}
      .page-head h1{font-size:22px}
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="topbar">
      <div class="brand" onclick="location.href='index.html'">
        <div class="brand-logo" aria-hidden="true"><span>K</span></div>
        <div>
          <div class="brand-name">Khoii</div>
          <div class="brand-sub">Danh sách phim</div>
        </div>
      </div>

      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M10.5 19a8.5 8.5 0 1 1 0-17 8.5 8.5 0 0 1 0 17Z" stroke="rgba(231,237,249,.85)" stroke-width="2"/>
          <path d="M16.8 16.8 21 21" stroke="rgba(231,237,249,.85)" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <input id="q" placeholder="Tìm kiếm phim, diễn viên" />
      </div>

      <nav class="nav" aria-label="Main navigation">
        <div class="drop" id="dropGenre">
          <a href="#" id="btnDropGenre" class="nav-btn">
            Thể loại
            <svg class="caret" viewBox="0 0 320 512" fill="currentColor" aria-hidden="true"><path d="M137.4 374.6c12.5 12.5 32.8 12.5 45.3 0l128-128c9.2-9.2 11.9-22.9 6.9-34.9s-16.6-19.8-29.6-19.8L32 192c-12.9 0-24.6 7.8-29.6 19.8s-2.2 25.7 6.9 34.9l128 128z"/></svg>
          </a>
          <div class="drop-menu" id="menuGenre" role="menu" aria-label="Chọn thể loại">
            <div class="drop-head">
              <b>Chọn thể loại</b>
              <button type="button" class="drop-close" data-close="genre" aria-label="Đóng">✕</button>
            </div>
            <div id="genreGrid" class="drop-grid cols-3"></div>
          </div>
        </div>

        <a href="#" class="nav-btn" id="navMovie" data-kind="movie">Phim Lẻ</a>
        <a href="#" class="nav-btn" id="navSeries" data-kind="series">Phim Bộ</a>

        <div class="drop" id="dropCountry">
          <a href="#" id="btnDropCountry" class="nav-btn">
            Quốc gia
            <svg class="caret" viewBox="0 0 320 512" fill="currentColor" aria-hidden="true"><path d="M137.4 374.6c12.5 12.5 32.8 12.5 45.3 0l128-128c9.2-9.2 11.9-22.9 6.9-34.9s-16.6-19.8-29.6-19.8L32 192c-12.9 0-24.6 7.8-29.6 19.8s-2.2 25.7 6.9 34.9l128 128z"/></svg>
          </a>
          <div class="drop-menu" id="menuCountry" role="menu" aria-label="Chọn quốc gia">
            <div class="drop-head">
              <b>Chọn quốc gia</b>
              <button type="button" class="drop-close" data-close="country" aria-label="Đóng">✕</button>
            </div>
            <div id="countryGrid" class="drop-grid"></div>
          </div>
        </div>
      </nav>

      <button class="member-btn" onclick="location.href='test.html'">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 12a4.5 4.5 0 1 0-4.5-4.5A4.5 4.5 0 0 0 12 12Z" stroke="rgba(231,237,249,.9)" stroke-width="2" />
          <path d="M20 21a8 8 0 1 0-16 0" stroke="rgba(231,237,249,.9)" stroke-width="2" stroke-linecap="round" />
        </svg>
        <span>Thành viên</span>
      </button>
    </header>

    <div class="page-head">
      <h1 id="pageTitle">Danh sách phim</h1>
      <div class="count"><span id="count">0</span> phim</div>
    </div>

    <div class="bar">
      <div class="chips" id="chipsKind"></div>
      <div class="right">
        <select id="sort" aria-label="Sắp xếp">
          <option value="new">Mới cập nhật</option>
          <option value="title">Tên A→Z</option>
          <option value="year">Năm (mới→cũ)</option>
        </select>
        <select id="filterGenre" aria-label="Thể loại"></select>
        <select id="filterCountry" aria-label="Quốc gia"></select>
        <select id="filterYear" aria-label="Năm"></select>
        <button class="btn" id="btnClear" type="button">Xoá lọc</button>
      </div>
    </div>

    <div class="grid" id="grid" aria-label="Danh sách phim"></div>

    <div class="footer">
      <button class="loadmore" id="loadMore" type="button">Tải thêm</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ================== SUPABASE ==================
    const SUPABASE_URL = "https://nzalaxolteaiafvuceqz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56YWxheG9sdGVhaWFmdnVjZXF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTY2MjAsImV4cCI6MjA4NTg3MjYyMH0.0eIz6cfB4Dr_g5Wja70tZCMvVfUKoI5H4D8MJBP49Bg";
    const supabase = window.supabase?.createClient
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    const el = {
      q: document.getElementById("q"),
      grid: document.getElementById("grid"),
      count: document.getElementById("count"),
      title: document.getElementById("pageTitle"),
      btnClear: document.getElementById("btnClear"),
      chipsKind: document.getElementById("chipsKind"),
      sort: document.getElementById("sort"),
      filterGenre: document.getElementById("filterGenre"),
      filterCountry: document.getElementById("filterCountry"),
      filterYear: document.getElementById("filterYear"),
      loadMore: document.getElementById("loadMore"),

      dropGenre: document.getElementById("dropGenre"),
      dropCountry: document.getElementById("dropCountry"),
      btnDropGenre: document.getElementById("btnDropGenre"),
      btnDropCountry: document.getElementById("btnDropCountry"),
      genreGrid: document.getElementById("genreGrid"),
      countryGrid: document.getElementById("countryGrid"),
      navMovie: document.getElementById("navMovie"),
      navSeries: document.getElementById("navSeries"),
    };

    const state = {
      tab: "all",
      kind: null,
      genre: "",
      country: "",
      year: "",
      q: "",
      sort: "new",
      page: 0,
      pageSize: 35,
      all: [],
      view: [],
    };

    function svgPlaceholder(title="Khoii • Poster", w=500, h=750){
      const safe = String(title).replace(/[<>&"]/g, "");
      const svg =
`<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">
  <defs>
    <linearGradient id="g" x1="0" x2="1">
      <stop offset="0" stop-color="#0b0f17"/>
      <stop offset="1" stop-color="#141a2a"/>
    </linearGradient>
    <radialGradient id="r" cx="30%" cy="25%" r="70%">
      <stop offset="0" stop-color="rgba(242,198,79,.28)"/>
      <stop offset="1" stop-color="rgba(0,0,0,0)"/>
    </radialGradient>
  </defs>
  <rect width="100%" height="100%" fill="url(#g)"/>
  <rect width="100%" height="100%" fill="url(#r)"/>
  <text x="6%" y="52%" fill="rgba(231,237,249,.92)" font-family="system-ui,Segoe UI,Roboto" font-size="44" font-weight="800">${safe}</text>
</svg>`;
      return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ✅ Gom phim bộ/anime theo tập -> 1 card đại diện (ep=1), updatedAt=max
    function collapseEpisodicRows(rows) {
      const out = [];
      const map = new Map();

      for (const r of (rows || [])) {
        const kind = r.kind || "anime";
        const episodic = (kind === "anime" || kind === "series");

        if (!episodic) {
          out.push({ ...r, openSeason: 1, openEp: 1 });
          continue;
        }

        const season = Number(r.season || 1) || 1;
        const title = String(r.title || "").trim();
        const key = `${kind}||${season}||${title}`.toLowerCase();

        let g = map.get(key);
        if (!g) {
          g = { kind, season, title, rows: [] };
          map.set(key, g);
        }
        g.rows.push(r);
      }

      for (const g of map.values()) {
        const arr = g.rows.slice();
        arr.sort((a, b) => (Number(a.ep || 0) - Number(b.ep || 0)) || (Number(a.updatedAt || 0) - Number(b.updatedAt || 0)));

        const rep = arr.find(x => Number(x.ep) === 1) || arr[0];

        const maxUpdated = Math.max(...arr.map(x => Number(x.updatedAt || 0) || 0));
        const maxEp = Math.max(...arr.map(x => Number(x.ep || 0) || 0));
        const totalEps = arr.reduce((m, x) => Math.max(m, Number(x.eps || 0) || 0), 0) || (rep.eps || null);

        const poster = arr.map(x => x.poster).find(Boolean) || rep.poster || "";
        out.push({
          ...rep,
          title: g.title,
          kind: g.kind,
          season: g.season,
          ep: (rep.ep ?? 1),
          eps: totalEps,
          poster,
          updatedAt: maxUpdated,
          openSeason: g.season,
          openEp: 1,
          _latestEp: maxEp,
        });
      }

      out.sort((a, b) => (Number(b.updatedAt || 0) - Number(a.updatedAt || 0)));
      return out;
    }

    function makeWatchHref(item){
      const kind = item.kind || "anime";
      const episodic = (kind === "anime" || kind === "series");
      if (episodic) {
        const season = Number(item.openSeason || item.season || 1) || 1;
        const ep = Number(item.openEp || 1) || 1;
        return `watch.html?title=${encodeURIComponent(item.title)}&season=${encodeURIComponent(season)}&ep=${encodeURIComponent(ep)}`;
      }
      return `watch.html?drive=${encodeURIComponent(item.driveId)}&title=${encodeURIComponent(item.title)}`;
    }

    function parseParams(){
      const u = new URL(location.href);
      state.tab = u.searchParams.get("tab") || "all";

      state.kind = u.searchParams.get("kind");
      state.genre = u.searchParams.get("genre") || "";
      state.country = u.searchParams.get("country") || "";
      state.year = u.searchParams.get("year") || "";

      const qParam = u.searchParams.get("q") || "";
      if(qParam) el.q.value = qParam;

      if(state.tab === "suggest") el.title.textContent = "Đề xuất hôm nay";
      else if(state.tab === "new") el.title.textContent = "Phim mới cập nhật";
      else if(state.tab === "anime") { el.title.textContent = "Anime nổi bật"; state.kind = state.kind || "anime"; }
      else el.title.textContent = "Danh sách phim";
    }

    async function loadAll(){
      if(!supabase){
        alert("Không tải được Supabase. Kiểm tra CDN hoặc mạng.");
        return;
      }
      const { data, error } = await supabase
        .from("movies")
        // ✅ thêm ep/eps/season + posterurl/herourl để gom đúng
        .select("id,title,kind,year,quality,desc,driveid,drivelink,posterurl,herourl,updatedat,genres,country,ep,eps,season")
        .order("updatedat", { ascending: false });

      if(error){
        console.warn(error);
        alert("Lỗi tải dữ liệu từ Supabase.");
        return;
      }

      const raw = (data || []).map(r => ({
        id: r.id,
        title: r.title || "Không tên",
        kind: r.kind || "anime",
        year: r.year || "",
        quality: r.quality || "FHD",
        desc: r.desc || "",
        driveId: r.driveid,
        poster: r.posterurl || (r.driveid ? `https://drive.google.com/thumbnail?id=${r.driveid}&sz=w600` : ""),
        genres: Array.isArray(r.genres) ? r.genres : [],
        country: r.country || "",
        updatedAt: Number(r.updatedat || 0),
        ep: (r.ep === null || r.ep === undefined) ? null : Number(r.ep),
        eps: (r.eps === null || r.eps === undefined) ? null : Number(r.eps),
        season: (r.season === null || r.season === undefined) ? null : Number(r.season),
        openSeason: Number(r.season || 1) || 1,
        openEp: 1,
      }));

      // ✅ gom phim bộ/anime thành 1 card
      state.all = collapseEpisodicRows(raw);
    }

    function getUniqueSets(){
      const gset = new Set();
      const cset = new Set();
      const yset = new Set();

      state.all.forEach(x=>{
        (x.genres||[]).forEach(g=>{ if(g) gset.add(String(g)); });
        if(x.country) cset.add(String(x.country));
        if(x.year) yset.add(String(x.year));
      });

      return { gset, cset, yset };
    }

    function buildDropdowns(){
      const { gset, cset, yset } = getUniqueSets();

      const genres = ["", ...[...gset].sort((a,b)=>a.localeCompare(b))];
      const countries = ["", ...[...cset].sort((a,b)=>a.localeCompare(b))];
      const years = ["", ...[...yset].sort((a,b)=>{
        const na = Number(a), nb = Number(b);
        if(!Number.isNaN(na) && !Number.isNaN(nb)) return nb - na;
        return b.localeCompare(a);
      })];

      el.filterGenre.innerHTML = genres.map(v=>`<option value="${escapeHtml(v)}">${v?escapeHtml(v):"Thể loại (tất cả)"}</option>`).join("");
      el.filterCountry.innerHTML = countries.map(v=>`<option value="${escapeHtml(v)}">${v?escapeHtml(v):"Quốc gia (tất cả)"}</option>`).join("");
      el.filterYear.innerHTML = years.map(v=>`<option value="${escapeHtml(v)}">${v?escapeHtml(v):"Năm (tất cả)"}</option>`).join("");

      el.filterGenre.value = state.genre;
      el.filterCountry.value = state.country;
      el.filterYear.value = state.year;

      buildHeaderMenus(genres.filter(Boolean), countries.filter(Boolean));
    }

    function buildKindChips(){
      const kinds = [
        { label:"Tất cả", value:null },
        { label:"Anime", value:"anime" },
        { label:"Phim Lẻ", value:"movie" },
        { label:"Phim Bộ", value:"series" },
      ];

      el.chipsKind.innerHTML = "";
      kinds.forEach(k=>{
        const b = document.createElement("button");
        b.type = "button";
        b.className = "chip" + ((state.kind===k.value) ? " on" : "");
        b.textContent = k.label;
        b.addEventListener("click", ()=>{
          state.kind = (state.kind===k.value) ? null : k.value;
          state.page = 0;
          apply();
        });
        el.chipsKind.appendChild(b);
      });
    }

    function buildHeaderMenus(genres, countries){
      el.genreGrid.innerHTML = [
        `<div class="drop-item"><a href="#" data-type="genre" data-value="" class="${state.genre ? "" : "on"}">Tất cả</a></div>`,
        ...genres.slice(0,60).map(g=>`<div class="drop-item"><a href="#" data-type="genre" data-value="${escapeHtml(g)}" class="${state.genre===g ? "on" : ""}">${escapeHtml(g)}</a></div>`)
      ].join("");

      el.countryGrid.innerHTML = [
        `<div class="drop-item"><a href="#" data-type="country" data-value="" class="${state.country ? "" : "on"}">Tất cả</a></div>`,
        ...countries.slice(0,80).map(c=>`<div class="drop-item"><a href="#" data-type="country" data-value="${escapeHtml(c)}" class="${state.country===c ? "on" : ""}">${escapeHtml(c)}</a></div>`)
      ].join("");

      updateNavActive();
    }

    function closeDrops(){
      el.dropGenre.classList.remove("open");
      el.dropCountry.classList.remove("open");
    }

    function toggleDrop(which){
      if(which === "genre"){
        el.dropCountry.classList.remove("open");
        el.dropGenre.classList.toggle("open");
      }else{
        el.dropGenre.classList.remove("open");
        el.dropCountry.classList.toggle("open");
      }
    }

    function updateNavActive(){
      el.navMovie.classList.toggle("active", state.kind === "movie");
      el.navSeries.classList.toggle("active", state.kind === "series");

      el.btnDropGenre.classList.toggle("active", !!state.genre);
      el.btnDropCountry.classList.toggle("active", !!state.country);
    }

    function syncDropActive(){
      el.genreGrid.querySelectorAll('a[data-type="genre"]').forEach(a=>{
        a.classList.toggle("on", (a.dataset.value || "") === (state.genre || ""));
      });
      el.countryGrid.querySelectorAll('a[data-type="country"]').forEach(a=>{
        a.classList.toggle("on", (a.dataset.value || "") === (state.country || ""));
      });
      updateNavActive();
    }

    function apply(){
      state.q = (el.q.value || "").trim().toLowerCase();
      state.sort = el.sort.value;

      let list = state.all.slice();

      if(state.tab === "anime") list = list.filter(x=>x.kind === "anime");
      if(state.tab === "new") list = list.slice().sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
      if(state.tab === "suggest") list = list;

      if(state.kind) list = list.filter(x=>x.kind === state.kind);
      if(state.genre) list = list.filter(x=>(x.genres||[]).map(s=>String(s).toLowerCase()).includes(String(state.genre).toLowerCase()));
      if(state.country) list = list.filter(x=>String(x.country||"").toLowerCase() === String(state.country).toLowerCase());
      if(state.year) list = list.filter(x=>String(x.year||"") === String(state.year));

      if(state.q){
        list = list.filter(x => (x.title||"").toLowerCase().includes(state.q));
      }

      if(state.sort === "new"){
        list.sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
      }else if(state.sort === "title"){
        list.sort((a,b)=>(a.title||"").localeCompare((b.title||""), "vi"));
      }else if(state.sort === "year"){
        list.sort((a,b)=>{
          const na = Number(a.year||0), nb = Number(b.year||0);
          if(!Number.isNaN(na) && !Number.isNaN(nb)) return nb - na;
          return String(b.year||"").localeCompare(String(a.year||""));
        });
      }

      state.view = list;
      el.count.textContent = String(list.length);

      el.grid.innerHTML = "";
      state.page = 0;
      renderNextPage();
      syncChipsUI();
      syncDropActive();
    }

    function syncChipsUI(){
      [...el.chipsKind.querySelectorAll(".chip")].forEach(ch=>{
        const t = ch.textContent;
        const map = { "Anime":"anime", "Phim Lẻ":"movie", "Phim Bộ":"series", "Tất cả":null };
        const v = map[t];
        ch.classList.toggle("on", state.kind === v);
      });
    }

    function renderNextPage(){
      const start = state.page * state.pageSize;
      const end = start + state.pageSize;
      const slice = state.view.slice(start, end);

      slice.forEach(item=>{
        const c = document.createElement("div");
        c.className = "card";
        c.innerHTML = `
          <div class="tag">${escapeHtml(item.kind === "movie" ? "Phim Lẻ" : item.kind === "series" ? "Phim Bộ" : "Anime")}</div>
          <div class="img"><img alt="" loading="lazy"></div>
          <div class="meta">
            <b>${escapeHtml(item.title)}</b>
            <small>${escapeHtml(item.year || "—")} • ${escapeHtml(item.quality || "FHD")} ${item.country ? "• " + escapeHtml(item.country) : ""}</small>
          </div>
        `;
        const img = c.querySelector("img");
        img.onerror = ()=>{ img.onerror=null; img.src = svgPlaceholder("Khoii • Poster", 500, 750); };
        img.src = item.poster || svgPlaceholder("Khoii • Poster", 500, 750);

        c.addEventListener("click", ()=>{
          if(!item.driveId){
            alert("Phim này chưa có Drive ID.");
            return;
          }
          location.href = makeWatchHref(item);
        });

        el.grid.appendChild(c);
      });

      state.page += 1;

      const hasMore = state.page * state.pageSize < state.view.length;
      el.loadMore.style.display = hasMore ? "inline-block" : "none";
    }

    // ===== events =====
    el.loadMore.addEventListener("click", renderNextPage);
    el.q.addEventListener("input", ()=> apply());
    el.sort.addEventListener("change", ()=> apply());

    el.filterGenre.addEventListener("change", ()=>{
      state.genre = el.filterGenre.value || "";
      apply();
    });
    el.filterCountry.addEventListener("change", ()=>{
      state.country = el.filterCountry.value || "";
      apply();
    });
    el.filterYear.addEventListener("change", ()=>{
      state.year = el.filterYear.value || "";
      apply();
    });

    el.btnClear.addEventListener("click", ()=>{
      state.kind = null;
      state.genre = "";
      state.country = "";
      state.year = "";
      el.q.value = "";
      el.sort.value = "new";
      buildKindChips();
      buildDropdowns();
      apply();
    });

    el.btnDropGenre.addEventListener("click", (ev)=>{ ev.preventDefault(); toggleDrop("genre"); });
    el.btnDropCountry.addEventListener("click", (ev)=>{ ev.preventDefault(); toggleDrop("country"); });

    el.navMovie.addEventListener("click", (ev)=>{
      ev.preventDefault();
      state.kind = (state.kind === "movie") ? null : "movie";
      apply();
    });
    el.navSeries.addEventListener("click", (ev)=>{
      ev.preventDefault();
      state.kind = (state.kind === "series") ? null : "series";
      apply();
    });

    document.querySelectorAll(".drop-close").forEach(btn=>{
      btn.addEventListener("click", (ev)=>{
        ev.preventDefault();
        closeDrops();
      });
    });

    el.genreGrid.addEventListener("click", (ev)=>{
      const a = ev.target.closest("a[data-type='genre']");
      if(!a) return;
      ev.preventDefault();
      state.genre = a.dataset.value || "";
      el.filterGenre.value = state.genre;
      apply();
      closeDrops();
    });
    el.countryGrid.addEventListener("click", (ev)=>{
      const a = ev.target.closest("a[data-type='country']");
      if(!a) return;
      ev.preventDefault();
      state.country = a.dataset.value || "";
      el.filterCountry.value = state.country;
      apply();
      closeDrops();
    });

    document.addEventListener("click", (ev)=>{
      const inside = ev.target.closest(".drop");
      if(!inside) closeDrops();
    });
    document.addEventListener("keydown", (ev)=>{
      if(ev.key === "Escape") closeDrops();
    });

    (async ()=>{
      parseParams();
      await loadAll();
      buildKindChips();
      buildDropdowns();

      el.sort.value = "new";
      if(state.tab === "new") el.sort.value = "new";
      apply();
    })();
  </script>
</body>
</html>
