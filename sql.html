<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>Admin Tool - Thêm/Xóa phim (Drive) + Xuất SQL</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{ color-scheme: dark; }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:#0b1220;
      color:#e8eefc;
    }
    header{
      padding:16px 18px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      gap:12px;
    }
    header a{ color:#9ec1ff; text-decoration:none; }
    header a:hover{ text-decoration:underline; }

    .wrap{ max-width:1100px; margin:0 auto; padding:16px; }
    .grid{ display:grid; gap:14px; grid-template-columns:1fr; }
    @media (min-width:980px){ .grid{ grid-template-columns:420px 1fr; } }

    .card{
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
    }

    h2{ margin:0 0 10px; font-size:16px; }
    label{ display:block; font-size:12px; opacity:.9; margin:10px 0 6px; }
    input, textarea, select{
      width:100%;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color:#e8eefc;
      border-radius:10px;
      padding:10px 10px;
      outline:none;
    }
    textarea{ min-height:84px; resize:vertical; }

    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }

    button{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(158,193,255,.14);
      color:#e8eefc;
      padding:10px 12px;
      border-radius:10px;
      font-weight:700;
    }
    button:hover{ background: rgba(158,193,255,.18); }
    button.secondary{ background: rgba(255,255,255,.06); }
    button.secondary:hover{ background: rgba(255,255,255,.09); }
    button.danger{
      background: rgba(255,124,124,.14);
      border-color: rgba(255,124,124,.35);
    }
    button.danger:hover{ background: rgba(255,124,124,.20); }
    button.tiny{ padding:7px 9px; border-radius:10px; font-size:12px; }
    button:disabled{ opacity:.5; cursor:not-allowed; }

    .muted{ opacity:.8; font-size:12px; line-height:1.4; }
    .ok{ color:#7CFFB2; }
    .err{ color:#ff8c8c; white-space:pre-wrap; }

    pre{
      margin:10px 0 0;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.10);
      border-radius:12px;
      padding:12px;
      overflow:auto;
      font-size:12px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-size:12px;
    }

    hr.sep{ border:0; border-top:1px solid rgba(255,255,255,.08); margin:14px 0; }

    .tableWrap{
      margin-top:10px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      overflow:auto;
      background: rgba(0,0,0,.18);
    }
    table{ width:100%; border-collapse:collapse; min-width:780px; }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-size:12px;
      white-space:nowrap;
      vertical-align:middle;
      text-align:left;
    }
    th{
      font-size:11px;
      opacity:.78;
      text-transform:uppercase;
      letter-spacing:.06em;
      background: rgba(255,255,255,.04);
      position: sticky;
      top:0;
      z-index:1;
    }
    tr:hover td{ background: rgba(255,255,255,.03); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .hint{
      margin-top:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .hint a{ color:#9ec1ff; text-decoration:none; }
    .hint a:hover{ text-decoration:underline; }
  </style>
</head>
<body>
  <header>
    <a href="index.html">← Về trang chủ</a>
    <span class="pill" id="statusPill">Chưa đăng nhập</span>
    <span class="muted" style="margin-left:auto">Tool: Thêm/Xóa phim (Drive) + Xuất SQL</span>
  </header>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT: AUTH + SQL SETUP -->
      <div class="card">
        <h2>Đăng nhập Supabase (bắt buộc để insert/delete do RLS)</h2>
        <label>Email</label>
        <input id="email" type="email" placeholder="email" autocomplete="username" />
        <label>Mật khẩu</label>
        <input id="password" type="password" placeholder="password" autocomplete="current-password" />
        <div class="row" style="margin-top:12px">
          <button id="btnLogin">Đăng nhập</button>
          <button class="secondary" id="btnLogout" disabled>Đăng xuất</button>
        </div>
        <div id="authMsg" class="muted" style="margin-top:10px"></div>

        <hr class="sep" />

        <h2>Quên mật khẩu</h2>
        <div class="muted">
          Nhập <b>Email</b> ở trên rồi bấm “Gửi link reset”. Supabase sẽ gửi email để bạn đặt lại mật khẩu.
          <br>
          <span class="muted">(Lưu ý: trong Supabase → Auth → URL Configuration, hãy add URL của <b>sql.html</b> vào danh sách Redirect URLs.)</span>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="secondary" id="btnForgot">Gửi link reset</button>
          <button class="secondary" id="btnShowRecovery" title="Chỉ dùng khi bạn đã mở link reset trong email" style="display:none">Đặt lại mật khẩu</button>
        </div>
        <div id="forgotMsg" class="muted" style="margin-top:10px"></div>

        <!-- Password recovery UI: sẽ tự hiện khi mở link reset từ email -->
        <div id="recoveryBox" style="display:none; margin-top:12px" class="hint">
          <b>Đặt lại mật khẩu</b>
          <div class="muted" style="margin-top:6px">Nhập mật khẩu mới (tối thiểu 6 ký tự) rồi bấm “Cập nhật”.</div>
          <label>Mật khẩu mới</label>
          <input id="newPass" type="password" placeholder="Nhập mật khẩu mới" autocomplete="new-password" />
          <label>Nhập lại mật khẩu mới</label>
          <input id="newPass2" type="password" placeholder="Nhập lại mật khẩu" autocomplete="new-password" />
          <div class="row" style="margin-top:10px">
            <button id="btnUpdatePass">Cập nhật mật khẩu</button>
            <button class="secondary" id="btnCancelRecovery" type="button">Hủy</button>
          </div>
          <div id="recoveryMsg" class="muted" style="margin-top:10px"></div>
        </div>

        <hr class="sep" />

        <h2>SQL Setup (tham khảo)</h2>
        <div class="muted">Copy các block: tạo bảng + policy + index.</div>
        <div style="display:flex; gap:10px; margin-top:10px">
          <button class="secondary" id="copySetup">Copy SQL Setup</button>
        </div>
        <pre id="sqlSetup"></pre>

        <hr class="sep" />

        <h2>Tips Google Drive</h2>
        <div class="muted">
          • Video/ảnh trong Drive nên để <b>Anyone with the link</b> để xem được.<br>
          • Bạn có thể dán link Drive vào <b>Drive link / Poster URL / Hero URL</b>, tool sẽ tự tách ID và tự tạo thumbnail.
        </div>
      </div>

      <!-- RIGHT: ADD + DELETE + LIST -->
      <div class="card">
        <h2>Thêm phim</h2>

        <div class="row">
          <div>
            <label>Title *</label>
            <input id="title" placeholder="VD: One Piece" />
          </div>
          <div>
            <label>Kind</label>
            <select id="kind">
              <option value="anime">anime</option>
              <option value="movie">movie</option>
              <option value="series">series</option>
              <option value="suggest">suggest</option>
              <option value="new">new</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Year</label>
            <input id="year" placeholder="2026" />
          </div>
          <div>
            <label>Quality</label>
            <input id="quality" placeholder="FHD" value="FHD" />
          </div>
        </div>

        <label>Description</label>
        <textarea id="desc" placeholder="Mô tả..."></textarea>

        <div class="row">
          <div>
            <label>Drive ID (Video) *</label>
            <input id="driveid" placeholder="Có thể dán ID hoặc dán link Drive video" />
          </div>
          <div>
            <label>Drive link (Video)</label>
            <input id="drivelink" placeholder="https://drive.google.com/..." />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Poster URL (có thể dán link/ID Drive ảnh)</label>
            <input id="posterurl" placeholder="https://... hoặc link Drive ảnh" />
          </div>
          <div>
            <label>Hero URL (có thể dán link/ID Drive ảnh)</label>
            <input id="herourl" placeholder="https://... hoặc link Drive ảnh" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Genres (cách nhau bằng dấu phẩy)</label>
            <input id="genres" placeholder="Action, Adventure, Comedy" />
          </div>
          <div>
            <label>Country</label>
            <input id="country" placeholder="JP / VN / US ..." />
          </div>
        </div>

        <div class="row">
          <div>
            <label>updatedat (epoch ms, để trống = tự set)</label>
            <input id="updatedat" placeholder="VD: 1760000000000" />
          </div>
          <div style="display:flex; align-items:flex-end; gap:10px">
            <button class="secondary" id="btnAutoDrive" title="Tự tách ID + tự tạo thumbnail cho poster/hero">Auto Drive</button>
            <button id="btnAdd" disabled>Thêm phim (Lưu + Xuất SQL)</button>
            <button class="secondary" id="btnClear">Xoá form</button>
          </div>
        </div>

        <div class="hint muted" id="driveHint">
          Video Preview: <span class="mono">—</span><br>
          Poster: <span class="mono">—</span><br>
          Hero: <span class="mono">—</span>
        </div>

        <div id="saveMsg" class="muted" style="margin-top:10px"></div>

        <h2 style="margin-top:14px">SQL INSERT được tạo ra</h2>
        <div class="muted">Sau khi bấm “Thêm phim”, tool sẽ tạo INSERT và đồng thời insert vào Supabase.</div>
        <div style="display:flex; gap:10px; margin-top:10px">
          <button class="secondary" id="copyInsert" disabled>Copy SQL INSERT</button>
        </div>
        <pre id="sqlInsert"></pre>

        <hr class="sep" />

        <h2>Xóa phim</h2>
        <div class="muted">
          Nhập <b>Drive ID / link Drive</b> hoặc <b>ID (uuid)</b> để xóa record phim trong Supabase.
        </div>

        <div class="row">
          <div>
            <label>Drive ID / Link Drive / UUID *</label>
            <input id="delKey" placeholder="VD: 1AbC... hoặc https://drive.google.com/... hoặc uuid" />
          </div>
          <div>
            <label>Kiểu khóa</label>
            <select id="delType">
              <option value="driveid">driveid</option>
              <option value="id">id (uuid)</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="danger" id="btnDelete" disabled>Xóa phim</button>
          <button class="secondary" id="btnLoadList">Load danh sách</button>
          <button class="secondary" id="btnClearDel">Xóa ô nhập</button>
        </div>
        <div id="delMsg" class="muted" style="margin-top:10px"></div>

        <h2 style="margin-top:14px">Danh sách phim (mới nhất)</h2>
        <div class="row">
          <div>
            <label>Tìm kiếm nhanh (title / driveid / kind / year)</label>
            <input id="qManage" placeholder="VD: one piece" />
          </div>
          <div>
            <label>Limit</label>
            <select id="listLimit">
              <option value="20">20</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
              <option value="200">200</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="secondary" id="btnRefreshList">Refresh</button>
          <button class="secondary" id="btnClearFilter">Clear filter</button>
        </div>
        <div id="listMsg" class="muted" style="margin-top:10px"></div>
        <div class="tableWrap">
          <table id="tblMovies" aria-label="Danh sách phim"></table>
        </div>
        <div class="muted" style="margin-top:8px">Tip: bấm “Xóa” ở cuối dòng để xóa nhanh.</div>
      </div>
    </div>
  </div>

<script>
  // ================== SUPABASE ==================
  const SUPABASE_URL = "https://nzalaxolteaiafvuceqz.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56YWxheG9sdGVhaWFmdnVjZXF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTY2MjAsImV4cCI6MjA4NTg3MjYyMH0.0eIz6cfB4Dr_g5Wja70tZCMvVfUKoI5H4D8MJBP49Bg";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ================== SQL blocks (setup) ==================
  const SQL_SETUP = `create table if not exists public.movies (
  id uuid primary key default gen_random_uuid(),
  title text not null,
  kind text default 'anime',
  year text,
  quality text default 'FHD',
  "desc" text,
  driveid text not null unique,
  drivelink text,
  posterurl text,
  herourl text,
  updatedat bigint,
  created_at timestamptz default now()
);

alter table public.movies enable row level security;

drop policy if exists "public read movies" on public.movies;
create policy "public read movies"
on public.movies for select
to anon, authenticated
using (true);

drop policy if exists "admin write movies" on public.movies;
create policy "admin write movies"
on public.movies for insert
to authenticated
with check (auth.uid() = 'e812c719-d30e-4498-8807-50e9480853ef');

drop policy if exists "admin update movies" on public.movies;
create policy "admin update movies"
on public.movies for update
to authenticated
using (auth.uid() = 'e812c719-d30e-4498-8807-50e9480853ef')
with check (auth.uid() = 'e812c719-d30e-4498-8807-50e9480853ef');

drop policy if exists "admin delete movies" on public.movies;
create policy "admin delete movies"
on public.movies for delete
to authenticated
using (auth.uid() = 'e812c719-d30e-4498-8807-50e9480853ef');

-- 1) Add columns (safe)
alter table public.movies
  add column if not exists genres text[] not null default '{}'::text[],
  add column if not exists country text;

-- 2) Optional: indexes for faster filter/search
create index if not exists movies_kind_idx on public.movies (kind);
create index if not exists movies_year_idx on public.movies (year);
create index if not exists movies_country_idx on public.movies (country);

-- 3) Optional: GIN index for array genres (fast "contains" queries)
create index if not exists movies_genres_gin_idx on public.movies using gin (genres);`;

  // ================== Drive tool (giống logic ở watch.html / index.html) ==================
  const DriveTool = (() => {
    const patterns = [
      /drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]{10,})/i,
      /drive\.google\.com\/open\?id=([a-zA-Z0-9_-]{10,})/i,
      /drive\.google\.com\/uc\?id=([a-zA-Z0-9_-]{10,})/i,
      /drive\.google\.com\/uc\?export=download&id=([a-zA-Z0-9_-]{10,})/i,
      /drive\.google\.com\/thumbnail\?id=([a-zA-Z0-9_-]{10,})/i,
    ];
    function extractId(input){
      const s = String(input || "").trim();
      if(!s) return null;
      if (/^[a-zA-Z0-9_-]{10,}$/.test(s)) return s;
      try{
        const u = new URL(s);
        const qid = u.searchParams.get("id");
        if(qid && /^[a-zA-Z0-9_-]{10,}$/.test(qid)) return qid;
      }catch{}
      for(const re of patterns){
        const m = s.match(re);
        if(m && m[1]) return m[1];
      }
      return null;
    }
    function thumb(id, w=800){ return `https://drive.google.com/thumbnail?id=${id}&sz=w${w}`; }
    function links(id){
      return {
        id,
        preview: `https://drive.google.com/file/d/${id}/preview`,
        view: `https://drive.google.com/file/d/${id}/view`,
      };
    }
    return { extractId, thumb, links };
  })();

  // ================== Helpers ==================
  const $ = (id) => document.getElementById(id);

  const state = {
    authed: false,
    movies: [],
    lastLoad: 0
  };

  function setPill(text, ok=false) {
    const p = $("statusPill");
    p.textContent = text;
    p.style.borderColor = ok ? "rgba(124,255,178,.45)" : "rgba(255,255,255,.10)";
    p.style.background = ok ? "rgba(124,255,178,.12)" : "rgba(255,255,255,.06)";
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  // dùng cho attribute (data-*)
  function escapeAttr(s){
    return escapeHtml(s).replaceAll("`","&#96;");
  }

  function fmtMs(ms){
    const n = Number(ms);
    if(!Number.isFinite(n) || n <= 0) return "—";
    try{ return new Date(n).toLocaleString("vi-VN"); }
    catch{ return String(n); }
  }

  function escSqlString(s) {
    return String(s).replace(/'/g, "''");
  }

  function toSqlValue(v) {
    if (v === null || v === undefined || v === "") return "NULL";
    return "'" + escSqlString(v) + "'";
  }

  function toSqlTextArray(arr) {
    if (!arr || !arr.length) return "'{}'::text[]";
    const items = arr.map(x => "'" + escSqlString(x) + "'");
    return "ARRAY[" + items.join(", ") + "]::text[]";
  }

  function nowMs() { return Date.now(); }

  function parseGenres(raw) {
    return (raw || "").split(",").map(s => s.trim()).filter(Boolean);
  }

  // ✅ Auto: tách ID từ link Drive + tự tạo thumbnail poster/hero
  function normalizeDriveFields({ writeBack=true } = {}){
    const rawDriveId = $("driveid").value.trim();
    const rawDriveLink = $("drivelink").value.trim();
    const rawPoster = $("posterurl").value.trim();
    const rawHero = $("herourl").value.trim();

    const videoId = DriveTool.extractId(rawDriveId) || DriveTool.extractId(rawDriveLink) || null;

    // drivelink: nếu trống mà có id => auto set link view
    let fixedDriveLink = rawDriveLink;
    if(videoId && !fixedDriveLink){
      fixedDriveLink = DriveTool.links(videoId).view;
    }

    // poster: nếu user dán link/ID Drive => convert thumbnail; nếu trống => dùng thumb từ videoId
    let fixedPoster = rawPoster;
    const posterId = DriveTool.extractId(rawPoster);
    if(posterId){
      fixedPoster = DriveTool.thumb(posterId, 800);
    }else if(!fixedPoster && videoId){
      fixedPoster = DriveTool.thumb(videoId, 600);
    }

    // hero: nếu user dán link/ID Drive => convert thumbnail; nếu trống => dùng thumb từ videoId
    let fixedHero = rawHero;
    const heroId = DriveTool.extractId(rawHero);
    if(heroId){
      fixedHero = DriveTool.thumb(heroId, 1600);
    }else if(!fixedHero && videoId){
      fixedHero = DriveTool.thumb(videoId, 1400);
    }

    if(writeBack){
      if(videoId) $("driveid").value = videoId;
      if(fixedDriveLink) $("drivelink").value = fixedDriveLink;
      if(fixedPoster) $("posterurl").value = fixedPoster;
      if(fixedHero) $("herourl").value = fixedHero;
    }

    return {
      videoId,
      driveLink: fixedDriveLink || null,
      posterUrl: fixedPoster || null,
      heroUrl: fixedHero || null,
      links: videoId ? DriveTool.links(videoId) : null
    };
  }

  function updateDriveHint(){
    const r = normalizeDriveFields({ writeBack:false });
    const h = $("driveHint");
    const p = r.posterUrl ? `<a target="_blank" rel="noreferrer" href="${escapeAttr(r.posterUrl)}">${escapeHtml(r.posterUrl)}</a>` : "<span class='mono'>—</span>";
    const he = r.heroUrl ? `<a target="_blank" rel="noreferrer" href="${escapeAttr(r.heroUrl)}">${escapeHtml(r.heroUrl)}</a>` : "<span class='mono'>—</span>";
    const v = (r.links?.preview) ? `<a target="_blank" rel="noreferrer" href="${escapeAttr(r.links.preview)}">${escapeHtml(r.links.preview)}</a>` : "<span class='mono'>—</span>";
    h.innerHTML = `Video Preview: ${v}<br>Poster: ${p}<br>Hero: ${he}`;
  }

  function buildMovieFromForm() {
    // normalize first (but do not force writeBack if user doesn't want; we DO write to keep clean)
    const norm = normalizeDriveFields({ writeBack:true });

    const title = $("title").value.trim();
    const kind = $("kind").value.trim() || "anime";
    const year = $("year").value.trim();
    const quality = $("quality").value.trim() || "FHD";
    const desc = $("desc").value.trim();

    const driveid = $("driveid").value.trim();     // after normalize => should be id
    const drivelink = $("drivelink").value.trim(); // after normalize => optional view link
    const posterurl = $("posterurl").value.trim(); // after normalize => url thumb or external
    const herourl = $("herourl").value.trim();     // after normalize => url thumb or external

    const genres = parseGenres($("genres").value);
    const country = $("country").value.trim();
    const updatedatRaw = $("updatedat").value.trim();
    const updatedat = updatedatRaw ? Number(updatedatRaw) : nowMs();

    if (!title) throw new Error("Thiếu title.");
    if (!driveid) throw new Error("Thiếu driveid (video). Bạn có thể dán link Drive vào Drive link rồi bấm Auto Drive.");

    return {
      title,
      kind,
      year: year || null,
      quality,
      desc: desc || null,
      driveid,
      drivelink: drivelink || null,
      posterurl: posterurl || null,
      herourl: herourl || null,
      updatedat: Number.isFinite(updatedat) ? updatedat : nowMs(),
      genres,
      country: country || null
    };
  }

  function makeInsertSql(m) {
    const cols = ["title","kind","year","quality","desc","driveid","drivelink","posterurl","herourl","updatedat","genres","country"];
    const vals = [
      toSqlValue(m.title),
      toSqlValue(m.kind),
      m.year ? toSqlValue(m.year) : "NULL",
      toSqlValue(m.quality),
      m.desc ? toSqlValue(m.desc) : "NULL",
      toSqlValue(m.driveid),
      m.drivelink ? toSqlValue(m.drivelink) : "NULL",
      m.posterurl ? toSqlValue(m.posterurl) : "NULL",
      m.herourl ? toSqlValue(m.herourl) : "NULL",
      String(m.updatedat),
      toSqlTextArray(m.genres),
      m.country ? toSqlValue(m.country) : "NULL"
    ];
    return "insert into public.movies (" + cols.join(", ") + ")\nvalues (" + vals.join(", ") + ");";
  }

  // ================== Auth ==================
  async function refreshAuthUI() {
    const { data } = await sb.auth.getSession();
    const session = data?.session;
    state.authed = !!session?.user;

    if (state.authed) {
      setPill("Đã đăng nhập: " + session.user.email, true);
      $("btnLogin").disabled = true;
      $("btnLogout").disabled = false;
      $("btnAdd").disabled = false;
      $("btnDelete").disabled = false;
      $("authMsg").innerHTML = '<span class="ok">OK</span> - Có thể thêm/xóa phim.';
    } else {
      setPill("Chưa đăng nhập");
      $("btnLogin").disabled = false;
      $("btnLogout").disabled = true;
      $("btnAdd").disabled = true;
      $("btnDelete").disabled = true;
      $("authMsg").textContent = "Hãy đăng nhập để insert/delete (policy chỉ cho authenticated admin).";
    }

    // cập nhật nút xóa trong bảng
    renderMovies();
  }

  async function login() {
    $("authMsg").textContent = "Đang đăng nhập...";
    const email = $("email").value.trim();
    const password = $("password").value;
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if (error) {
      $("authMsg").innerHTML = '<span class="err">' + escapeHtml(error.message) + '</span>';
      return;
    }
    $("authMsg").innerHTML = '<span class="ok">Đăng nhập thành công.</span>';
    await refreshAuthUI();
  }

  async function logout() {
    await sb.auth.signOut();
    await refreshAuthUI();
  }

  // ================== Forgot / Recovery password ==================
  function getRedirectTo(){
    // URL để Supabase redirect sau khi user bấm link reset trong email
    // (cần add vào Supabase Auth → URL Configuration)
    try{
      const u = new URL(location.href);
      u.hash = "";
      // giữ nguyên path hiện tại
      return u.toString();
    }catch{
      return String(location.href || "").split("#")[0];
    }
  }

  function hasRecoveryInUrl(){
    try{
      const h = new URLSearchParams((location.hash || "").replace(/^#/, ""));
      const s = new URLSearchParams(location.search || "");
      return (h.get("type") === "recovery") || (s.get("type") === "recovery");
    }catch{
      return false;
    }
  }

  function showRecoveryUI(){
    const box = $("recoveryBox");
    if(!box) return;
    box.style.display = "block";
    const btn = $("btnShowRecovery");
    if(btn) btn.style.display = "none";
    $("recoveryMsg").textContent = "";
    // focus cho tiện
    setTimeout(()=>{ try{ $("newPass")?.focus(); }catch{} }, 50);
  }

  function hideRecoveryUI(){
    const box = $("recoveryBox");
    if(!box) return;
    box.style.display = "none";
    $("recoveryMsg").textContent = "";
    $("newPass").value = "";
    $("newPass2").value = "";
  }

  async function sendResetEmail(){
    const email = $("email").value.trim();
    if(!email){
      $("forgotMsg").innerHTML = '<span class="err">Bạn cần nhập Email trước.</span>';
      return;
    }
    $("forgotMsg").textContent = "Đang gửi email reset...";

    const redirectTo = getRedirectTo();
    const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });
    if(error){
      $("forgotMsg").innerHTML = '<span class="err">' + escapeHtml(error.message) + '</span>';
      return;
    }

    $("forgotMsg").innerHTML = '<span class="ok">Đã gửi link reset vào email.</span> Hãy mở email và bấm link để đặt lại mật khẩu.';
    // show button thủ công (phòng trường hợp event không trigger do browser)
    const btn = $("btnShowRecovery");
    if(btn) btn.style.display = "inline-block";
  }

  async function updatePassword(){
    const p1 = $("newPass").value;
    const p2 = $("newPass2").value;

    if(!p1 || p1.length < 6){
      $("recoveryMsg").innerHTML = '<span class="err">Mật khẩu mới phải tối thiểu 6 ký tự.</span>';
      return;
    }
    if(p1 !== p2){
      $("recoveryMsg").innerHTML = '<span class="err">Mật khẩu nhập lại không khớp.</span>';
      return;
    }

    $("recoveryMsg").textContent = "Đang cập nhật mật khẩu...";
    const { error } = await sb.auth.updateUser({ password: p1 });
    if(error){
      $("recoveryMsg").innerHTML = '<span class="err">' + escapeHtml(error.message) + '</span>';
      return;
    }

    $("recoveryMsg").innerHTML = '<span class="ok">Đã đổi mật khẩu thành công.</span> Bạn có thể dùng mật khẩu mới để đăng nhập.';

    // clear token trên URL (tránh lộ/khỏi bị lặp)
    try{ history.replaceState(null, "", String(location.href || "").split("#")[0]); }catch{}

    // refresh trạng thái auth
    await refreshAuthUI();
  }

  function copyText(t) {
    return navigator.clipboard.writeText(t);
  }

  // ================== Add Movie ==================
  async function addMovie() {
    $("saveMsg").textContent = "";
    $("sqlInsert").textContent = "";
    $("copyInsert").disabled = true;

    let movie;
    try {
      movie = buildMovieFromForm();
    } catch (e) {
      $("saveMsg").innerHTML = '<span class="err">' + escapeHtml(e.message) + '</span>';
      return;
    }

    // 1) Generate SQL
    const sql = makeInsertSql(movie);
    $("sqlInsert").textContent = sql;
    $("copyInsert").disabled = false;

    // 2) Save to Supabase
    $("btnAdd").disabled = true;
    $("saveMsg").textContent = "Đang lưu Supabase...";

    const dbRow = {
      title: movie.title,
      kind: movie.kind,
      year: movie.year,
      quality: movie.quality,
      desc: movie.desc,
      driveid: movie.driveid,
      drivelink: movie.drivelink,
      posterurl: movie.posterurl,
      herourl: movie.herourl,
      updatedat: movie.updatedat,
      genres: movie.genres,
      country: movie.country
    };

    const { data, error } = await sb.from("movies").insert(dbRow).select("id, title, driveid").maybeSingle();
    if (error) {
      $("saveMsg").innerHTML =
        '<div class="err">Lưu Supabase thất bại:\n' + escapeHtml(error.message) +
        (error.details ? ("\n" + escapeHtml(error.details)) : "") +
        (error.hint ? ("\nHint: " + escapeHtml(error.hint)) : "") + '</div>';
      $("btnAdd").disabled = false;
      return;
    }

    $("saveMsg").innerHTML = '<span class="ok">Đã lưu Supabase.</span> id=' + escapeHtml(data?.id || "(n/a)");
    $("btnAdd").disabled = false;

    // refresh list (nếu user đang mở)
    await loadMoviesList(false);
  }

  function clearForm() {
    ["title","year","desc","driveid","drivelink","posterurl","herourl","genres","country","updatedat"].forEach(id => $(id).value = "");
    $("quality").value = "FHD";
    $("kind").value = "anime";
    $("saveMsg").textContent = "";
    $("sqlInsert").textContent = "";
    $("copyInsert").disabled = true;
    updateDriveHint();
  }

  // ================== Delete Movie ==================
  async function deleteMovieBy(type, key){
    const cleanType = (type === "id") ? "id" : "driveid";
    const raw = String(key || "").trim();

    if(!raw){
      $("delMsg").innerHTML = '<span class="err">Thiếu khóa để xóa.</span>';
      return;
    }

    if(!state.authed){
      $("delMsg").innerHTML = '<span class="err">Cần đăng nhập để xóa.</span>';
      return;
    }

    let finalKey = raw;
    if(cleanType === "driveid"){
      finalKey = DriveTool.extractId(raw) || raw;
    }

    const msg = cleanType === "driveid"
      ? `Xóa phim có driveid = ${finalKey}?\nHành động KHÔNG thể hoàn tác.`
      : `Xóa phim có id = ${finalKey}?\nHành động KHÔNG thể hoàn tác.`;

    if(!confirm(msg)) return;

    $("btnDelete").disabled = true;
    $("delMsg").textContent = "Đang xóa...";

    let q = sb.from("movies").delete();
    q = (cleanType === "driveid") ? q.eq("driveid", finalKey) : q.eq("id", finalKey);

    // trả về row đã xóa để show thông tin
    const { data, error } = await q.select("id, title, driveid");

    if (error) {
      $("delMsg").innerHTML = '<div class="err">Xóa thất bại:\n' + escapeHtml(error.message) +
        (error.details ? ("\n" + escapeHtml(error.details)) : "") +
        (error.hint ? ("\nHint: " + escapeHtml(error.hint)) : "") + '</div>';
      $("btnDelete").disabled = false;
      return;
    }

    if(!data || !data.length){
      $("delMsg").innerHTML = '<span class="err">Không tìm thấy phim để xóa (hoặc đã bị xóa trước đó).</span>';
      $("btnDelete").disabled = false;
      return;
    }

    const it = data[0];
    $("delMsg").innerHTML = '<span class="ok">Đã xóa:</span> ' +
      escapeHtml(it.title || "(no title)") +
      ' <span class="muted">(' + escapeHtml(it.driveid || it.id || "") + ')</span>';

    $("btnDelete").disabled = false;

    // refresh list
    await loadMoviesList(false);
  }

  async function deleteFromInput(){
    const type = $("delType").value;
    const key = $("delKey").value;
    await deleteMovieBy(type, key);
  }

  // ================== List / Manage ==================
  function renderMovies(){
    const tbl = $("tblMovies");
    if(!tbl) return;

    const q = String($("qManage")?.value || "").trim().toLowerCase();
    let items = Array.isArray(state.movies) ? state.movies.slice() : [];

    if(q){
      items = items.filter(m => {
        const t = String(m.title || "").toLowerCase();
        const d = String(m.driveid || "").toLowerCase();
        const k = String(m.kind || "").toLowerCase();
        const y = String(m.year || "").toLowerCase();
        return t.includes(q) || d.includes(q) || k.includes(q) || y.includes(q);
      });
    }

    if(!state.movies.length){
      tbl.innerHTML = '<tr><td class="muted">Chưa tải danh sách. Bấm “Load danh sách”.</td></tr>';
      return;
    }

    if(!items.length){
      tbl.innerHTML = '<tr><td class="muted">Không có kết quả.</td></tr>';
      return;
    }

    const header = `
      <thead>
        <tr>
          <th>Title</th>
          <th>Kind</th>
          <th>Year</th>
          <th>Quality</th>
          <th class="mono">DriveID</th>
          <th>Updated</th>
          <th></th>
        </tr>
      </thead>`;

    const rows = items.map(m => {
      const title = escapeHtml(m.title || "");
      const kind = escapeHtml(m.kind || "");
      const year = escapeHtml(m.year || "");
      const quality = escapeHtml(m.quality || "");
      const driveid = escapeHtml(m.driveid || "");
      const updated = escapeHtml(fmtMs(m.updatedat));
      const disabled = state.authed ? "" : "disabled";
      return `
        <tr>
          <td title="${title}">${title}</td>
          <td>${kind}</td>
          <td>${year || "—"}</td>
          <td>${quality || "—"}</td>
          <td class="mono" title="${driveid}">${driveid}</td>
          <td>${updated}</td>
          <td style="text-align:right">
            <button class="danger tiny" data-action="del" data-driveid="${escapeAttr(m.driveid || "")}" data-id="${escapeAttr(m.id || "")}" ${disabled}>Xóa</button>
          </td>
        </tr>`;
    }).join("");

    tbl.innerHTML = header + `<tbody>${rows}</tbody>`;
  }

  async function loadMoviesList(showToast=true){
    const limit = Number($("listLimit")?.value || 50);
    $("listMsg").textContent = "Đang tải danh sách...";

    const { data, error } = await sb
      .from("movies")
      .select("id, title, driveid, kind, year, quality, updatedat")
      .order("updatedat", { ascending:false })
      .limit(Number.isFinite(limit) ? limit : 50);

    if(error){
      $("listMsg").innerHTML = '<span class="err">Tải danh sách thất bại: ' + escapeHtml(error.message) + '</span>';
      state.movies = [];
      renderMovies();
      return;
    }

    state.movies = Array.isArray(data) ? data : [];
    state.lastLoad = Date.now();

    if(showToast){
      $("listMsg").innerHTML = '<span class="ok">Đã tải ' + state.movies.length + ' phim.</span>';
    } else {
      $("listMsg").innerHTML = '<span class="ok">Danh sách đã được cập nhật (' + state.movies.length + ').</span>';
    }

    renderMovies();
  }

  // ================== Wire up ==================
  $("sqlSetup").textContent = SQL_SETUP;

  $("btnLogin").addEventListener("click", login);
  $("btnLogout").addEventListener("click", logout);

  $("btnForgot").addEventListener("click", sendResetEmail);
  $("btnShowRecovery").addEventListener("click", showRecoveryUI);
  $("btnUpdatePass").addEventListener("click", updatePassword);
  $("btnCancelRecovery").addEventListener("click", hideRecoveryUI);

  $("btnAdd").addEventListener("click", addMovie);
  $("btnClear").addEventListener("click", clearForm);

  $("copySetup").addEventListener("click", async () => {
    await copyText(SQL_SETUP);
    $("authMsg").innerHTML = '<span class="ok">Đã copy SQL Setup.</span>';
    setTimeout(() => refreshAuthUI(), 900);
  });

  $("copyInsert").addEventListener("click", async () => {
    const t = $("sqlInsert").textContent || "";
    if (!t.trim()) return;
    await copyText(t);
    $("saveMsg").innerHTML = '<span class="ok">Đã copy SQL INSERT.</span>';
  });

  $("btnAutoDrive").addEventListener("click", () => {
    const r = normalizeDriveFields({ writeBack:true });
    updateDriveHint();
    if(r.videoId){
      $("saveMsg").innerHTML = '<span class="ok">Auto Drive:</span> đã tách ID và tự tạo thumbnail (nếu cần).';
    }else{
      $("saveMsg").innerHTML = '<span class="err">Auto Drive:</span> không tách được Drive ID. Kiểm tra link/ID.';
    }
  });

  // auto update hint when typing
  ["driveid","drivelink","posterurl","herourl"].forEach(id=>{
    $(id).addEventListener("input", updateDriveHint);
    $(id).addEventListener("blur", ()=>{ normalizeDriveFields({ writeBack:true }); updateDriveHint(); });
  });

  $("btnDelete").addEventListener("click", deleteFromInput);
  $("btnLoadList").addEventListener("click", () => loadMoviesList(true));
  $("btnRefreshList").addEventListener("click", () => loadMoviesList(true));

  $("btnClearDel").addEventListener("click", () => {
    $("delKey").value = "";
    $("delMsg").textContent = "";
  });

  $("btnClearFilter").addEventListener("click", () => {
    $("qManage").value = "";
    renderMovies();
  });

  $("qManage").addEventListener("input", () => renderMovies());

  // click delete inside table
  $("tblMovies").addEventListener("click", async (e) => {
    const btn = e.target?.closest?.("button[data-action='del']");
    if(!btn) return;

    const driveid = btn.getAttribute("data-driveid") || "";
    const id = btn.getAttribute("data-id") || "";

    // ưu tiên xóa theo driveid
    $("delType").value = driveid ? "driveid" : "id";
    $("delKey").value = driveid || id;

    await deleteMovieBy($("delType").value, $("delKey").value);
  });

  // keep auth UI updated + bắt sự kiện password recovery
  sb.auth.onAuthStateChange((event) => {
    refreshAuthUI();
    if(event === "PASSWORD_RECOVERY"){
      // Khi user mở link reset từ email
      showRecoveryUI();
    }
  });

  // init
  refreshAuthUI();
  updateDriveHint();
  // load list once on start (public read policy cho phép)
  loadMoviesList(true);

  // Nếu URL đang ở chế độ recovery (mở link từ email) thì hiện UI đặt lại mật khẩu
  if(hasRecoveryInUrl()){
    showRecoveryUI();
  }
</script>
</body>
</html>
