<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SQL Helper</title>
  <style>
    :root{
      --bg:#0b0e14;
      --line:#1f2937;
      --muted:#9ca3af;
      --good:#7cffb2;
      --bad:#ff7c7c;
      --accent:#9ec1ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(180deg, #070a10 0%, #0b0e14 25%, #06080d 100%);
      color:#e5e7eb;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:10px 0 18px;border-bottom:1px solid var(--line)}
    h1{font-size:18px;margin:0}
    .pill{
      padding:8px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);color:#e5e7eb;
      font-size:13px;cursor:pointer;font-weight:600;text-decoration:none;
    }
    .grid{display:grid;grid-template-columns: 1fr 1fr;gap:12px;margin-top:14px}
    @media (max-width: 860px){ .grid{grid-template-columns:1fr;} }
    .card{
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.25);
      border-radius:18px;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .card h2{margin:0;padding:14px 14px 0;font-size:14px}
    .card p{margin:8px 14px 0;color:var(--muted);font-size:12px;line-height:1.4}
    textarea{
      width:100%;
      min-height:260px;
      background:rgba(255,255,255,.04);
      border:none;
      outline:none;
      color:#e5e7eb;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      padding:14px;
      resize:vertical;
      border-top:1px solid rgba(255,255,255,.08);
    }
    .actions{display:flex;gap:10px;flex-wrap:wrap;padding:14px}
    .btn{
      padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      font-weight:800;font-size:13px;color:#e5e7eb;cursor:pointer;
    }
    .btn.good{border-color:rgba(124,255,178,.45);background:rgba(124,255,178,.12)}
    .btn.bad{border-color:rgba(255,124,124,.35);background:rgba(255,124,124,.12)}
    .btn:hover{background:rgba(255,255,255,.10)}
    .out{
      padding:14px;
      border-top:1px solid rgba(255,255,255,.08);
      color:#d1d5db;
      font-size:13px;
      line-height:1.45;
    }
    code{color:#fff}
    .muted{color:var(--muted)}
    .k{color:var(--accent);font-weight:800}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>SQL Helper</h1>
        <div class="muted" style="font-size:12px;margin-top:2px">Quick generate + validate snippets</div>
      </div>
      <a class="pill" href="index.html">← Home</a>
    </header>

    <div class="grid">
      <div class="card">
        <h2>Input</h2>
        <p>Dán schema / ví dụ JSON rồi bấm Generate.</p>
        <textarea id="in"></textarea>
        <div class="actions">
          <button class="btn good" id="gen">Generate SELECT</button>
          <button class="btn" id="clear">Clear</button>
        </div>
      </div>

      <div class="card">
        <h2>Output</h2>
        <p>Kết quả (copy là dùng).</p>
        <textarea id="out" readonly></textarea>
        <div class="actions">
          <button class="btn good" id="copy">Copy</button>
          <button class="btn bad" id="lint">Simple Lint</button>
        </div>
        <div class="out" id="msg"><span class="muted">—</span></div>
      </div>
    </div>
  </div>

  <script>
    const el = {
      input: document.getElementById("in"),
      out: document.getElementById("out"),
      msg: document.getElementById("msg"),
      gen: document.getElementById("gen"),
      clear: document.getElementById("clear"),
      copy: document.getElementById("copy"),
      lint: document.getElementById("lint"),
    };

    function setMsg(html){ el.msg.innerHTML = html; }

    function tryParseJSON(s){
      try{ return JSON.parse(s); }catch{ return null; }
    }

    function extractColumnsFromSchemaText(s){
      // siêu đơn giản: tìm pattern `col_name` hoặc "col_name":
      const cols = new Set();
      const re1 = /["'`]?([a-zA-Z_][a-zA-Z0-9_]*)["'`]?\s*:/g;
      const re2 = /[`"]([a-zA-Z_][a-zA-Z0-9_]*)[`"]/g;

      let m;
      while((m = re1.exec(s))) cols.add(m[1]);
      while((m = re2.exec(s))) cols.add(m[1]);

      const arr = [...cols];
      arr.sort((a,b)=>a.localeCompare(b));
      return arr;
    }

    function generateSelect(cols, table="movies"){
      const fields = cols.length ? cols.map(c=>`  "${c}"`).join(",\n") : "  *";
      return `SELECT\n${fields}\nFROM "${table}"\nORDER BY "id" DESC\nLIMIT 50;`;
    }

    function simpleLint(sql){
      const issues = [];
      const up = sql.toUpperCase();
      if(!up.includes("SELECT")) issues.push("Thiếu SELECT");
      if(!up.includes("FROM")) issues.push("Thiếu FROM");
      if(!sql.trim().endsWith(";")) issues.push("Nên kết thúc bằng dấu ;");
      return issues;
    }

    el.gen.addEventListener("click", ()=>{
      const s = el.input.value.trim();
      if(!s){ setMsg(`<span class="muted">Nhập gì đó trước đã.</span>`); return; }

      const j = tryParseJSON(s);
      let cols = [];
      if(j && typeof j === "object"){
        const obj = Array.isArray(j) ? (j[0] ?? {}) : j;
        cols = Object.keys(obj || {}).filter(Boolean).sort((a,b)=>a.localeCompare(b));
      }else{
        cols = extractColumnsFromSchemaText(s);
      }

      el.out.value = generateSelect(cols, "movies");
      setMsg(`✅ Generated <span class="k">${cols.length || "*"}</span> fields`);
    });

    el.clear.addEventListener("click", ()=>{
      el.input.value = "";
      el.out.value = "";
      setMsg(`<span class="muted">—</span>`);
    });

    el.copy.addEventListener("click", async ()=>{
      if(!el.out.value.trim()){ setMsg(`<span class="muted">Không có gì để copy.</span>`); return; }
      try{
        await navigator.clipboard.writeText(el.out.value);
        setMsg(`✅ Copied to clipboard`);
      }catch{
        setMsg(`⚠️ Copy fail (trình duyệt chặn clipboard)`);
      }
    });

    el.lint.addEventListener("click", ()=>{
      const sql = el.out.value.trim();
      if(!sql){ setMsg(`<span class="muted">Chưa có output.</span>`); return; }
      const issues = simpleLint(sql);
      if(!issues.length) setMsg(`✅ Looks OK`);
      else setMsg(`⚠️ Lint: <code>${issues.join(" • ")}</code>`);
    });
  </script>
</body>
</html>
