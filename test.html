<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin / Test</title>
  <style>
    :root{
      --bg:#0b0e14;
      --line:#1f2937;
      --muted:#9ca3af;
      --accent:#22c55e;
      --danger:#ff7c7c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(180deg, #070a10 0%, #0b0e14 25%, #06080d 100%);
      color:#e5e7eb;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:10px 0 18px;border-bottom:1px solid var(--line)}
    h1{font-size:18px;margin:0}
    .pill{
      padding:8px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);color:#e5e7eb;
      font-size:13px;cursor:pointer;font-weight:600;text-decoration:none;
    }
    .grid{display:grid;grid-template-columns: 1fr 1fr;gap:12px;margin-top:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }
    .card{
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.25);
      border-radius:18px;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .card h2{margin:0;padding:14px;font-size:14px;border-bottom:1px solid rgba(255,255,255,.08)}
    .body{padding:14px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,textarea,select{
      width:100%;
      padding:10px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:#e5e7eb;
      outline:none;
      font-size:13px;
    }
    textarea{min-height:120px;resize:vertical;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1 1 180px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      padding:9px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      font-weight:800;font-size:13px;color:#e5e7eb;cursor:pointer;
    }
    .btn.good{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.10)}
    .btn.bad{border-color:rgba(255,124,124,.35);background:rgba(255,124,124,.12)}
    .btn:hover{background:rgba(255,255,255,.10)}
    .log{
      border-top:1px solid rgba(255,255,255,.08);
      padding:14px;
      color:#d1d5db;
      font-size:13px;line-height:1.45;
      word-break: break-word;
    }
    .muted{color:var(--muted)}
    .k{color:#9ec1ff;font-weight:800}
    .ok{color:#7cffb2;font-weight:900}
    .err{color:#ff7c7c;font-weight:900}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Admin / Test</h1>
        <div class="muted" style="font-size:12px;margin-top:2px">Add / update item (localStorage + Supabase)</div>
      </div>
      <a class="pill" href="index.html">‚Üê Home</a>
    </header>

    <div class="grid">
      <div class="card">
        <h2>Config</h2>
        <div class="body">
          <label>Supabase URL</label>
          <input id="sbUrl" placeholder="https://xxxx.supabase.co">

          <label>Supabase Anon Key</label>
          <input id="sbKey" placeholder="anon key">

          <label>Table</label>
          <input id="sbTable" value="movies">

          <div class="btns">
            <button class="btn good" id="initSb">Init Supabase</button>
            <button class="btn" id="loadCache">Load localStorage</button>
            <button class="btn bad" id="clearCache">Clear localStorage</button>
          </div>
        </div>
        <div class="log" id="log1"><span class="muted">‚Äî</span></div>
      </div>

      <div class="card">
        <h2>Item (schema m·ªõi)</h2>
        <div class="body">
          <label>Title</label>
          <input id="title" placeholder="T√™n phim...">

          <div class="row">
            <div>
              <label>Kind</label>
              <select id="kind">
                <option value="anime">anime</option>
                <option value="movie">movie</option>
              </select>
            </div>
            <div>
              <label>Quality</label>
              <select id="quality">
                <option>FHD</option>
                <option>HD</option>
                <option>4K</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Year</label>
              <input id="year" placeholder="2026">
            </div>
            <div>
              <label>IMDb</label>
              <input id="imdb" placeholder="7.8">
            </div>
          </div>

          <div class="row">
            <div>
              <label>Country</label>
              <input id="country" placeholder="VN/JP...">
            </div>
            <div>
              <label>Genre (text)</label>
              <input id="genre" placeholder="Action/Fantasy...">
            </div>
          </div>

          <label>Genres (text[] - nh·∫≠p c√°ch nhau d·∫•u ph·∫©y)</label>
          <input id="genres" placeholder="Action, Drama, Fantasy">

          <label>Desc</label>
          <textarea id="desc" placeholder="M√¥ t·∫£ phim..."></textarea>

          <label>Poster URL (posterurl)</label>
          <input id="posterurl" placeholder="https://drive.google.com/file/d/.../view">

          <label>Hero/Banner URL (herourl)</label>
          <input id="herourl" placeholder="https://drive.google.com/file/d/.../view">

          <label>DriveLink (drivelink) - link video (c√≥ th·ªÉ l√† Facebook redirect)</label>
          <input id="drivelink" placeholder="https://drive.google.com/file/d/... ho·∫∑c https://l.facebook.com/l.php?u=...">

          <label>DriveID (driveid) - ƒë·ªÉ tr·ªëng s·∫Ω t·ª± extract t·ª´ drivelink</label>
          <input id="driveid" placeholder="14gEVKOK...">

          <label>JSON raw (optional)</label>
          <textarea id="raw" placeholder='{"title":"...","kind":"anime","posterurl":"...","drivelink":"..."}'></textarea>

          <div class="btns">
            <button class="btn good" id="saveLocal">Save ‚Üí localStorage</button>
            <button class="btn good" id="saveSb">Insert ‚Üí Supabase</button>
            <button class="btn" id="preview">Preview JSON</button>
          </div>
        </div>
        <div class="log" id="log2"><span class="muted">‚Äî</span></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const STORAGE_KEY = "movieapp_data_cache_v1";

    const el = {
      sbUrl: document.getElementById("sbUrl"),
      sbKey: document.getElementById("sbKey"),
      sbTable: document.getElementById("sbTable"),
      initSb: document.getElementById("initSb"),
      loadCache: document.getElementById("loadCache"),
      clearCache: document.getElementById("clearCache"),
      log1: document.getElementById("log1"),

      title: document.getElementById("title"),
      kind: document.getElementById("kind"),
      quality: document.getElementById("quality"),
      year: document.getElementById("year"),
      imdb: document.getElementById("imdb"),
      country: document.getElementById("country"),
      genre: document.getElementById("genre"),
      genres: document.getElementById("genres"),
      desc: document.getElementById("desc"),

      posterurl: document.getElementById("posterurl"),
      herourl: document.getElementById("herourl"),
      drivelink: document.getElementById("drivelink"),
      driveid: document.getElementById("driveid"),

      raw: document.getElementById("raw"),
      saveLocal: document.getElementById("saveLocal"),
      saveSb: document.getElementById("saveSb"),
      preview: document.getElementById("preview"),
      log2: document.getElementById("log2"),
    };

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function setLog(target, html){ target.innerHTML = html; }
    function ok(msg){ return `‚úÖ <span class="ok">${escapeHtml(msg)}</span>`; }
    function err(msg){ return `‚ùå <span class="err">${escapeHtml(msg)}</span>`; }

    function tryDecodeUrlOnce(s){
      try { return decodeURIComponent(s); } catch { return s; }
    }

    // ‚úÖ extractDriveId: b·∫Øt c·∫£ link Facebook redirect
    function extractDriveId(link){
      let s = String(link || "").trim();
      if(!s) return "";

      if(s.includes("l.facebook.com/l.php?")){
        try{
          const u = new URL(s);
          const enc = u.searchParams.get("u");
          if(enc) s = tryDecodeUrlOnce(enc);
        }catch{}
      }

      try{
        const u = new URL(s);
        const maybe = u.searchParams.get("url") || u.searchParams.get("href") || u.searchParams.get("u");
        if(maybe && maybe.includes("drive.google.com")){
          s = tryDecodeUrlOnce(maybe);
        }
      }catch{}

      let m = s.match(/\/file\/d\/([a-zA-Z0-9_-]+)/); if(m) return m[1];
      m = s.match(/open\?id=([a-zA-Z0-9_-]+)/); if(m) return m[1];
      m = s.match(/[?&]id=([a-zA-Z0-9_-]+)/); if(m) return m[1];
      return "";
    }

    function parseGenres(s){
      return String(s || "")
        .split(",")
        .map(x => x.trim())
        .filter(Boolean);
    }

    // cache: l∆∞u UI item gi·ªëng index ƒë·ªÉ list/watch ƒë·ªçc ƒë∆∞·ª£c
    function normalizeForCache(row){
      const posterLink = String(row.posterurl ?? row.poster ?? "");
      const heroLink = String(row.herourl ?? "");

      const did = String(row.driveid ?? "")
        || extractDriveId(row.drivelink ?? "")
        || extractDriveId(row.url ?? "");

      const genresArr = Array.isArray(row.genres) ? row.genres : parseGenres(row.genres);
      const genreText = String(row.genre ?? "");
      const tags = [
        ...genresArr.map(x => String(x||"").trim()).filter(Boolean),
        ...(genreText ? [genreText] : [])
      ];

      // L∆∞u raw link; index s·∫Ω t·ª± t·∫°o bg css khi load supabase; nh∆∞ng cache c≈©ng n√™n c√≥ driveid
      return {
        id: String(row.id ?? crypto.randomUUID()),
        kind: String(row.kind ?? "anime"),
        type: (String(row.kind ?? "anime")==="movie") ? "movie" : "series",
        title: String(row.title ?? ""),
        year: String(row.year ?? ""),
        quality: String(row.quality ?? "FHD"),
        imdb: String(row.imdb ?? ""),
        country: String(row.country ?? ""),
        genre: genreText,
        tags,
        desc: String(row.desc ?? ""),

        poster: posterLink,
        banner: heroLink,
        poster_img: "", // index s·∫Ω fill khi load supabase; cache c≈© kh√¥ng b·∫Øt bu·ªôc
        banner_img: "",

        drivelink: String(row.drivelink ?? row.url ?? ""),
        driveid: did,
        updatedat: row.updatedat ?? Date.now(),
      };
    }

    let supabaseClient = null;

    function getFormPayload(){
      const raw = el.raw.value.trim();
      if(raw){
        let obj;
        try{ obj = JSON.parse(raw); }
        catch{ throw new Error("JSON raw kh√¥ng h·ª£p l·ªá."); }
        return obj;
      }

      const genres = parseGenres(el.genres.value);

      const drivelink = el.drivelink.value.trim();
      const driveid = el.driveid.value.trim() || extractDriveId(drivelink);

      return {
        title: el.title.value.trim() || null,
        kind: el.kind.value.trim() || "anime",
        year: el.year.value.trim() || null,
        quality: el.quality.value.trim() || "FHD",
        imdb: el.imdb.value.trim() || null,

        country: el.country.value.trim() || null,
        genre: el.genre.value.trim() || null,
        genres: genres.length ? genres : [],

        desc: el.desc.value.trim() || null,

        driveid: driveid || null,
        drivelink: drivelink || null,

        posterurl: el.posterurl.value.trim() || null,
        herourl: el.herourl.value.trim() || null,

        // legacy (n·∫øu table c√≥)
        poster: el.posterurl.value.trim() || null,
        url: drivelink || null,

        updatedat: Date.now(),
      };
    }

    function readCache(){
      const s = localStorage.getItem(STORAGE_KEY);
      if(!s) return [];
      try{
        const arr = JSON.parse(s);
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }

    function writeCache(items){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }

    el.initSb.addEventListener("click", ()=>{
      const url = el.sbUrl.value.trim();
      const key = el.sbKey.value.trim();
      if(!url || !key){ setLog(el.log1, err("Thi·∫øu URL ho·∫∑c Anon key.")); return; }
      try{
        supabaseClient = window.supabase.createClient(url, key);
        setLog(el.log1, ok("Supabase init OK"));
      }catch(e){
        setLog(el.log1, err("Init fail: " + (e?.message || e)));
      }
    });

    el.loadCache.addEventListener("click", ()=>{
      const items = readCache();
      setLog(el.log1, ok(`Loaded cache: ${items.length} items`));
    });

    el.clearCache.addEventListener("click", ()=>{
      localStorage.removeItem(STORAGE_KEY);
      setLog(el.log1, ok("Cleared localStorage cache"));
    });

    el.preview.addEventListener("click", ()=>{
      try{
        const payload = getFormPayload();
        setLog(el.log2, `üëÄ Preview payload: <span class="k">${escapeHtml(JSON.stringify(payload, null, 2))}</span>`);
      }catch(e){
        setLog(el.log2, err(e.message || String(e)));
      }
    });

    el.saveLocal.addEventListener("click", ()=>{
      try{
        const payload = getFormPayload();
        const items = readCache();

        // cache l∆∞u d·∫°ng UI item
        const ui = normalizeForCache(payload);

        items.unshift(ui);
        writeCache(items);

        setLog(el.log2, ok(`Saved localStorage (total ${items.length})`));
      }catch(e){
        setLog(el.log2, err(e.message || String(e)));
      }
    });

    el.saveSb.addEventListener("click", async ()=>{
      try{
        const payload = getFormPayload();
        if(!supabaseClient){ setLog(el.log2, err("Ch∆∞a init Supabase.")); return; }
        const table = el.sbTable.value.trim() || "movies";

        const { error } = await supabaseClient.from(table).insert(payload);
        if(error) throw error;

        setLog(el.log2, ok(`Inserted to Supabase`));
      }catch(e){
        setLog(el.log2, err(e?.message || String(e)));
      }
    });
  </script>
</body>
</html>
