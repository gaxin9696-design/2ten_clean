<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
    <!-- ===== Admin: tr√°nh index/search ===== -->
  <meta name="robots" content="noindex,nofollow" />
  <meta name="referrer" content="no-referrer" />

  <link rel="canonical" href="https://YOUR-DOMAIN.COM/admin.html" />
  <link rel="icon" href="/favicon.ico" />
  <meta name="theme-color" content="#0b1224" />
  <title>Khoii - Admin</title>
  <style>
    :root{
      --bg0:#0a0f1d; --bg1:#0b1224;
      --line:rgba(255,255,255,.10); --line2:rgba(255,255,255,.16);
      --text:#e7edf9; --muted:#a8b3cc;
      --accent:#f2c64f;
      --glass: rgba(15,23,42,.55);
      --glass2: rgba(15,23,42,.42);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:linear-gradient(180deg,var(--bg0),var(--bg1));
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 22px 40px}

    .topbar{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      margin-bottom:8px;
    }
    .left{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}

    .pill-link{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      text-decoration:none;
      white-space:nowrap;
    }
    .pill-link:hover{border-color:var(--line2);text-decoration:none}

    h1{margin:10px 0 6px;font-size:22px}

    .card{
      margin-top:14px;
      border:1px solid var(--line);
      background:var(--glass);
      border-radius:16px;
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr .6fr .6fr;
      gap:10px;
    }
    label{font-size:12px;color:rgba(231,237,249,.75)}
    input,select,textarea{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(10,16,32,.55);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:90px;resize:vertical}

    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{
      padding:11px 12px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.06);color:var(--text);
      cursor:pointer;
    }
    .btn:hover{border-color:var(--line2)}
    .btn.primary{background:var(--accent);color:#0b1224;font-weight:800;border-color:rgba(0,0,0,.15)}
    .btn.danger{background:rgba(255,82,82,.14);border-color:rgba(255,82,82,.25)}
    .btn.ghost{background:rgba(255,255,255,.04)}
    .hint{margin-top:10px;color:rgba(231,237,249,.7);font-size:13px;line-height:1.45}

    .list{margin-top:14px;display:grid;gap:10px}
    .item{
      border:1px solid var(--line);
      background:var(--glass2);
      border-radius:14px;
      padding:12px;
      display:grid;
      grid-template-columns: 92px 1fr auto;
      gap:12px;
      align-items:center;
    }
    .poster{
      width:92px;height:64px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.10);
      background:#000;
    }
    .poster img{width:100%;height:100%;object-fit:cover;display:block}
    .meta b{display:block}
    .meta small{color:rgba(231,237,249,.7)}

    /* ===== Tool x·ª≠ ·∫£nh ===== */
    .tool-wrap{display:grid;grid-template-columns: 1fr 1fr; gap:12px}
    .tool-box{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:rgba(10,16,32,.42);
    }
    .tool-title{font-weight:800;margin:0 0 6px}
    .tool-sub{margin:0 0 10px;color:rgba(231,237,249,.65);font-size:13px;line-height:1.35}
    .tool-grid{display:grid;grid-template-columns: 1fr 1fr; gap:10px}
    .tool-grid .full{grid-column:1/-1}

    .previews{
      display:grid; grid-template-columns: 1fr 1fr; gap:12px; align-items:start;
    }
    .preview{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:rgba(10,16,32,.42);
    }
    .preview b{display:block;margin-bottom:8px}
    .preview img{
      width:100%;
      height:auto;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:#000;
      display:block;
    }
    .mini{
      margin-top:8px;
      color:rgba(231,237,249,.65);
      font-size:12px;
      line-height:1.35;
      word-break:break-word;
    }

    @media (max-width: 900px){
      .grid{grid-template-columns:1fr 1fr}
      .tool-wrap{grid-template-columns:1fr}
      .previews{grid-template-columns:1fr}
      .item{grid-template-columns: 78px 1fr; }
      .item .row{grid-column:1/-1}
      .poster{width:78px;height:58px}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="left">
        <a href="index.html">‚Üê V·ªÅ trang ch·ªß</a>
        <span style="color:rgba(231,237,249,.5)">‚Ä¢</span>
        <span style="color:rgba(231,237,249,.75)">Khoii Admin</span>
      </div>

      <div class="right">
        <a class="pill-link" href="https://drive.google.com/file/d/14gEVKOKDl88TIr3RQgUmvfIaVH5ytBr-/view?usp=sharing" target="_blank" rel="noreferrer">
          üîß Tool x·ª≠ ·∫£nh (Drive)
        </a>
      </div>
    </div>

    <h1>Qu·∫£n l√Ω phim (Google Drive)</h1>

    <div class="card">
      <div class="grid">
        <div>
          <label>Link Google Drive (ho·∫∑c ID)</label>
          <input id="drive" placeholder="https://drive.google.com/file/d/.... ho·∫∑c FILE_ID" />
        </div>

        <div>
          <label>T√™n phim</label>
          <input id="title" placeholder="V√≠ d·ª•: One Piece..." />
        </div>

        <div>
          <label>Ph√¢n lo·∫°i</label>
          <select id="kind">
            <option value="anime">Anime</option>
            <option value="movie">Phim l·∫ª</option>
            <option value="series">Phim b·ªô</option>
          </select>
        </div>

        <div>
          <label>NƒÉm</label>
          <input id="year" placeholder="2026" />
        </div>

        <div>
          <label>Ch·∫•t l∆∞·ª£ng</label>
          <input id="quality" placeholder="FHD / 4K / HD..." />
        </div>

        <div>
          <label>Poster (Link ·∫£nh Google Drive ho·∫∑c ID ·∫£nh)</label>
          <input id="posterUrl" placeholder="D√°n link ·∫£nh Drive: https://drive.google.com/file/d/.../view ho·∫∑c ID ·∫£nh" />
        </div>

        <div>
          <label>Hero (Link ·∫£nh Google Drive ho·∫∑c ID ·∫£nh)</label>
          <input id="heroUrl" placeholder="D√°n link ·∫£nh Drive: https://drive.google.com/file/d/.../view ho·∫∑c ID ·∫£nh" />
        </div>

        <div>
          <label>Drive ID (t·ª± l·∫•y)</label>
          <input id="driveId" placeholder="Auto..." disabled />
        </div>
      </div>

      <div style="margin-top:10px">
        <label>M√¥ t·∫£</label>
        <textarea id="desc" placeholder="Ghi ch√∫ ng·∫Øn (t√πy ch·ªçn)"></textarea>
      </div>

      <div class="row">
        <button class="btn primary" id="btnAdd">Th√™m phim</button>
        <button class="btn" id="btnUpdate">C·∫≠p nh·∫≠t theo Drive ID (n·∫øu tr√πng)</button>
        <button class="btn danger" id="btnClearAll">X√≥a h·∫øt d·ªØ li·ªáu</button>
        <button class="btn ghost" id="btnClearForm">X√≥a form</button>
      </div>

      <div class="hint">
        - Thumbnail Drive: <b>drive.google.com/thumbnail?id=FILE_ID</b> (c√≥ th·ªÉ kh√¥ng ra n·∫øu file private).<br>
        - N·∫øu thumb x·∫•u ‚Üí d√πng <b>Poster URL</b> / <b>Hero URL</b> ho·∫∑c Tool x·ª≠ ·∫£nh b√™n d∆∞·ªõi (xu·∫•t ·∫£nh base64).
      </div>
    </div>

    <!-- TOOL_CROP_DISABLED: removed to avoid base64/localStorage bloat -->
<div class="card">
      <b>Tool x·ª≠ l√Ω ·∫£nh (t·∫°o Poster 2:3 + Hero 16:9)</b>

      <div class="hint" style="margin-top:8px">
        Ch·ªçn ·∫£nh t·ª´ m√°y ‚Üí h·ªá th·ªëng s·∫Ω <b>center-crop</b> ƒë√∫ng t·ªâ l·ªá v√† n√©n ·∫£nh.
        N·∫øu ·∫£nh base64 qu√° n·∫∑ng (localStorage gi·ªõi h·∫°n ~5MB), h√£y gi·∫£m Quality ho·∫∑c d√πng link ·∫£nh ngo√†i.
      </div>

      <div class="tool-wrap" style="margin-top:12px">
        <div class="tool-box">
          <p class="tool-title">1) Ch·ªçn ·∫£nh ngu·ªìn</p>
          <p class="tool-sub">N√™n ch·ªçn ·∫£nh l·ªõn, r√µ (jpg/png/webp). Tool s·∫Ω t·ª± c·∫Øt gi·ªØa cho ƒë·∫πp.</p>

          <div class="tool-grid">
            <div class="full">
              <label>Ch·ªçn file ·∫£nh</label>
              <input id="imgFile" type="file" accept="image/*" />
            </div>

            <div>
              <label>ƒê·ªãnh d·∫°ng xu·∫•t</label>
              <select id="outFormat">
                <option value="image/webp">WEBP (nh·∫π)</option>
                <option value="image/jpeg">JPG (·ªïn ƒë·ªãnh)</option>
              </select>
            </div>

            <div>
              <label>Quality: <span id="qVal">0.85</span></label>
              <input id="qualityRange" type="range" min="0.5" max="0.95" step="0.01" value="0.85" />
            </div>

            <div>
              <label>Focus X (d·ªãch khung c·∫Øt)</label>
              <input id="focusX" type="range" min="-100" max="100" step="1" value="0" />
            </div>

            <div>
              <label>Focus Y (d·ªãch khung c·∫Øt)</label>
              <input id="focusY" type="range" min="-100" max="100" step="1" value="0" />
            </div>

            <div class="full row">
              <button class="btn primary" id="btnMakeBoth">T·∫°o Poster + Hero</button>
              <button class="btn" id="btnMakePoster">T·∫°o Poster</button>
              <button class="btn" id="btnMakeHero">T·∫°o Hero</button>
            </div>
          </div>
        </div>

        <div class="tool-box">
          <p class="tool-title">2) K·∫øt qu·∫£</p>
          <p class="tool-sub">B·∫•m ‚ÄúD√πng l√†m ‚Ä¶ URL‚Äù ƒë·ªÉ t·ª± ƒëi·ªÅn v√†o form ph√≠a tr√™n.</p>

          <div class="previews">
            <div class="preview">
              <b>Poster (500√ó750)</b>
              <img id="posterPreview" alt="" />
              <div class="row" style="margin-top:10px">
                <button class="btn" id="usePoster">D√πng l√†m Poster URL</button>
                <button class="btn" id="copyPoster">Copy</button>
              </div>
              <div class="mini" id="posterInfo">Ch∆∞a t·∫°o.</div>
            </div>

            <div class="preview">
              <b>Hero (1600√ó900)</b>
              <img id="heroPreview" alt="" />
              <div class="row" style="margin-top:10px">
                <button class="btn" id="useHero">D√πng l√†m Hero URL</button>
                <button class="btn" id="copyHero">Copy</button>
              </div>
              <div class="mini" id="heroInfo">Ch∆∞a t·∫°o.</div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <div id="loginBox" class="card" style="max-width:520px;margin:12px auto;">
      <b>Admin Login</b>
      <div class="grid" style="margin-top:8px">
        <label>Email</label>
        <input id="email" placeholder="Email admin">
        <label>Password</label>
        <input id="password" type="password" placeholder="Password">
      </div>
      <div class="row" style="margin-top:10px;justify-content:flex-end">
        <button class="btn" id="btnLogin">ƒêƒÉng nh·∫≠p</button>
        <button class="btn danger" id="btnLogout" style="display:none">ƒêƒÉng xu·∫•t</button>
      </div>
      <small id="loginMsg" style="opacity:.8"></small>
    </div>

<!-- /TOOL_CROP_DISABLED -->
<div class="card">
      <b>Danh s√°ch phim ƒë√£ l∆∞u</b>
      <div class="list" id="list"></div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "khoii_drive_movies_v1";
    const LEGACY_KEY  = "my_drive_movies_v2";

    
    // ===== Supabase (Public read + Admin write via RLS) =====
    const SUPABASE_URL = "https://nzalaxolteaiafvuceqz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56YWxheG9sdGVhaWFmdnVjZXF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTY2MjAsImV4cCI6MjA4NTg3MjYyMH0.0eIz6cfB4Dr_g5Wja70tZCMvVfUKoI5H4D8MJBP49Bg";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const DriveTool = (() => {
      const patterns = [
        /drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]{10,})/i,
        /drive\.google\.com\/open\?id=([a-zA-Z0-9_-]{10,})/i,
        /drive\.google\.com\/uc\?id=([a-zA-Z0-9_-]{10,})/i,
        /drive\.google\.com\/uc\?export=download&id=([a-zA-Z0-9_-]{10,})/i,
      ];
      function extractId(input){
        const s = String(input || "").trim();
        if (/^[a-zA-Z0-9_-]{10,}$/.test(s)) return s;
        try{
          const u = new URL(s);
          const qid = u.searchParams.get("id");
          if(qid && /^[a-zA-Z0-9_-]{10,}$/.test(qid)) return qid;
        }catch{}
        for(const re of patterns){
          const m = s.match(re);
          if(m && m[1]) return m[1];
        }
        return null;
      }
      function thumbSmall(id){ return `https://drive.google.com/thumbnail?id=${id}&sz=w400`; }
      // Link ·∫£nh ·ªïn cho <img> (c·∫ßn file ·∫£nh Drive ƒë·ªÉ public)
      function imgView(id){ return `https://drive.google.com/uc?export=view&id=${id}`; }
      // Thumbnail size tu·ª≥ ch·ªânh (nhanh, nh·∫π)
      function thumb(id, w=1200){ return `https://drive.google.com/thumbnail?id=${id}&sz=w${w}`; }
      return { extractId, thumbSmall, imgView, thumb };
    })();

    // B√≥c link redirect (Facebook l.php?u=...) ƒë·ªÉ l·∫•y URL th·∫≠t
    function unwrapRedirectLink(input){
      const s = String(input || "").trim();
      if(!s) return "";
      try{
        const url = new URL(s);
        const host = url.hostname.toLowerCase();
        if ((host === "l.facebook.com" || host === "www.facebook.com" || host === "facebook.com") && url.pathname === "/l.php"){
          const u = url.searchParams.get("u");
          if(u) return decodeURIComponent(u);
        }
        return s;
      }catch(e){
        return s;
      }
    }

    // Chu·∫©n ho√° input ·∫£nh (link/ID Drive) -> link ·∫£nh d√πng ƒë∆∞·ª£c
    function normalizeDriveImage(input, prefer = "thumb", w = 1200){
      let s = String(input || "").trim();
      if(!s) return "";
      // NEW: b√≥c redirect tr∆∞·ªõc khi extract ID Drive
      s = unwrapRedirectLink(s);

      const id = DriveTool.extractId(s);
      if(!id) return s; // kh√¥ng ph·∫£i drive -> gi·ªØ nguy√™n (ph√≤ng khi d√°n link ·∫£nh ngo√†i)
      return prefer === "view" ? DriveTool.imgView(id) : DriveTool.thumb(id, w);
    }

function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function apiGetMovies(){
      const { data, error } = await sb
        .from("movies")
        .select("*")
        .order("created_at", { ascending: false });

      if(error){ console.error(error); return []; }

      return (data || []).map(m => ({
        id: m.id,
        title: m.title,
        kind: m.kind || "anime",
        year: m.year || "",
        quality: m.quality || "FHD",
        desc: m.desc || "",
        driveId: m.driveid,
        driveLink: m.drivelink || m.driveid,
        posterUrl: m.posterurl || "",
        heroUrl: m.herourl || "",
        updatedAt: m.updatedat || Date.now(),
      }));
    }

    async function apiUpsertMovie(movie){
      const payload = {
        title: movie.title,
        kind: movie.kind,
        year: movie.year,
        quality: movie.quality,
        "desc": movie.desc,
        driveid: movie.driveId,
        drivelink: movie.driveLink,
        posterurl: movie.posterUrl,
        herourl: movie.heroUrl,
        updatedat: Date.now()
      };

      const { error } = await sb
        .from("movies")
        .upsert(payload, { onConflict: "driveid" });

      if(error) throw error;
      return await apiGetMovies();
    }

    async function apiDeleteMovieByDriveId(driveId){
      const { error } = await sb.from("movies").delete().eq("driveid", driveId);
      if(error) throw error;
      return await apiGetMovies();
    }

    async function apiClearAll(){
      // X√≥a t·∫•t c·∫£ rows (RLS s·∫Ω ch·ªâ cho admin l√†m)
      const { error } = await sb.from("movies").delete().neq("driveid", "___never___");
      if(error) throw error;
      return [];
    }
function uid(){
      return "m_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    const el = {
      drive: document.getElementById("drive"),
      title: document.getElementById("title"),
      kind: document.getElementById("kind"),
      year: document.getElementById("year"),
      quality: document.getElementById("quality"),
      posterUrl: document.getElementById("posterUrl"),
      heroUrl: document.getElementById("heroUrl"),
      driveId: document.getElementById("driveId"),
      desc: document.getElementById("desc"),

      btnAdd: document.getElementById("btnAdd"),
      btnUpdate: document.getElementById("btnUpdate"),
      btnClearAll: document.getElementById("btnClearAll"),
      btnClearForm: document.getElementById("btnClearForm"),
      list: document.getElementById("list"),
    };

    let movies = [];

    async function refreshList(){
      movies = await apiGetMovies();
      render();
    }


    function render(){
      el.list.innerHTML = "";

      if(movies.length === 0){
        el.list.innerHTML = `<div style="color:rgba(231,237,249,.7)">Ch∆∞a c√≥ phim n√†o.</div>`;
        return;
      }

      movies.forEach(m => {
        const wrap = document.createElement("div");
        wrap.className = "item";

        const poster = m.posterUrl || (m.driveId ? DriveTool.thumbSmall(m.driveId) : "");
        wrap.innerHTML = `
          <div class="poster"><img src="${poster}" alt=""></div>
          <div class="meta">
            <b>${escapeHtml(m.title || "Kh√¥ng t√™n")}</b>
            <small>${escapeHtml(m.kind || "anime")} ‚Ä¢ ${escapeHtml(m.year || "‚Äî")} ‚Ä¢ ${escapeHtml(m.quality || "FHD")}</small><br>
            <small>DriveID: ${escapeHtml(m.driveId || "‚Äî")}</small>
          </div>
          <div class="row">
            <button class="btn" data-act="fill">S·ª≠a</button>
            <button class="btn danger" data-act="del">X√≥a</button>
          </div>
        `;

        wrap.querySelector('img').onerror = () => { wrap.querySelector('img').style.display = "none"; };

        wrap.querySelector('[data-act="fill"]').addEventListener("click", () => fillForm(m));
        wrap.querySelector('[data-act="del"]').addEventListener("click", () => delMovie(m.driveId));
        el.list.appendChild(wrap);
      });
    }

    function syncDriveId(){
      const id = DriveTool.extractId(el.drive.value);
      el.driveId.value = id || "";
      return id;
    }

    function getFormData(){
      const driveId = syncDriveId();
      if(!driveId) return { ok:false, error:"Link/ID Google Drive kh√¥ng h·ª£p l·ªá." };

      const title = el.title.value.trim();
      if(!title) return { ok:false, error:"B·∫°n ch∆∞a nh·∫≠p t√™n phim." };

      return {
        ok:true,
        data:{
          id: uid(),
          title,
          kind: el.kind.value,
          year: el.year.value.trim() || "",
          quality: el.quality.value.trim() || "FHD",
          desc: el.desc.value.trim() || "",
          driveId,
          driveLink: el.drive.value.trim(),
          posterUrl: normalizeDriveImage(el.posterUrl.value, "thumb", 600),
          heroUrl: normalizeDriveImage(el.heroUrl.value, "thumb", 1600),
          updatedAt: Date.now()
        }
      };
    }

    function clearForm(){
      el.drive.value = "";
      el.title.value = "";
      el.kind.value = "anime";
      el.year.value = "";
      el.quality.value = "";
      el.posterUrl.value = "";
      el.heroUrl.value = "";
      el.driveId.value = "";
      el.desc.value = "";
    }

    async function addMovie(){
      const r = getFormData();
      if(!r.ok){ alert(r.error); return; }

      try{
        movies = await apiUpsertMovie(r.data);
        clearForm();
        render();
        alert("ƒê√£ th√™m/c·∫≠p nh·∫≠t phim! Quay v·ªÅ trang ch·ªß ƒë·ªÉ xem.");
      }catch(e){
        console.error(e);
        alert("Kh√¥ng th·ªÉ l∆∞u. B·∫°n ƒë√£ ƒëƒÉng nh·∫≠p admin ch∆∞a?");
      }
    }

    async function updateByDriveId(){
      // Supabase upsert theo driveId => d√πng chung addMovie()
      return addMovie();
    }

    async function delMovie(driveId){
      if(!confirm("X√≥a phim n√†y?")) return;
      try{
        movies = await apiDeleteMovieByDriveId(driveId);
        render();
      }catch(e){
        console.error(e);
        alert("Kh√¥ng th·ªÉ x√≥a. B·∫°n ƒë√£ ƒëƒÉng nh·∫≠p admin ch∆∞a?");
      }
    }

    function fillForm(m){
      el.drive.value = m.driveLink || m.driveId || "";
      el.title.value = m.title || "";
      el.kind.value = m.kind || "anime";
      el.year.value = m.year || "";
      el.quality.value = m.quality || "FHD";
      el.desc.value = m.desc || "";
      el.posterUrl.value = m.posterUrl || "";
      el.heroUrl.value = m.heroUrl || "";
      el.driveId.value = m.driveId || "";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    async function clearAll(){
      if(!confirm("X√≥a h·∫øt d·ªØ li·ªáu ƒë√£ l∆∞u?")) return;
      try{
        movies = await apiClearAll();
        render();
      }catch(e){
        console.error(e);
        alert("Kh√¥ng th·ªÉ x√≥a h·∫øt. B·∫°n ƒë√£ ƒëƒÉng nh·∫≠p admin ch∆∞a?");
      }
    }

    el.drive.addEventListener("input", syncDriveId);

    // Auto convert link/ID ·∫£nh Drive -> link ·∫£nh hi·ªÉn th·ªã ƒë∆∞·ª£c
    el.posterUrl.addEventListener("change", () => {
      el.posterUrl.value = normalizeDriveImage(el.posterUrl.value, "thumb", 600);
    });
    el.heroUrl.addEventListener("change", () => {
      el.heroUrl.value = normalizeDriveImage(el.heroUrl.value, "thumb", 1600);
    });

    el.btnAdd.addEventListener("click", addMovie);
    el.btnUpdate.addEventListener("click", updateByDriveId);
    el.btnClearAll.addEventListener("click", clearAll);
    el.btnClearForm.addEventListener("click", clearForm);

    render();

    /* ================== TOOL X·ª¨ ·∫¢NH (Canvas) ================== */
    const tool = {
      file: document.getElementById("imgFile"),
      format: document.getElementById("outFormat"),
      quality: document.getElementById("qualityRange"),
      qVal: document.getElementById("qVal"),
      fx: document.getElementById("focusX"),
      fy: document.getElementById("focusY"),

      btnBoth: document.getElementById("btnMakeBoth"),
      btnPoster: document.getElementById("btnMakePoster"),
      btnHero: document.getElementById("btnMakeHero"),

      posterImg: document.getElementById("posterPreview"),
      heroImg: document.getElementById("heroPreview"),
      posterInfo: document.getElementById("posterInfo"),
      heroInfo: document.getElementById("heroInfo"),

      usePoster: document.getElementById("usePoster"),
      useHero: document.getElementById("useHero"),
      copyPoster: document.getElementById("copyPoster"),
      copyHero: document.getElementById("copyHero"),
    };

    let srcImage = null;
    let posterDataUrl = "";
    let heroDataUrl = "";

    tool.qVal.textContent = Number(tool.quality.value).toFixed(2);
    tool.quality.addEventListener("input", () => {
      tool.qVal.textContent = Number(tool.quality.value).toFixed(2);
    });

    tool.file.addEventListener("change", async (e) => {
      const f = e.target.files?.[0];
      if(!f) return;

      if(!f.type.startsWith("image/")){
        alert("File kh√¥ng ph·∫£i ·∫£nh.");
        return;
      }

      const dataUrl = await readFileAsDataURL(f);
      srcImage = await loadImage(dataUrl);

      tool.posterInfo.textContent = "ƒê√£ n·∫°p ·∫£nh ngu·ªìn: " + srcImage.width + "√ó" + srcImage.height;
      tool.heroInfo.textContent = "ƒê√£ n·∫°p ·∫£nh ngu·ªìn: " + srcImage.width + "√ó" + srcImage.height;

      posterDataUrl = "";
      heroDataUrl = "";
      tool.posterImg.removeAttribute("src");
      tool.heroImg.removeAttribute("src");
      tool.posterInfo.textContent += " ‚Ä¢ Ch∆∞a t·∫°o Poster.";
      tool.heroInfo.textContent += " ‚Ä¢ Ch∆∞a t·∫°o Hero.";
    });

    function readFileAsDataURL(file){
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(String(fr.result || ""));
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    function loadImage(url){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = url;
      });
    }

    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function centerCropDraw(img, outW, outH, focusX, focusY, mime, quality){
      const targetAspect = outW / outH;
      const sw = img.width, sh = img.height;
      const srcAspect = sw / sh;

      let cropW, cropH;
      if(srcAspect > targetAspect){
        cropH = sh;
        cropW = sh * targetAspect;
      }else{
        cropW = sw;
        cropH = sw / targetAspect;
      }

      const maxDx = (sw - cropW) / 2;
      const maxDy = (sh - cropH) / 2;

      const fx = clamp(focusX, -1, 1);
      const fy = clamp(focusY, -1, 1);

      const sx = (sw - cropW)/2 + fx * maxDx;
      const sy = (sh - cropH)/2 + fy * maxDy;

      const canvas = document.createElement("canvas");
      canvas.width = outW;
      canvas.height = outH;
      const ctx = canvas.getContext("2d");

      ctx.fillStyle = "#000";
      ctx.fillRect(0,0,outW,outH);

      ctx.drawImage(img, sx, sy, cropW, cropH, 0, 0, outW, outH);

      let m = mime;
      if(m === "image/webp"){
        try{
          const test = canvas.toDataURL("image/webp", 0.8);
          if(!test.startsWith("data:image/webp")) m = "image/jpeg";
        }catch{
          m = "image/jpeg";
        }
      }

      const dataUrl = canvas.toDataURL(m, quality);
      return { dataUrl, mime: m };
    }

    function approxKB(dataUrl){
      const i = dataUrl.indexOf("base64,");
      if(i === -1) return 0;
      const b64 = dataUrl.slice(i + 7);
      const bytes = Math.floor(b64.length * 0.75);
      return Math.round(bytes / 1024);
    }

    function requireSrc(){
      if(!srcImage){
        alert("B·∫°n ch∆∞a ch·ªçn ·∫£nh ngu·ªìn.");
        return false;
      }
      return true;
    }

    function getFocus(){
      const fx = Number(tool.fx.value) / 100;
      const fy = Number(tool.fy.value) / 100;
      return { fx, fy };
    }

    function getSettings(){
      return {
        mime: tool.format.value,
        quality: Number(tool.quality.value),
      };
    }

    function makePoster(){
      if(!requireSrc()) return;
      const { fx, fy } = getFocus();
      const { mime, quality } = getSettings();

      const r = centerCropDraw(srcImage, 500, 750, fx, fy, mime, quality);
      posterDataUrl = r.dataUrl;

      tool.posterImg.src = posterDataUrl;
      tool.posterInfo.textContent = `ƒê·ªãnh d·∫°ng: ${r.mime} ‚Ä¢ ~${approxKB(posterDataUrl)}KB ‚Ä¢ 500√ó750`;
    }

    function makeHero(){
      if(!requireSrc()) return;
      const { fx, fy } = getFocus();
      const { mime, quality } = getSettings();

      const r = centerCropDraw(srcImage, 1600, 900, fx, fy, mime, quality);
      heroDataUrl = r.dataUrl;

      tool.heroImg.src = heroDataUrl;
      tool.heroInfo.textContent = `ƒê·ªãnh d·∫°ng: ${r.mime} ‚Ä¢ ~${approxKB(heroDataUrl)}KB ‚Ä¢ 1600√ó900`;
    }

    tool.btnPoster.addEventListener("click", makePoster);
    tool.btnHero.addEventListener("click", makeHero);
    tool.btnBoth.addEventListener("click", () => { makePoster(); makeHero(); });

    tool.usePoster.addEventListener("click", () => {
      if(!posterDataUrl){ alert("Ch∆∞a t·∫°o Poster."); return; }
      el.posterUrl.value = posterDataUrl;
      alert("ƒê√£ g√°n Poster URL v√†o form!");
    });

    tool.useHero.addEventListener("click", () => {
      if(!heroDataUrl){ alert("Ch∆∞a t·∫°o Hero."); return; }
      el.heroUrl.value = heroDataUrl;
      alert("ƒê√£ g√°n Hero URL v√†o form!");
    });

    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch{
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        const ok = document.execCommand("copy");
        ta.remove();
        return ok;
      }
    }

    tool.copyPoster.addEventListener("click", async () => {
      if(!posterDataUrl){ alert("Ch∆∞a t·∫°o Poster."); return; }
      const ok = await copyText(posterDataUrl);
      alert(ok ? "ƒê√£ copy Poster!" : "Copy th·∫•t b·∫°i (tr√¨nh duy·ªát ch·∫∑n).");
    });

    tool.copyHero.addEventListener("click", async () => {
      if(!heroDataUrl){ alert("Ch∆∞a t·∫°o Hero."); return; }
      const ok = await copyText(heroDataUrl);
      alert(ok ? "ƒê√£ copy Hero!" : "Copy th·∫•t b·∫°i (tr√¨nh duy·ªát ch·∫∑n).");
    });
  </script>
</body>
</html>