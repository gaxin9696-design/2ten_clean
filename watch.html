<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <meta name="description" content="Khoii – Trang xem phim. Mở nhanh, xem mượt." />
  <meta name="robots" content="index,follow" />
  <meta name="theme-color" content="#0b1224" />
  <link rel="icon" href="/favicon.ico" />

  <title>Khoii - Xem phim</title>

  <style>
    :root {
      --bg0: #0b0f17;
      --bg1: #0b1224;
      --text: #e7edf9;
      --muted: rgba(231, 237, 249, .72);
      --line: rgba(255, 255, 255, .10);
      --line2: rgba(255, 255, 255, .16);
      --glass: rgba(18, 24, 36, .72);
      --glass2: rgba(18, 24, 36, .55);
      --accent: #f2c64f;
      --radius: 22px;
      --shadow: 0 18px 65px rgba(0, 0, 0, .55);
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(1200px 500px at 20% -10%, rgba(99, 102, 241, .18), transparent 55%),
        radial-gradient(900px 420px at 85% 10%, rgba(245, 158, 11, .10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      background-image:
        radial-gradient(circle, rgba(255, 255, 255, .22) 1px, transparent 1.2px),
        radial-gradient(circle, rgba(255, 255, 255, .14) 1px, transparent 1.25px);
      background-size: 7px 7px, 14px 14px;
      background-position: 0 0, 3px 3px;
      opacity: .10;
      mix-blend-mode: overlay;
      filter: blur(.15px);
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 1320px;
      margin: 0 auto;
      padding: 18px 22px 40px;
    }

    /* ===== TOPBAR (đồng bộ index) ===== */
    .topbar {
      display: flex;
      align-items: center;
      gap: 16px
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 170px;
      cursor: pointer
    }

    .brand-logo {
      width: 44px;
      height: 34px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      font-weight: 900;
      letter-spacing: .6px;
      color: #0b1224;
      background:
        radial-gradient(18px 18px at 30% 35%, rgba(255, 255, 255, .22), transparent 60%),
        linear-gradient(135deg, #f59e0b, #fb7185);
      box-shadow: 0 10px 25px rgba(245, 158, 11, .22);
      position: relative;
      overflow: hidden;
      user-select: none;
    }

    .brand-logo:before {
      content: "";
      position: absolute;
      inset: 0;
      background: conic-gradient(from 220deg, rgba(0, 0, 0, .35), transparent 40%, rgba(0, 0, 0, .28));
      mix-blend-mode: overlay;
    }

    .brand-logo span {
      position: relative;
      z-index: 1
    }

    .brand-name {
      font-weight: 900;
      letter-spacing: .3px;
      font-size: 18px;
      line-height: 1.1
    }

    .brand-sub {
      font-size: 11px;
      color: rgba(231, 237, 249, .55);
      margin-top: 2px
    }

    .search {
      flex: 1;
      max-width: 620px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 12px;
      background: var(--glass);
      border: 1px solid rgba(255, 255, 255, .12);
      box-shadow: 0 10px 30px rgba(0, 0, 0, .30);
      backdrop-filter: blur(14px);
    }

    .search input {
      width: 100%;
      border: 0;
      outline: 0;
      background: transparent;
      color: var(--text);
      font-size: 14px;
    }

    .search input::placeholder {
      color: rgba(231, 237, 249, .50)
    }

    .nav {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-left: 6px
    }

    .nav a {
      color: rgba(231, 237, 249, .88);
      text-decoration: none;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 10px;
      border-radius: 10px;
    }

    .nav a:hover {
      background: rgba(255, 255, 255, .06)
    }

    .nav a.active {
      border: 1px solid rgba(242, 198, 79, .35);
      background: rgba(242, 198, 79, .10);
    }

    .member-btn {
      margin-left: auto;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: var(--glass2);
      color: var(--text);
      cursor: pointer;
      backdrop-filter: blur(14px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, .24);
    }

    .member-btn:hover {
      border-color: var(--line2)
    }

    .member-btn svg {
      opacity: .95
    }

    /* ===== WATCH CARD ===== */
    .watch-card {
      margin-top: 18px;
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(10, 14, 22, .55);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
    }

    .watch-card::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      background-image:
        radial-gradient(circle, rgba(255, 255, 255, .12) 1px, transparent 1.5px),
        radial-gradient(circle, rgba(255, 255, 255, .08) 1px, transparent 1.5px);
      background-size: 10px 10px, 20px 20px;
      background-position: 0 0, 5px 5px;
      opacity: .20;
      mix-blend-mode: overlay;
      -webkit-mask-image: linear-gradient(180deg, #000 0 70%, transparent 100%);
      mask-image: linear-gradient(180deg, #000 0 70%, transparent 100%);
    }

    .watch-head {
      position: relative;
      z-index: 1;
      padding: 18px 18px 12px;
      display: flex;
      gap: 14px;
      align-items: flex-start;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .title-wrap {
      min-width: 260px;
      flex: 1
    }

    h1 {
      margin: 0;
      font-size: 26px;
      letter-spacing: .2px;
    }

    .subtitle {
      margin-top: 6px;
      color: var(--muted);
      font-size: 13px;
    }

    .badges,
    .genres {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(18, 24, 36, .45);
      color: rgba(231, 237, 249, .92);
      font-size: 13px;
      backdrop-filter: blur(10px);
    }

    .badge.imdb {
      border-color: rgba(242, 198, 79, .75);
      background: rgba(242, 198, 79, .10)
    }

    .badge b {
      font-size: 11px;
      letter-spacing: .6px;
      opacity: .9
    }

    .genre {
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(18, 24, 36, .40);
      color: rgba(231, 237, 249, .88);
      font-size: 13px;
      backdrop-filter: blur(10px);
    }

    .desc {
      margin: 12px 0 0;
      color: rgba(231, 237, 249, .80);
      font-size: 14px;
      line-height: 1.55;
      max-width: 80ch;
    }

    .links {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      color: var(--muted);
      justify-content: flex-end;
    }

    .pill {
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(18, 24, 36, .35);
    }

    a {
      color: var(--accent);
      text-decoration: none
    }

    a:hover {
      text-decoration: underline
    }

    .player {
      position: relative;
      width: 100%;
      padding-top: 56.25%;
      background: #000;
      border-top: 1px solid rgba(255, 255, 255, .08);
    }

    iframe {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0
    }

    @media (max-width:980px) {
      .nav {
        display: none
      }

      .member-btn span {
        display: none
      }
    }

    @media (max-width:760px) {
      h1 {
        font-size: 22px
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="topbar">
      <div class="brand" onclick="location.href='index.html'">
        <div class="brand-logo" aria-hidden="true"><span>K</span></div>
        <div>
          <div class="brand-name">Khoii</div>
          <div class="brand-sub">Xem phim</div>
        </div>
      </div>

      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M10.5 19a8.5 8.5 0 1 1 0-17 8.5 8.5 0 0 1 0 17Z" stroke="rgba(231,237,249,.85)" stroke-width="2" />
          <path d="M16.8 16.8 21 21" stroke="rgba(231,237,249,.85)" stroke-width="2" stroke-linecap="round" />
        </svg>
        <input id="q" placeholder="Tìm kiếm phim, diễn viên" />
      </div>

      <nav class="nav" aria-label="Main navigation">
        <a href="list.html">Thể loại</a>
        <a href="list.html?kind=movie">Phim Lẻ</a>
        <a href="list.html?kind=series">Phim Bộ</a>
        <a href="list.html">Quốc gia</a>
      </nav>

      <button class="member-btn" onclick="location.href='test.html'">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 12a4.5 4.5 0 1 0-4.5-4.5A4.5 4.5 0 0 0 12 12Z" stroke="rgba(231,237,249,.9)" stroke-width="2" />
          <path d="M20 21a8 8 0 1 0-16 0" stroke="rgba(231,237,249,.9)" stroke-width="2" stroke-linecap="round" />
        </svg>
        <span>Thành viên</span>
      </button>
    </header>

    <section class="watch-card" aria-label="Xem phim">
      <div class="watch-head">
        <div class="title-wrap">
          <h1 id="title">Đang tải…</h1>
          <div id="subtitle" class="subtitle">—</div>

          <div id="badges" class="badges" aria-label="Thông tin nhanh"></div>
          <div id="genres" class="genres" aria-label="Thể loại"></div>
          <p id="desc" class="desc"></p>
        </div>

        <div class="links">
          <span class="pill" id="fileId">ID: —</span>
          <a id="openDrive" target="_blank" rel="noreferrer">Mở trên Drive</a>
          <span>•</span>
          <a id="backLink" href="index.html">← Quay lại</a>
        </div>
      </div>

      <div class="player">
        <iframe id="frame" allow="autoplay; fullscreen"></iframe>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ===== Supabase (để lấy info phim theo driveid nếu có) =====
    const SUPABASE_URL = "https://nzalaxolteaiafvuceqz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56YWxheG9sdGVhaWFmdnVjZXF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTY2MjAsImV4cCI6MjA4NTg3MjYyMH0.0eIz6cfB4Dr_g5Wja70tZCMvVfUKoI5H4D8MJBP49Bg";
    const supabase = window.supabase?.createClient
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    const DriveTool = (() => {
      const patterns = [
        /drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]{10,})/i,
        /drive\.google\.com\/open\?id=([a-zA-Z0-9_-]{10,})/i,
        /drive\.google\.com\/uc\?id=([a-zA-Z0-9_-]{10,})/i,
        /drive\.google\.com\/uc\?export=download&id=([a-zA-Z0-9_-]{10,})/i,
      ];
      function extractId(input) {
        const s = String(input || "").trim();
        if (/^[a-zA-Z0-9_-]{10,}$/.test(s)) return s;
        try {
          const u = new URL(s);
          const qid = u.searchParams.get("id");
          if (qid && /^[a-zA-Z0-9_-]{10,}$/.test(qid)) return qid;
        } catch { }
        for (const re of patterns) {
          const m = s.match(re);
          if (m && m[1]) return m[1];
        }
        return null;
      }
      function links(id) {
        return {
          id,
          preview: `https://drive.google.com/file/d/${id}/preview`,
          view: `https://drive.google.com/file/d/${id}/view`,
        };
      }
      function normalize(input) {
        const id = extractId(input);
        if (!id) return { ok: false, error: "Không tách được ID từ link Drive.", id: null, links: null };
        return { ok: true, id, links: links(id) };
      }
      return { normalize };
    })();

    const el = {
      title: document.getElementById("title"),
      subtitle: document.getElementById("subtitle"),
      badges: document.getElementById("badges"),
      genres: document.getElementById("genres"),
      desc: document.getElementById("desc"),
      frame: document.getElementById("frame"),
      fileId: document.getElementById("fileId"),
      openDrive: document.getElementById("openDrive"),
      backLink: document.getElementById("backLink"),
      q: document.getElementById("q"),
    };

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function renderBadges(info) {
      const parts = [];
      if (info.imdb) parts.push(`<span class="badge imdb"><b>IMDb</b> ${escapeHtml(info.imdb)}</span>`);
      if (info.quality) parts.push(`<span class="badge">${escapeHtml(info.quality)}</span>`);
      if (info.year) parts.push(`<span class="badge">${escapeHtml(info.year)}</span>`);
      if (info.country) parts.push(`<span class="badge">${escapeHtml(info.country)}</span>`);
      if (info.kind) {
        const k = info.kind === "movie" ? "Phim Lẻ" : info.kind === "series" ? "Phim Bộ" : "Anime";
        parts.push(`<span class="badge">${escapeHtml(k)}</span>`);
      }
      el.badges.innerHTML = parts.join("");
    }

    function renderGenres(arr) {
      const gs = Array.isArray(arr) ? arr.filter(Boolean).slice(0, 12) : [];
      el.genres.innerHTML = gs.map(g => `<span class="genre">${escapeHtml(g)}</span>`).join("");
    }

    async function fetchMovieByDriveId(driveId) {
      if (!supabase) return null;
      try {
        const { data, error } = await supabase
          .from("movies")
          .select("title,kind,year,quality,desc,genres,country")
          .eq("driveid", driveId)
          .order("updatedat", { ascending: false })
          .limit(1);

        if (error) return null;
        const row = (data || [])[0];
        return row || null;
      } catch {
        return null;
      }
    }

    function applySearchKeyword(q) {
      const s = (q || "").trim();
      if (!s) return;
      location.href = `list.html?q=${encodeURIComponent(s)}`;
    }

    (async () => {
      const params = new URLSearchParams(location.search);
      const drive = params.get("drive") || params.get("m") || "";
      const titleQ = params.get("title") || "Xem phim";

      // search input: enter to go list
      el.q.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter") applySearchKeyword(el.q.value);
      });

      const r = DriveTool.normalize(drive);

      if (!r.ok) {
        el.title.textContent = "Link Drive không hợp lệ";
        el.subtitle.textContent = "Vui lòng kiểm tra lại đường dẫn.";
        el.fileId.textContent = "ID: —";
        el.frame.src = "";
        el.openDrive.href = "index.html";
        renderBadges({ quality: "—" });
        renderGenres([]);
        el.desc.textContent = "";
        return;
      }

      el.fileId.textContent = "ID: " + r.id;
      el.frame.src = r.links.preview;
      el.openDrive.href = r.links.view;

      // default UI
      el.title.textContent = titleQ;
      el.subtitle.textContent = "Đang tải thông tin…";
      renderBadges({ quality: "FHD" });
      renderGenres([]);
      el.desc.textContent = "";

      const info = await fetchMovieByDriveId(r.id);
      if (info) {
        const t = info.title || titleQ;
        el.title.textContent = t;
        el.subtitle.textContent = info.kind === "movie" ? "Phim Lẻ" : info.kind === "series" ? "Phim Bộ" : "Anime";
        renderBadges(info);
        renderGenres(info.genres);
        el.desc.textContent = info.desc || "";
        document.title = t + " - Khoii";
      } else {
        el.subtitle.textContent = "Không tìm thấy dữ liệu phim trong kho (vẫn có thể xem nếu Drive hợp lệ).";
        document.title = titleQ + " - Khoii";
      }
    })();
  </script>
</body>

</html>
