<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="description" content="Khoii – Trang xem phim. Mở nhanh, xem mượt." />
  <meta name="robots" content="index,follow" />
  <meta name="theme-color" content="#0b1224" />
  <title>Khoii - Xem phim</title>

  <style>
    :root {
      --bg0: #0b0f17;
      --bg1: #0b1224;
      --text: #e7edf9;
      --muted: rgba(231, 237, 249, .72);
      --line: rgba(255, 255, 255, .10);
      --line2: rgba(255, 255, 255, .16);
      --glass: rgba(18, 24, 36, .72);
      --glass2: rgba(18, 24, 36, .55);
      --accent: #f2c64f;
      --radius: 22px;
      --shadow: 0 18px 65px rgba(0, 0, 0, .55);
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(1200px 500px at 20% -10%, rgba(99, 102, 241, .18), transparent 55%),
        radial-gradient(900px 420px at 85% 10%, rgba(245, 158, 11, .10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x: hidden;
      padding-bottom: env(safe-area-inset-bottom);
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      background-image:
        radial-gradient(circle, rgba(255, 255, 255, .22) 1px, transparent 1.2px),
        radial-gradient(circle, rgba(255, 255, 255, .14) 1px, transparent 1.25px);
      background-size: 7px 7px, 14px 14px;
      background-position: 0 0, 3px 3px;
      opacity: .10;
      mix-blend-mode: overlay;
      filter: blur(.15px);
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 1320px;
      margin: 0 auto;
      padding: 18px 22px calc(40px + env(safe-area-inset-bottom));
    }

    @media (max-width: 560px) {
      .container {
        padding: 14px 12px calc(28px + env(safe-area-inset-bottom));
      }
    }

    .topbar {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 170px;
      cursor: pointer
    }

    .brand-logo {
      width: 44px;
      height: 34px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      font-weight: 900;
      letter-spacing: .6px;
      color: #0b1224;
      background:
        radial-gradient(18px 18px at 30% 35%, rgba(255, 255, 255, .22), transparent 60%),
        linear-gradient(135deg, #f59e0b, #fb7185);
      box-shadow: 0 10px 25px rgba(245, 158, 11, .22);
      position: relative;
      overflow: hidden;
      user-select: none;
    }

    .brand-logo:before {
      content: "";
      position: absolute;
      inset: 0;
      background: conic-gradient(from 220deg, rgba(0, 0, 0, .35), transparent 40%, rgba(0, 0, 0, .28));
      mix-blend-mode: overlay;
    }

    .brand-logo span {
      position: relative;
      z-index: 1
    }

    .brand-name {
      font-weight: 900;
      letter-spacing: .3px;
      font-size: 18px;
      line-height: 1.1
    }

    .brand-sub {
      font-size: 11px;
      color: rgba(231, 237, 249, .55);
      margin-top: 2px
    }

    .search {
      flex: 1;
      max-width: 620px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 12px;
      background: var(--glass);
      border: 1px solid rgba(255, 255, 255, .12);
      box-shadow: 0 10px 30px rgba(0, 0, 0, .30);
      backdrop-filter: blur(14px);
    }

    .search input {
      width: 100%;
      border: 0;
      outline: 0;
      background: transparent;
      color: var(--text);
      font-size: 14px;
    }

    .search input::placeholder {
      color: rgba(231, 237, 249, .50)
    }

    .nav {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-left: 6px
    }

    .nav a {
      color: rgba(231, 237, 249, .88);
      text-decoration: none;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 10px;
      border-radius: 10px;
    }

    .nav a:hover {
      background: rgba(255, 255, 255, .06)
    }

    .member-btn {
      margin-left: auto;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: var(--glass2);
      color: var(--text);
      cursor: pointer;
      backdrop-filter: blur(14px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, .24);
    }

    .member-btn:hover {
      border-color: var(--line2)
    }

    .member-btn svg {
      opacity: .95
    }

    .grid {
      margin-top: 18px;
      display: grid;
      grid-template-columns: minmax(0, 1fr) 340px;
      gap: 18px;
      align-items: start;
    }

    @media (max-width:1100px) {
      .grid {
        grid-template-columns: minmax(0, 1fr) 300px;
      }
    }

    @media (max-width:980px) {
      .nav {
        display: none
      }

      .member-btn span {
        display: none
      }

      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(10, 14, 22, .55);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
    }

    .player-wrap {
      position: relative;
      width: 100%;
      background: #000;
      overflow: hidden;
    }

    .player-wrap::before {
      content: "";
      display: block;
      padding-top: 56.25%;
    }

    .player-wrap iframe,
    .player-wrap video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0;
      background: #000;
    }

    /* ✅ chặn click nhầm icon “mở drive” trong iframe bằng lớp nút của mình */
    .player-actions {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 6;
      display: flex;
      gap: 10px;
      align-items: center;
      pointer-events: auto;
    }

    .pbtn {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .14);
      background: rgba(10, 14, 22, .60);
      color: rgba(231, 237, 249, .95);
      cursor: pointer;
      display: grid;
      place-items: center;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 24px rgba(0, 0, 0, .28);
    }

    .pbtn:hover {
      border-color: rgba(255, 255, 255, .22);
      background: rgba(255, 255, 255, .08);
    }

    .pbtn svg {
      width: 20px;
      height: 20px;
      opacity: .95;
    }

    .iab-notice {
      position: absolute;
      left: 10px;
      right: 10px;
      bottom: 10px;
      z-index: 6;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(10, 14, 22, .78);
      backdrop-filter: blur(12px);
      box-shadow: 0 16px 40px rgba(0, 0, 0, .35);
    }

    .iab-title {
      font-weight: 900;
      letter-spacing: .2px;
      margin-bottom: 6px;
    }

    .iab-text {
      color: rgba(231, 237, 249, .78);
      font-size: 13px;
      line-height: 1.45;
    }

    .iab-actions {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .iab-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, .14);
      background: rgba(255, 255, 255, .06);
      color: rgba(231, 237, 249, .92);
      cursor: pointer;
      user-select: none;
      font-weight: 800;
      font-size: 13px;
      white-space: nowrap;
    }

    .iab-btn:hover {
      background: rgba(255, 255, 255, .10);
    }

    .iab-btn.primary {
      border-color: rgba(242, 198, 79, .35);
      background: rgba(242, 198, 79, .14);
      color: rgba(242, 198, 79, .98);
    }

    .player-overlay {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      background: linear-gradient(180deg, rgba(0, 0, 0, .25), rgba(0, 0, 0, .65));
      z-index: 5;
    }

    .spinner {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 3px solid rgba(255, 255, 255, .22);
      border-top-color: rgba(255, 255, 255, .85);
      animation: rot 1s linear infinite
    }

    @keyframes rot {
      to {
        transform: rotate(360deg)
      }
    }

    .info {
      padding: 14px 14px 16px;
      border-top: 1px solid rgba(255, 255, 255, .08);
      display: grid;
      grid-template-columns: 120px minmax(0, 1fr);
      gap: 14px;
    }

    @media (max-width:560px) {
      .info {
        grid-template-columns: 1fr;
      }
    }

    .poster {
      width: 120px;
      aspect-ratio: 2/3;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .14);
      background: rgba(255, 255, 255, .06);
      overflow: hidden;
      box-shadow: 0 14px 40px rgba(0, 0, 0, .35);
    }

    .poster img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block
    }

    .h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: .2px;
      font-weight: 900
    }

    .sub {
      margin-top: 6px;
      color: var(--muted);
      font-size: 13px;
    }

    .badges {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(18, 24, 36, .45);
      color: rgba(231, 237, 249, .92);
      font-size: 13px;
      backdrop-filter: blur(10px);
    }

    .badge.imdb {
      border-color: rgba(242, 198, 79, .75);
      background: rgba(242, 198, 79, .10);
    }

    .badge b {
      font-size: 11px;
      letter-spacing: .6px;
      opacity: .9
    }

    .genres {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .genre {
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(18, 24, 36, .40);
      color: rgba(231, 237, 249, .88);
      font-size: 13px;
      backdrop-filter: blur(10px);
    }

    .desc {
      margin: 12px 0 0;
      color: rgba(231, 237, 249, .80);
      font-size: 14px;
      line-height: 1.55;
      max-width: 90ch;
    }

    .actions {
      margin-top: 12px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 9px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(255, 255, 255, .06);
      color: rgba(231, 237, 249, .92);
      cursor: pointer;
      user-select: none;
    }

    .btn:hover {
      background: rgba(255, 255, 255, .10);
    }

    a {
      color: var(--accent);
      text-decoration: none
    }

    a:hover {
      text-decoration: underline
    }

    .episodes {
      margin-top: 14px;
      padding: 14px;
      border-top: 1px solid rgba(255, 255, 255, .08);
    }

    .episodes-head {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .episodes-title {
      font-weight: 900;
      letter-spacing: .2px
    }

    .server-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .server-label {
      color: var(--muted);
      font-size: 13px;
      font-weight: 700;
      margin-right: 6px
    }

    .server-pill {
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(18, 24, 36, .45);
      color: rgba(231, 237, 249, .90);
      font-size: 13px;
      cursor: pointer;
    }

    .server-pill.active {
      border-color: rgba(242, 198, 79, .35);
      background: rgba(242, 198, 79, .10);
      color: rgba(242, 198, 79, .98);
    }

    .ep-grid {
      margin-top: 12px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .ep {
      min-width: 108px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(18, 24, 36, .35);
      color: rgba(231, 237, 249, .90);
      font-size: 14px;
      text-align: center;
      cursor: pointer;
      user-select: none;
    }

    .ep:hover {
      background: rgba(255, 255, 255, .08);
    }

    .ep.active {
      border-color: rgba(242, 198, 79, .40);
      background: rgba(242, 198, 79, .14);
      color: rgba(242, 198, 79, .98);
      font-weight: 800;
    }

    .sidebar .head {
      padding: 14px 14px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 255, 255, .08);
    }

    .sidebar .head b {
      font-size: 18px;
      letter-spacing: .2px
    }

    .sug-list {
      padding: 10px 10px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .sug {
      display: grid;
      grid-template-columns: 54px minmax(0, 1fr);
      gap: 10px;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .05);
      cursor: pointer;
    }

    .sug:hover {
      background: rgba(255, 255, 255, .08);
    }

    .sug .thumb {
      width: 54px;
      aspect-ratio: 2/3;
      border-radius: 10px;
      overflow: hidden;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .10);
    }

    .sug img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block
    }

    .sug .t {
      font-weight: 850;
      font-size: 14px;
      line-height: 1.2;
      margin-top: 2px
    }

    .sug .m {
      color: var(--muted);
      font-size: 12px;
      margin-top: 6px
    }

    .empty {
      color: var(--muted);
      font-size: 13px;
      padding: 14px;
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="topbar">
      <div class="brand" onclick="location.href='index.html'">
        <div class="brand-logo" aria-hidden="true"><span>K</span></div>
        <div>
          <div class="brand-name">Khoii</div>
          <div class="brand-sub">Xem phim</div>
        </div>
      </div>

      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M10.5 19a8.5 8.5 0 1 1 0-17 8.5 8.5 0 0 1 0 17Z" stroke="rgba(231,237,249,.85)" stroke-width="2" />
          <path d="M16.8 16.8 21 21" stroke="rgba(231,237,249,.85)" stroke-width="2" stroke-linecap="round" />
        </svg>
        <input id="q" placeholder="Tìm kiếm phim, diễn viên" />
      </div>

      <nav class="nav" aria-label="Main navigation">
        <a href="list.html">Thể loại</a>
        <a href="list.html?kind=movie">Phim Lẻ</a>
        <a href="list.html?kind=series">Phim Bộ</a>
        <a href="list.html">Quốc gia</a>
      </nav>

      <button class="member-btn" onclick="location.href='test.html'">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 12a4.5 4.5 0 1 0-4.5-4.5A4.5 4.5 0 0 0 12 12Z" stroke="rgba(231,237,249,.9)" stroke-width="2" />
          <path d="M20 21a8 8.0 0 1 0-16 0" stroke="rgba(231,237,249,.9)" stroke-width="2" stroke-linecap="round" />
        </svg>
        <span>Thành viên</span>
      </button>
    </header>

    <div class="grid">
      <main class="card">
        <div class="player-wrap">
          <div class="player-overlay" id="loading">
            <div style="display:flex;align-items:center;gap:10px">
              <div class="spinner"></div>
              <div style="color:rgba(231,237,249,.88);font-weight:800" id="loadingText">Đang tải player…</div>
            </div>
          </div>

          <!-- ✅ Action overlay: chặn click nhầm icon Drive + cho nút riêng -->
          <div class="player-actions" aria-label="Player actions">
            <button class="pbtn" id="btnOpenDrive" type="button" title="Mở Google Drive">
              <!-- external-link icon -->
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M14 5h5v5" stroke="rgba(231,237,249,.92)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M10 14 19 5" stroke="rgba(231,237,249,.92)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M19 14v5a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h5" stroke="rgba(231,237,249,.72)" stroke-width="2" stroke-linecap="round" />
              </svg>
            </button>

            <button class="pbtn" id="btnFullscreen" type="button" title="Toàn màn hình">
              <!-- fullscreen icon -->
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M9 4H5v4" stroke="rgba(231,237,249,.92)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M15 4h4v4" stroke="rgba(231,237,249,.92)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M9 20H5v-4" stroke="rgba(231,237,249,.92)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M15 20h4v-4" stroke="rgba(231,237,249,.92)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            </button>
          </div>

          <!-- ✅ Notice cho in-app browser (Messenger/FB/Instagram/...) -->
          <div class="iab-notice" id="iabNotice" hidden>
            <div class="iab-title">Đang mở trong trình duyệt của app</div>
            <div class="iab-text">
              Trình duyệt trong Messenger/Facebook/Instagram thường chặn phát video Google Drive.
              Nếu video không chạy, hãy bấm <b>Mở bằng trình duyệt</b> hoặc <b>Mở Drive</b>.
            </div>
            <div class="iab-actions">
              <button class="iab-btn primary" id="btnOpenBrowser" type="button">Mở bằng trình duyệt</button>
              <button class="iab-btn" id="btnOpenDrive2" type="button">Mở Drive</button>
            </div>
          </div>

          <!-- ✅ Player 2: Direct video (thử cho in-app browser) -->
          <video id="video" playsinline controls style="display:none"></video>

          <!-- Player 1: Google Drive preview -->
          <iframe id="frame" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>
        </div>

        <section class="info">
          <div class="poster" id="posterBox" aria-label="Poster">
            <img id="posterImg" alt="" style="display:none" />
          </div>

          <div>
            <h1 class="h1" id="title">Đang tải…</h1>
            <div class="sub" id="subtitle">—</div>

            <div class="badges" id="badges" aria-label="Thông tin nhanh"></div>
            <div class="genres" id="genres" aria-label="Thể loại"></div>
            <p class="desc" id="desc"></p>

            <div class="actions">
              <div class="btn" id="btnLike">♥ Yêu thích</div>
              <div class="btn" id="btnEpisodes">Chuyển tập</div>
              <a class="btn" href="index.html">← Quay lại</a>
            </div>
          </div>
        </section>

        <section class="episodes" id="episodesSection">
          <div class="episodes-head">
            <div class="episodes-title">Server</div>
            <div style="color:var(--muted);font-size:13px">Chọn tập để xem</div>
          </div>
          <div class="server-row">
            <span class="server-label">Server</span>
            <span class="server-pill active" title="Google Drive">Khoilolo</span>
          </div>

          <div class="episodes-head" style="margin-top:12px">
            <div class="episodes-title">Tập phim</div>
            <div style="color:var(--muted);font-size:13px" id="epHint"></div>
          </div>
          <div class="ep-grid" id="epGrid"></div>
        </section>
      </main>

      <aside class="card sidebar">
        <div class="head">
          <b>Đề xuất</b>
          <a href="index.html" style="font-size:13px;color:var(--muted)">Xem tất cả</a>
        </div>
        <div class="sug-list" id="sugList">
          <div class="empty">Đang tải…</div>
        </div>
      </aside>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://nzalaxolteaiafvuceqz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56YWxheG9sdGVhaWFmdnVjZXF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTY2MjAsImV4cCI6MjA4NTg3MjYyMH0.0eIz6cfB4Dr_g5Wja70tZCMvVfUKoI5H4D8MJBP49Bg";

    const sb = window.supabase?.createClient
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    // ===== Level 2: ẩn driveId khỏi URL (lưu tạm sessionStorage) =====
    const SESSION_DRIVE_KEY = "khoii_watch_drive_v1";
    function setCurrentDriveId(id) {
      try { sessionStorage.setItem(SESSION_DRIVE_KEY, String(id || "")); } catch { }
    }
    function getCurrentDriveId() {
      try { return sessionStorage.getItem(SESSION_DRIVE_KEY) || ""; } catch { return ""; }
    }

    // ✅ goWatch: giữ drive trong sessionStorage, URL khác nhau theo ep/season để chắc chắn reload
    window.goWatch = function (driveId, title, ep, season) {
      const id = String(driveId || "").trim();
      if (id) setCurrentDriveId(id);

      const t = String(title || "").trim();
      const p = new URLSearchParams();
      if (t) p.set("title", t);

      if (season !== undefined && season !== null && season !== "") p.set("season", String(season));
      if (ep !== undefined && ep !== null && ep !== "") p.set("ep", String(ep));

      location.href = "watch.html" + (p.toString() ? "?" + p.toString() : "");
    };

    function detectEnv() {
      const ua = navigator.userAgent || "";
      const isAndroid = /Android/i.test(ua);
      const isIOS = /iPhone|iPad|iPod/i.test(ua);
      // FB/Messenger/Instagram in-app browser
      const isIAB =
        /FBAN|FBAV|FB_IAB|FBIOS|FB4A|Instagram|Messenger|Line\/|Zalo|TikTok|Snapchat|Twitter/i.test(ua);
      return { ua, isAndroid, isIOS, isIAB };
    }

    function openExternalUrl(url) {
      const env = detectEnv();
      const safeUrl = String(url || "").trim();
      if (!safeUrl) return;

      // Android: cố gắng mở Chrome bằng intent
      if (env.isAndroid) {
        try {
          const u = new URL(safeUrl);
          const intent = `intent://${u.host}${u.pathname}${u.search}#Intent;scheme=${u.protocol.replace(":", "")};package=com.android.chrome;end`;
          location.href = intent;
          setTimeout(() => { window.open(safeUrl, "_blank"); }, 450);
          return;
        } catch { }
      }

      // iOS: thử mở Chrome nếu có (nếu không có thì user vẫn có thể bấm “Open in Safari” trong menu)
      if (env.isIOS) {
        try {
          const u = new URL(safeUrl);
          const scheme = (u.protocol === "https:") ? "googlechromes://" : "googlechrome://";
          const chromeUrl = scheme + u.host + u.pathname + u.search + u.hash;
          location.href = chromeUrl;
          setTimeout(() => { window.open(safeUrl, "_blank"); }, 450);
          return;
        } catch { }
      }

      window.open(safeUrl, "_blank");
    }

    const DriveTool = (() => {
      const patterns = [
        /drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]{10,})/i,
        /drive\.google\.com\/open\?id=([a-zA-Z0-9_-]{10,})/i,
        /drive\.google\.com\/uc\?id=([a-zA-Z0-9_-]{10,})/i,
        /drive\.google\.com\/uc\?export=download&id=([a-zA-Z0-9_-]{10,})/i,
      ];
      function extractId(input) {
        const s = String(input || "").trim();
        if (/^[a-zA-Z0-9_-]{10,}$/.test(s)) return s;
        try {
          const u = new URL(s);
          const qid = u.searchParams.get("id");
          if (qid && /^[a-zA-Z0-9_-]{10,}$/.test(qid)) return qid;
        } catch { }
        for (const re of patterns) {
          const m = s.match(re);
          if (m && m[1]) return m[1];
        }
        return null;
      }
      function links(id) {
        const enc = encodeURIComponent(id);
        return {
          id,
          preview: `https://drive.google.com/file/d/${enc}/preview`,
          view: `https://drive.google.com/file/d/${enc}/view`,
          // ✅ thử direct stream (hay dùng để “cứu” in-app browser)
          download: `https://drive.google.com/uc?export=download&id=${enc}`,
        };
      }
      function normalize(input) {
        const id = extractId(input);
        if (!id) return { ok: false, error: "Không tách được ID.", id: null, links: null };
        return { ok: true, id, links: links(id) };
      }
      return { normalize };
    })();

    const el = {
      q: document.getElementById("q"),
      title: document.getElementById("title"),
      subtitle: document.getElementById("subtitle"),
      badges: document.getElementById("badges"),
      genres: document.getElementById("genres"),
      desc: document.getElementById("desc"),
      frame: document.getElementById("frame"),
      video: document.getElementById("video"),
      loading: document.getElementById("loading"),
      loadingText: document.getElementById("loadingText"),
      posterBox: document.getElementById("posterBox"),
      posterImg: document.getElementById("posterImg"),
      epGrid: document.getElementById("epGrid"),
      epHint: document.getElementById("epHint"),
      btnEpisodes: document.getElementById("btnEpisodes"),
      sugList: document.getElementById("sugList"),
      btnLike: document.getElementById("btnLike"),

      btnOpenDrive: document.getElementById("btnOpenDrive"),
      btnFullscreen: document.getElementById("btnFullscreen"),
      iabNotice: document.getElementById("iabNotice"),
      btnOpenBrowser: document.getElementById("btnOpenBrowser"),
      btnOpenDrive2: document.getElementById("btnOpenDrive2"),
    };

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;").replaceAll("'", "&#039;");
    }

    function showLoading(text = "Đang tải player…") {
      if (el.loadingText) el.loadingText.textContent = text;
      el.loading.style.display = "grid";
    }

    function hideLoading() {
      el.loading.style.display = "none";
    }

    function renderBadges(info) {
      const parts = [];
      if (info.imdb) parts.push(`<span class="badge imdb"><b>IMDb</b> ${escapeHtml(info.imdb)}</span>`);
      if (info.quality) parts.push(`<span class="badge">${escapeHtml(info.quality)}</span>`);
      if (info.year) parts.push(`<span class="badge">${escapeHtml(info.year)}</span>`);
      if (info.country) parts.push(`<span class="badge">${escapeHtml(info.country)}</span>`);
      if (info.kind) {
        const k = info.kind === "movie" ? "Phim Lẻ" : info.kind === "series" ? "Phim Bộ" : "Anime";
        parts.push(`<span class="badge">${escapeHtml(k)}</span>`);
      }
      el.badges.innerHTML = parts.join("");
    }

    function renderGenres(arr) {
      const gs = Array.isArray(arr) ? arr.filter(Boolean).slice(0, 16) : [];
      el.genres.innerHTML = gs.map(g => `<span class="genre">${escapeHtml(g)}</span>`).join("");
    }

    function setPoster(url) {
      const u = String(url || "").trim();
      if (!u) {
        el.posterImg.style.display = "none";
        el.posterBox.style.background = "rgba(255,255,255,.06)";
        return;
      }
      el.posterImg.src = u;
      el.posterImg.alt = "Poster";
      el.posterImg.style.display = "block";
    }

    function applySearchKeyword(q) {
      const s = (q || "").trim();
      if (!s) return;
      location.href = `list.html?q=${encodeURIComponent(s)}`;
    }

    // fallback nếu bạn quên nhập ep trong DB (khuyên: luôn nhập ep)
    function inferEpNumber(row, idx) {
      const s = `${row?.drivelink || ""} ${row?.title || ""}`.toLowerCase();
      const pats = [
        /tập\s*(\d{1,3})/,
        /\bep\s*(\d{1,3})/,
        /\bepisode\s*(\d{1,3})/,
        /[-_ ](\d{1,3})(?=\D|$)/,
      ];
      for (const re of pats) {
        const m = s.match(re);
        if (m && m[1]) {
          const n = parseInt(m[1], 10);
          if (Number.isFinite(n) && n > 0 && n < 1000) return n;
        }
      }
      return idx + 1;
    }

    function pad2(n) { return String(n).padStart(2, "0"); }

    async function fetchMovieByDriveId(driveId) {
      if (!sb) return null;
      try {
        const { data, error } = await sb
          .from("movies")
          .select("id,title,kind,year,quality,desc,genres,country,imdb,posterurl,herourl,driveid,drivelink,updatedat,created_at,ep,eps,season")
          .eq("driveid", driveId)
          .limit(1);
        if (error) return null;
        return (data || [])[0] || null;
      } catch { return null; }
    }

    async function fetchMovieByTitleEp(title, season, ep) {
      if (!sb || !title || !season || !ep) return null;
      try {
        const { data, error } = await sb
          .from("movies")
          .select("id,title,kind,year,quality,desc,genres,country,imdb,posterurl,herourl,driveid,drivelink,updatedat,created_at,ep,eps,season")
          .eq("title", title)
          .eq("season", season)
          .eq("ep", ep)
          .limit(1);

        if (error) return null;
        return (data || [])[0] || null;
      } catch { return null; }
    }

    // ✅ fallback cho phim lẻ: nếu URL chỉ có title mà không có drive (vì bạn đã replaceState)
    async function fetchLatestByTitle(title) {
      if (!sb || !title) return null;
      try {
        const { data, error } = await sb
          .from("movies")
          .select("id,title,kind,year,quality,desc,genres,country,imdb,posterurl,herourl,driveid,drivelink,updatedat,created_at,ep,eps,season")
          .eq("title", title)
          .order("updatedat", { ascending: false, nullsFirst: false })
          .order("created_at", { ascending: false })
          .limit(1);

        if (error) return null;
        return (data || [])[0] || null;
      } catch { return null; }
    }

    async function fetchEpisodesByTitle(seriesTitle, kind) {
      if (!sb || !seriesTitle) return [];
      try {
        let q = sb
          .from("movies")
          .select("id,title,kind,driveid,drivelink,updatedat,created_at,ep,eps,season")
          .eq("title", seriesTitle);

        if (kind) q = q.eq("kind", kind);

        const { data, error } = await q
          .order("season", { ascending: true, nullsFirst: true })
          .order("ep", { ascending: true, nullsFirst: true })
          .order("created_at", { ascending: true })
          .limit(200);

        if (error) return [];

        const rows = Array.isArray(data) ? data : [];
        return rows.map((r, i) => ({
          ...r,
          _season: Number.isFinite(r.season) ? r.season : 1,
          _ep: Number.isFinite(r.ep) ? r.ep : inferEpNumber(r, i),
          _eps: Number.isFinite(r.eps) ? r.eps : null,
        }));
      } catch { return []; }
    }

    async function fetchSuggestions(excludeDriveId) {
      if (!sb) return [];
      try {
        let q = sb.from("movies")
          .select("title,kind,year,posterurl,driveid,updatedat,created_at")
          .limit(12);

        q = q.order("updatedat", { ascending: false, nullsFirst: false }).order("created_at", { ascending: false });

        const { data, error } = await q;
        if (error) return [];
        return (data || []).filter(x => x.driveid !== excludeDriveId).slice(0, 8);
      } catch { return []; }
    }

    function renderSuggestions(items) {
      if (!items || items.length === 0) {
        el.sugList.innerHTML = `<div class="empty">Chưa có đề xuất.</div>`;
        return;
      }
      el.sugList.innerHTML = items.map(it => {
        const k = it.kind === "movie" ? "Phim Lẻ" : it.kind === "series" ? "Phim Bộ" : "Anime";
        const meta = [k, it.year].filter(Boolean).join(" • ");
        const poster = it.posterurl || "";

        const did = JSON.stringify(it.driveid || "");
        const ttl = JSON.stringify(it.title || "");

        return `
          <div class="sug" onclick="goWatch(${did}, ${ttl}, 1, 1)">
            <div class="thumb">${poster ? `<img src="${escapeHtml(poster)}" alt="">` : ""}</div>
            <div>
              <div class="t">${escapeHtml(it.title || "—")}</div>
              <div class="m">${escapeHtml(meta)}</div>
            </div>
          </div>
        `;
      }).join("");
    }

    function renderEpisodes(list, currentDriveId, seriesTitle, currentEp, currentSeason) {
      if (!Array.isArray(list) || list.length === 0) {
        el.epHint.textContent = "Chưa có danh sách tập.";
        el.epGrid.innerHTML = `<div class="empty" style="padding:0">Không có tập.</div>`;
        return;
      }

      el.epHint.textContent = `${list.length} tập`;
      el.epGrid.innerHTML = list.map((r, i) => {
        const ep = r._ep || (i + 1);
        const season = r._season || 1;

        const active =
          (currentEp && currentSeason && ep === currentEp && season === currentSeason) ||
          (r.driveid === currentDriveId)
            ? "active"
            : "";

        const t = `Tập ${pad2(ep)}`;

        const did = JSON.stringify(r.driveid || "");
        const ttl = JSON.stringify(seriesTitle || "");
        const epJs = JSON.stringify(ep);
        const ssJs = JSON.stringify(season);

        return `<div class="ep ${active}" onclick="goWatch(${did}, ${ttl}, ${epJs}, ${ssJs})">${escapeHtml(t)}</div>`;
      }).join("");
    }

    // ===== Player mode handling =====
    const env = detectEnv();
    const playerMode = env.isIAB ? "video" : "iframe"; // ✅ in-app: thử video direct

    let currentLinks = null;
    let currentDriveId = "";
    let currentTitle = "";
    let currentEp = null;
    let currentSeason = 1;

    function setPlayerLinks(links) {
      currentLinks = links;
    }

    function setPlayerByDriveId(driveId) {
      const rr = DriveTool.normalize(driveId);
      if (!rr.ok) return false;

      currentDriveId = rr.id;
      setPlayerLinks(rr.links);

      // nút mở drive dùng view
      // (bị block popup thì vẫn ok vì click user)
      // player:
      showLoading(playerMode === "video" ? "Đang tải video (Direct)..." : "Đang tải player…");

      if (playerMode === "video") {
        el.frame.style.display = "none";
        el.video.style.display = "block";

        // reset video
        try {
          el.video.pause();
        } catch { }
        el.video.removeAttribute("src");

        // set src direct
        el.video.src = rr.links.download;
        el.video.load();

        // nếu play được thì hide loading ở event
        setTimeout(() => hideLoading(), 6500);
      } else {
        // iframe preview
        el.video.style.display = "none";
        el.frame.style.display = "block";
        el.frame.src = rr.links.preview;

        setTimeout(() => hideLoading(), 6500);
      }

      // lưu session
      setCurrentDriveId(rr.id);
      return true;
    }

    function openDrive() {
      if (!currentLinks?.view) return;
      window.open(currentLinks.view, "_blank", "noopener");
    }

    async function toggleFullscreen() {
      // Fullscreen API (nếu không hỗ trợ thì mở Drive)
      const wrap = document.querySelector(".player-wrap");
      try {
        if (!document.fullscreenElement) {
          if (wrap?.requestFullscreen) await wrap.requestFullscreen();
          else if (wrap?.webkitRequestFullscreen) wrap.webkitRequestFullscreen();
          else openDrive();
        } else {
          if (document.exitFullscreen) await document.exitFullscreen();
          else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        }
      } catch {
        openDrive();
      }
    }

    function showIabNotice() {
      // chỉ show khi là in-app (hoặc khi video lỗi)
      if (env.isIAB && el.iabNotice) el.iabNotice.hidden = false;
    }

    function hideIabNotice() {
      if (el.iabNotice) el.iabNotice.hidden = true;
    }

    function buildOpenBrowserUrl() {
      const url = new URL(location.href);
      url.search = "";
      url.hash = "";
      const p = url.searchParams;

      // ✅ để chắc chắn mở được ở browser ngoài: nhét drive vào (bên ngoài vào trang thì code sẽ tự replaceState lại)
      if (currentDriveId) p.set("drive", currentDriveId);
      if (currentTitle) p.set("title", currentTitle);
      if (currentSeason) p.set("season", String(currentSeason));
      if (currentEp) p.set("ep", String(currentEp));

      return url.toString();
    }

    // events
    el.frame.addEventListener("load", () => hideLoading());
    el.video.addEventListener("canplay", () => {
      hideLoading();
      // nếu direct play ok thì có thể ẩn notice cho gọn
      // nhưng giữ lại vì Messenger vẫn hay lỗi ngẫu nhiên
    });
    el.video.addEventListener("error", () => {
      hideLoading();
      showIabNotice();
    });

    el.btnOpenDrive?.addEventListener("click", openDrive);
    el.btnOpenDrive2?.addEventListener("click", openDrive);
    el.btnFullscreen?.addEventListener("click", toggleFullscreen);

    el.btnOpenBrowser?.addEventListener("click", () => {
      const u = buildOpenBrowserUrl();
      openExternalUrl(u);
    });

    (async () => {
      el.q.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter") applySearchKeyword(el.q.value);
      });

      document.getElementById("btnEpisodes")?.addEventListener("click", () => {
        document.getElementById("episodesSection")?.scrollIntoView({ behavior: "smooth", block: "start" });
      });

      el.btnLike?.addEventListener("click", () => {
        alert("Đã thêm vào yêu thích (demo).");
      });

      if (env.isIAB) showIabNotice();

      const params = new URLSearchParams(location.search);
      const titleQ = (params.get("title") || "Xem phim").trim();
      let epWanted = Number(params.get("ep") || "") || null;
      let seasonWanted = Number(params.get("season") || "") || 1;

      const driveParam = params.get("drive") || params.get("m") || "";
      let driveCandidate = driveParam || getCurrentDriveId();

      // ✅ nếu không có drive, thử tìm theo title+season+ep (phim bộ)
      if (!driveCandidate && titleQ && epWanted) {
        const row = await fetchMovieByTitleEp(titleQ, seasonWanted, epWanted);
        if (row?.driveid) driveCandidate = row.driveid;
      }

      // ✅ nếu vẫn không có drive (phim lẻ / hoặc link share bị clean), thử tìm theo title (lấy record mới nhất)
      if (!driveCandidate && titleQ) {
        const row = await fetchLatestByTitle(titleQ);
        if (row?.driveid) {
          driveCandidate = row.driveid;
          // nếu phim bộ mà thiếu epWanted -> default ep 1
          if (!epWanted && (row.kind === "anime" || row.kind === "series")) {
            seasonWanted = Number(row.season || seasonWanted || 1) || 1;
            epWanted = Number(row.ep || 1) || 1;
          }
        }
      }

      const r = DriveTool.normalize(driveCandidate);
      if (!r.ok) {
        el.title.textContent = "Không có phim để phát";
        el.subtitle.textContent = "Thiếu link/ID hoặc không hợp lệ.";
        hideLoading();
        el.frame.src = "";
        try { el.video.pause(); } catch { }
        el.video.style.display = "none";
        renderBadges({ quality: "—" });
        renderGenres([]);
        el.desc.textContent = "";
        renderSuggestions([]);
        renderEpisodes([], "", titleQ, epWanted, seasonWanted);
        return;
      }

      // lưu lại driveId
      setCurrentDriveId(r.id);

      // ✅ xóa drive khỏi URL, nhưng giữ title + ep + season
      currentTitle = titleQ || "";
      currentEp = epWanted;
      currentSeason = seasonWanted || 1;

      const cleanParams = new URLSearchParams();
      if (currentTitle) cleanParams.set("title", currentTitle);
      if (currentSeason) cleanParams.set("season", String(currentSeason));
      if (currentEp) cleanParams.set("ep", String(currentEp));
      history.replaceState({}, "", "watch.html" + (cleanParams.toString() ? "?" + cleanParams.toString() : ""));

      // Player
      setPlayerByDriveId(r.id);

      // Default UI
      el.title.textContent = titleQ;
      el.subtitle.textContent = "Đang tải thông tin…";
      renderBadges({ quality: "FHD", kind: "anime" });
      renderGenres([]);
      el.desc.textContent = "";
      setPoster("");

      // Movie info
      const info = await fetchMovieByDriveId(r.id);
      const seriesTitle = (info?.title || titleQ || "Xem phim").trim();
      currentTitle = seriesTitle;
      document.title = seriesTitle + " - Khoii";
      el.title.textContent = seriesTitle;

      if (info) {
        el.subtitle.textContent = info.kind === "movie" ? "Phim Lẻ" : info.kind === "series" ? "Phim Bộ" : "Anime";
        renderBadges(info);
        renderGenres(info.genres);
        el.desc.textContent = info.desc || "";
        setPoster(info.posterurl || "");
      } else {
        el.subtitle.textContent = "Không tìm thấy dữ liệu phim trong kho (vẫn xem được nếu Drive hợp lệ).";
      }

      // Episodes list
      const eps = await fetchEpisodesByTitle(seriesTitle, info?.kind || null);

      // nếu URL có epWanted thì ép player sang đúng driveid tập đó
      if (currentEp && eps.length) {
        const hit = eps.find(x => x._season === currentSeason && x._ep === currentEp);
        if (hit?.driveid && hit.driveid !== r.id) {
          setCurrentDriveId(hit.driveid);
          setPlayerByDriveId(hit.driveid);
        }
      }

      renderEpisodes(eps, getCurrentDriveId() || r.id, seriesTitle, currentEp, currentSeason);

      // Suggestions
      const sug = await fetchSuggestions(getCurrentDriveId() || r.id);
      renderSuggestions(sug);
    })();
  </script>
</body>

</html>
