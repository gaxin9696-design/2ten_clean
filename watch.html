<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Khoii – Trang xem phim. Mở nhanh, xem mượt." />
  <meta name="robots" content="index,follow" />
  <meta name="theme-color" content="#0b1224" />
  <title>Khoii - Xem phim</title>

  <style>
    :root {
      --bg0: #0b0f17;
      --bg1: #0b1224;
      --text: #e7edf9;
      --muted: rgba(231, 237, 249, .72);
      --line: rgba(255, 255, 255, .10);
      --line2: rgba(255, 255, 255, .16);
      --glass: rgba(18, 24, 36, .72);
      --glass2: rgba(18, 24, 36, .55);
      --accent: #f2c64f;
      --radius: 22px;
      --shadow: 0 18px 65px rgba(0, 0, 0, .55);
    }

    * { box-sizing: border-box }
    html, body { height: 100% }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(1200px 500px at 20% -10%, rgba(99, 102, 241, .18), transparent 55%),
        radial-gradient(900px 420px at 85% 10%, rgba(245, 158, 11, .10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      background-image:
        radial-gradient(circle, rgba(255, 255, 255, .22) 1px, transparent 1.2px),
        radial-gradient(circle, rgba(255, 255, 255, .14) 1px, transparent 1.25px);
      background-size: 7px 7px, 14px 14px;
      background-position: 0 0, 3px 3px;
      opacity: .10;
      mix-blend-mode: overlay;
      filter: blur(.15px);
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 1320px;
      margin: 0 auto;
      padding: 18px 22px 40px;
    }

    .topbar { display: flex; align-items: center; gap: 16px; }

    .brand {
      display: flex; align-items: center; gap: 10px;
      min-width: 170px; cursor: pointer
    }

    .brand-logo {
      width: 44px; height: 34px; border-radius: 10px;
      display: grid; place-items: center;
      font-weight: 900; letter-spacing: .6px; color: #0b1224;
      background:
        radial-gradient(18px 18px at 30% 35%, rgba(255, 255, 255, .22), transparent 60%),
        linear-gradient(135deg, #f59e0b, #fb7185);
      box-shadow: 0 10px 25px rgba(245, 158, 11, .22);
      position: relative; overflow: hidden; user-select: none;
    }
    .brand-logo:before {
      content: ""; position: absolute; inset: 0;
      background: conic-gradient(from 220deg, rgba(0, 0, 0, .35), transparent 40%, rgba(0, 0, 0, .28));
      mix-blend-mode: overlay;
    }
    .brand-logo span { position: relative; z-index: 1 }
    .brand-name { font-weight: 900; letter-spacing: .3px; font-size: 18px; line-height: 1.1 }
    .brand-sub { font-size: 11px; color: rgba(231, 237, 249, .55); margin-top: 2px }

    .search {
      flex: 1; max-width: 620px;
      display: flex; align-items: center; gap: 10px;
      padding: 10px 14px; border-radius: 12px;
      background: var(--glass);
      border: 1px solid rgba(255, 255, 255, .12);
      box-shadow: 0 10px 30px rgba(0, 0, 0, .30);
      backdrop-filter: blur(14px);
    }
    .search input {
      width: 100%; border: 0; outline: 0; background: transparent;
      color: var(--text); font-size: 14px;
    }
    .search input::placeholder { color: rgba(231, 237, 249, .50) }

    .nav { display: flex; align-items: center; gap: 14px; margin-left: 6px }
    .nav a {
      color: rgba(231, 237, 249, .88);
      text-decoration: none; font-size: 14px;
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 10px; border-radius: 10px;
    }
    .nav a:hover { background: rgba(255, 255, 255, .06) }

    .member-btn {
      margin-left: auto;
      display: inline-flex; align-items: center; gap: 10px;
      padding: 10px 14px; border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: var(--glass2);
      color: var(--text); cursor: pointer;
      backdrop-filter: blur(14px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, .24);
    }
    .member-btn:hover { border-color: var(--line2) }
    .member-btn svg { opacity: .95 }

    .grid {
      margin-top: 18px;
      display: grid;
      grid-template-columns: minmax(0, 1fr) 340px;
      gap: 18px;
      align-items: start;
    }
    @media (max-width:1100px) { .grid { grid-template-columns: minmax(0, 1fr) 300px; } }
    @media (max-width:980px) {
      .nav { display: none }
      .member-btn span { display: none }
      .grid { grid-template-columns: 1fr; }
    }

    .card {
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(10, 14, 22, .55);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
    }

    /* ✅ Video container: bo tròn cả 4 góc, đặc biệt 2 góc dưới */
    .player-wrap {
      position: relative;
      width: 100%;
      background: #000;
      overflow: hidden;

      /* bo tròn giống góc trên của card */
      border-top-left-radius: var(--radius);
      border-top-right-radius: var(--radius);

      /* ✅ bo tròn 2 góc dưới của khung video */
      border-bottom-left-radius: 18px;
      border-bottom-right-radius: 18px;
    }

    .player-wrap::before { content: ""; display: block; padding-top: 56.25%; }
    .player-wrap iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: 0; }

    .player-overlay {
      position: absolute; inset: 0;
      display: grid; place-items: center;
      background: linear-gradient(180deg, rgba(0, 0, 0, .25), rgba(0, 0, 0, .65));
      z-index: 2;
    }

    .spinner {
      width: 28px; height: 28px; border-radius: 999px;
      border: 3px solid rgba(255, 255, 255, .22);
      border-top-color: rgba(255, 255, 255, .85);
      animation: rot 1s linear infinite
    }
    @keyframes rot { to { transform: rotate(360deg) } }

    /* ✅ Mask che icon ↗ Drive: THU NHỎ + bo tròn nhẹ để không “ô đen” quá lộ */
    .drive-ui-mask{
      position:absolute;
      top:0; right:0;
      z-index:3;

      /* nhỏ hơn nhiều so với bản cũ */
      width: clamp(56px, 16vw, 84px);
      height: clamp(50px, 14vw, 76px);

      /* che kín icon */
      background: rgba(0,0,0,.96);

      border-bottom-left-radius: 16px;

      /* chặn bấm vào icon */
      pointer-events: auto;
    }

    /* Nếu bạn thấy icon vẫn lọt ra (một số máy), tăng nhẹ size ở đây */
    @media (max-width:560px){
      .drive-ui-mask{
        width: clamp(62px, 18vw, 92px);
        height: clamp(56px, 16vw, 84px);
        border-bottom-left-radius: 18px;
      }
    }

    .info {
      padding: 14px 14px 16px;
      border-top: 1px solid rgba(255, 255, 255, .08);
      display: grid;
      grid-template-columns: 120px minmax(0, 1fr);
      gap: 14px;
    }
    @media (max-width:560px) { .info { grid-template-columns: 1fr; } }

    .poster {
      width: 120px;
      aspect-ratio: 2/3;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .14);
      background: rgba(255, 255, 255, .06);
      overflow: hidden;
      box-shadow: 0 14px 40px rgba(0, 0, 0, .35);
    }
    .poster img { width: 100%; height: 100%; object-fit: cover; display: block }

    .h1 { margin: 0; font-size: 22px; letter-spacing: .2px; font-weight: 900 }
    .sub { margin-top: 6px; color: var(--muted); font-size: 13px; }

    .badges { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    .badge {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 7px 10px; border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(18, 24, 36, .45);
      color: rgba(231, 237, 249, .92);
      font-size: 13px;
      backdrop-filter: blur(10px);
    }
    .badge.imdb { border-color: rgba(242, 198, 79, .75); background: rgba(242, 198, 79, .10); }
    .badge b { font-size: 11px; letter-spacing: .6px; opacity: .9 }

    .genres { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    .genre {
      padding: 7px 10px; border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(18, 24, 36, .40);
      color: rgba(231, 237, 249, .88);
      font-size: 13px;
      backdrop-filter: blur(10px);
    }

    .desc {
      margin: 12px 0 0;
      color: rgba(231, 237, 249, .80);
      font-size: 14px;
      line-height: 1.55;
      max-width: 90ch;
    }

    .actions { margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 9px 12px; border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(255, 255, 255, .06);
      color: rgba(231, 237, 249, .92);
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
    }
    .btn:hover { background: rgba(255, 255, 255, .10); }

    a { color: var(--accent); text-decoration: none }
    a:hover { text-decoration: underline }

    .episodes { margin-top: 14px; padding: 14px; border-top: 1px solid rgba(255, 255, 255, .08); }
    .episodes-head { display: flex; align-items: center; gap: 10px; justify-content: space-between; flex-wrap: wrap; }
    .episodes-title { font-weight: 900; letter-spacing: .2px }

    .server-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 10px; }
    .server-label { color: var(--muted); font-size: 13px; font-weight: 700; margin-right: 6px }
    .server-pill {
      padding: 8px 10px; border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(18, 24, 36, .45);
      color: rgba(231, 237, 249, .90);
      font-size: 13px;
      cursor: pointer;
      touch-action: manipulation;
    }
    .server-pill.active { border-color: rgba(242, 198, 79, .35); background: rgba(242, 198, 79, .10); color: rgba(242, 198, 79, .98); }

    .ep-grid { margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap; }
    .ep {
      min-width: 108px;
      padding: 12px 12px; border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(18, 24, 36, .35);
      color: rgba(231, 237, 249, .90);
      font-size: 14px;
      text-align: center;
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
    }
    .ep:hover { background: rgba(255, 255, 255, .08); }
    .ep.active {
      border-color: rgba(242, 198, 79, .40);
      background: rgba(242, 198, 79, .14);
      color: rgba(242, 198, 79, .98);
      font-weight: 800;
    }
    .ep.disabled { opacity: .55; cursor: not-allowed; }

    .sidebar .head {
      padding: 14px 14px 10px;
      display: flex; align-items: center; justify-content: space-between;
      border-bottom: 1px solid rgba(255, 255, 255, .08);
    }
    .sidebar .head b { font-size: 18px; letter-spacing: .2px }

    .sug-list { padding: 10px 10px 14px; display: flex; flex-direction: column; gap: 10px; }
    .sug {
      display: grid;
      grid-template-columns: 54px minmax(0, 1fr);
      gap: 10px;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .05);
      cursor: pointer;
      touch-action: manipulation;
    }
    .sug:hover { background: rgba(255, 255, 255, .08); }
    .sug .thumb {
      width: 54px;
      aspect-ratio: 2/3;
      border-radius: 10px;
      overflow: hidden;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .10);
    }
    .sug img { width: 100%; height: 100%; object-fit: cover; display: block }
    .sug .t { font-weight: 850; font-size: 14px; line-height: 1.2; margin-top: 2px }
    .sug .m { color: var(--muted); font-size: 12px; margin-top: 6px }

    .empty { color: var(--muted); font-size: 13px; padding: 14px; }
  </style>
</head>

<body>
  <div class="container">
    <header class="topbar">
      <div class="brand" onclick="location.href='index.html'">
        <div class="brand-logo" aria-hidden="true"><span>K</span></div>
        <div>
          <div class="brand-name">Khoii</div>
          <div class="brand-sub">Xem phim</div>
        </div>
      </div>

      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M10.5 19a8.5 8.5 0 1 1 0-17 8.5 8.5 0 0 1 0 17Z" stroke="rgba(231,237,249,.85)" stroke-width="2" />
          <path d="M16.8 16.8 21 21" stroke="rgba(231,237,249,.85)" stroke-width="2" stroke-linecap="round" />
        </svg>
        <input id="q" placeholder="Tìm kiếm phim, diễn viên" />
      </div>

      <nav class="nav" aria-label="Main navigation">
        <a href="list.html">Thể loại</a>
        <a href="list.html?kind=movie">Phim Lẻ</a>
        <a href="list.html?kind=series">Phim Bộ</a>
        <a href="list.html">Quốc gia</a>
      </nav>

      <button class="member-btn" onclick="location.href='test.html'">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 12a4.5 4.5 0 1 0-4.5-4.5A4.5 4.5 0 0 0 12 12Z" stroke="rgba(231,237,249,.9)" stroke-width="2" />
          <path d="M20 21a8 8.0 0 1 0-16 0" stroke="rgba(231,237,249,.9)" stroke-width="2" stroke-linecap="round" />
        </svg>
        <span>Thành viên</span>
      </button>
    </header>

    <div class="grid">
      <main class="card">
        <div class="player-wrap">
          <div class="player-overlay" id="loading">
            <div style="display:flex;align-items:center;gap:10px">
              <div class="spinner"></div>
              <div style="color:rgba(231,237,249,.88);font-weight:800">Đang tải player…</div>
            </div>
          </div>

          <iframe id="frame" allow="autoplay; fullscreen" allowfullscreen referrerpolicy="no-referrer"></iframe>

          <!-- ✅ mask che icon ↗ Drive -->
          <div class="drive-ui-mask" aria-hidden="true"></div>
        </div>

        <section class="info">
          <div class="poster" id="posterBox" aria-label="Poster">
            <img id="posterImg" alt="" style="display:none" />
          </div>

          <div>
            <h1 class="h1" id="title">Đang tải…</h1>
            <div class="sub" id="subtitle">—</div>

            <div class="badges" id="badges" aria-label="Thông tin nhanh"></div>
            <div class="genres" id="genres" aria-label="Thể loại"></div>
            <p class="desc" id="desc"></p>

            <div class="actions">
              <div class="btn" id="btnLike">♥ Yêu thích</div>
              <div class="btn" id="btnEpisodes">Chuyển tập</div>
              <a class="btn" href="index.html">← Quay lại</a>
            </div>
          </div>
        </section>

        <section class="episodes" id="episodesSection">
          <div class="episodes-head">
            <div class="episodes-title">Server</div>
            <div style="color:var(--muted);font-size:13px">Chọn tập để xem</div>
          </div>
          <div class="server-row">
            <span class="server-label">Server</span>
            <span class="server-pill active">Khoilolo</span>
          </div>

          <div class="episodes-head" style="margin-top:12px">
            <div class="episodes-title">Tập phim</div>
            <div style="color:var(--muted);font-size:13px" id="epHint"></div>
          </div>
          <div class="ep-grid" id="epGrid"></div>
        </section>
      </main>

      <aside class="card sidebar">
        <div class="head">
          <b>Đề xuất</b>
          <a href="index.html" style="font-size:13px;color:var(--muted)">Xem tất cả</a>
        </div>
        <div class="sug-list" id="sugList">
          <div class="empty">Đang tải…</div>
        </div>
      </aside>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://nzalaxolteaiafvuceqz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56YWxheG9sdGVhaWFmdnVjZXF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTY2MjAsImV4cCI6MjA4NTg3MjYyMH0.0eIz6cfB4Dr_g5Wja70tZCMvVfUKoI5H4D8MJBP49Bg";

    const sb = window.supabase?.createClient
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    const SESSION_DRIVE_KEY = "khoii_watch_drive_v1";
    function setCurrentDriveId(id) { try { sessionStorage.setItem(SESSION_DRIVE_KEY, String(id || "")); } catch { } }
    function getCurrentDriveId() { try { return sessionStorage.getItem(SESSION_DRIVE_KEY) || ""; } catch { return ""; } }

    window.goWatch = function (driveId, title, ep, season) {
      const id = String(driveId || "").trim();
      if (id) setCurrentDriveId(id);

      const t = String(title || "").trim();
      const p = new URLSearchParams();
      if (t) p.set("title", t);
      if (season !== undefined && season !== null && season !== "") p.set("season", String(season));
      if (ep !== undefined && ep !== null && ep !== "") p.set("ep", String(ep));

      location.href = "watch.html" + (p.toString() ? "?" + p.toString() : "");
    };

    const DriveTool = (() => {
      const patterns = [
        /drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]{10,})/i,
        /drive\.google\.com\/open\?id=([a-zA-Z0-9_-]{10,})/i,
        /drive\.google\.com\/uc\?id=([a-zA-Z0-9_-]{10,})/i,
        /drive\.google\.com\/uc\?export=download&id=([a-zA-Z0-9_-]{10,})/i,
      ];
      function extractId(input) {
        const s = String(input || "").trim();
        if (/^[a-zA-Z0-9_-]{10,}$/.test(s)) return s;
        try {
          const u = new URL(s);
          const qid = u.searchParams.get("id");
          if (qid && /^[a-zA-Z0-9_-]{10,}$/.test(qid)) return qid;
        } catch { }
        for (const re of patterns) {
          const m = s.match(re);
          if (m && m[1]) return m[1];
        }
        return null;
      }
      function links(id) {
        return {
          id,
          preview: `https://drive.google.com/file/d/${encodeURIComponent(id)}/preview`,
          view: `https://drive.google.com/file/d/${encodeURIComponent(id)}/view`,
        };
      }
      function normalize(input) {
        const id = extractId(input);
        if (!id) return { ok: false, error: "Không tách được ID.", id: null, links: null };
        return { ok: true, id, links: links(id) };
      }
      return { normalize };
    })();

    const el = {
      q: document.getElementById("q"),
      title: document.getElementById("title"),
      subtitle: document.getElementById("subtitle"),
      badges: document.getElementById("badges"),
      genres: document.getElementById("genres"),
      desc: document.getElementById("desc"),
      frame: document.getElementById("frame"),
      loading: document.getElementById("loading"),
      posterBox: document.getElementById("posterBox"),
      posterImg: document.getElementById("posterImg"),
      epGrid: document.getElementById("epGrid"),
      epHint: document.getElementById("epHint"),
      btnEpisodes: document.getElementById("btnEpisodes"),
      episodesSection: document.getElementById("episodesSection"),
      sugList: document.getElementById("sugList"),
      btnLike: document.getElementById("btnLike"),
    };

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;").replaceAll("'", "&#039;");
    }

    function renderBadges(info) {
      const parts = [];
      if (info.imdb) parts.push(`<span class="badge imdb"><b>IMDb</b> ${escapeHtml(info.imdb)}</span>`);
      if (info.quality) parts.push(`<span class="badge">${escapeHtml(info.quality)}</span>`);
      if (info.year) parts.push(`<span class="badge">${escapeHtml(info.year)}</span>`);
      if (info.country) parts.push(`<span class="badge">${escapeHtml(info.country)}</span>`);
      if (info.kind) {
        const k = info.kind === "movie" ? "Phim Lẻ" : info.kind === "series" ? "Phim Bộ" : "Anime";
        parts.push(`<span class="badge">${escapeHtml(k)}</span>`);
      }
      el.badges.innerHTML = parts.join("");
    }

    function renderGenres(arr) {
      const gs = Array.isArray(arr) ? arr.filter(Boolean).slice(0, 16) : [];
      el.genres.innerHTML = gs.map(g => `<span class="genre">${escapeHtml(g)}</span>`).join("");
    }

    function setPoster(url) {
      const u = String(url || "").trim();
      if (!u) {
        el.posterImg.style.display = "none";
        el.posterBox.style.background = "rgba(255,255,255,.06)";
        return;
      }
      el.posterImg.src = u;
      el.posterImg.alt = "Poster";
      el.posterImg.style.display = "block";
    }

    function applySearchKeyword(q) {
      const s = (q || "").trim();
      if (!s) return;
      location.href = `list.html?q=${encodeURIComponent(s)}`;
    }

    function inferEpNumber(row, idx) {
      const s = `${row?.drivelink || ""} ${row?.title || ""}`.toLowerCase();
      const pats = [
        /tập\s*(\d{1,3})/,
        /\bep\s*(\d{1,3})/,
        /\bepisode\s*(\d{1,3})/,
        /[-_ ](\d{1,3})(?=\D|$)/,
      ];
      for (const re of pats) {
        const m = s.match(re);
        if (m && m[1]) {
          const n = parseInt(m[1], 10);
          if (Number.isFinite(n) && n > 0 && n < 1000) return n;
        }
      }
      return idx + 1;
    }

    function pad2(n) { return String(n).padStart(2, "0"); }

    async function fetchMovieByDriveId(driveId) {
      if (!sb) return null;
      try {
        const { data, error } = await sb
          .from("movies")
          .select("id,title,kind,year,quality,desc,genres,country,imdb,posterurl,herourl,driveid,drivelink,updatedat,created_at,ep,eps,season")
          .eq("driveid", driveId)
          .limit(1);
        if (error) return null;
        return (data || [])[0] || null;
      } catch { return null; }
    }

    async function fetchMovieByTitleEp(title, season, ep) {
      if (!sb || !title || !season || !ep) return null;
      try {
        const { data, error } = await sb
          .from("movies")
          .select("id,title,kind,year,quality,desc,genres,country,imdb,posterurl,herourl,driveid,drivelink,updatedat,created_at,ep,eps,season")
          .eq("title", title)
          .eq("season", season)
          .eq("ep", ep)
          .limit(1);

        if (error) return null;
        return (data || [])[0] || null;
      } catch { return null; }
    }

    async function fetchEpisodesByTitle(seriesTitle, kind) {
      if (!sb || !seriesTitle) return [];
      try {
        let q = sb
          .from("movies")
          .select("id,title,kind,driveid,drivelink,updatedat,created_at,ep,eps,season")
          .eq("title", seriesTitle);

        if (kind) q = q.eq("kind", kind);

        const { data, error } = await q
          .order("season", { ascending: true, nullsFirst: true })
          .order("ep", { ascending: true, nullsFirst: true })
          .order("created_at", { ascending: true })
          .limit(400);

        if (error) return [];

        const rows = Array.isArray(data) ? data : [];
        return rows.map((r, i) => ({
          ...r,
          _season: Number.isFinite(r.season) ? r.season : 1,
          _ep: Number.isFinite(r.ep) ? r.ep : inferEpNumber(r, i),
          _eps: Number.isFinite(r.eps) ? r.eps : null,
        }));
      } catch { return []; }
    }

    async function fetchSuggestions(excludeDriveId) {
      if (!sb) return [];
      try {
        let q = sb.from("movies")
          .select("title,kind,year,posterurl,driveid,updatedat,created_at")
          .limit(12);

        q = q.order("updatedat", { ascending: false, nullsFirst: false })
          .order("created_at", { ascending: false });

        const { data, error } = await q;
        if (error) return [];
        return (data || []).filter(x => x.driveid !== excludeDriveId).slice(0, 8);
      } catch { return []; }
    }

    function renderSuggestions(items) {
      if (!items || items.length === 0) {
        el.sugList.innerHTML = `<div class="empty">Chưa có đề xuất.</div>`;
        return;
      }

      el.sugList.innerHTML = "";
      items.forEach(it => {
        const k = it.kind === "movie" ? "Phim Lẻ" : it.kind === "series" ? "Phim Bộ" : "Anime";
        const meta = [k, it.year].filter(Boolean).join(" • ");
        const poster = String(it.posterurl || "").trim();

        const wrap = document.createElement("div");
        wrap.className = "sug";
        wrap.addEventListener("click", () => {
          if (!it.driveid) return alert("Phim này chưa có Drive ID.");
          window.goWatch(it.driveid, it.title || "", 1, 1);
        });

        const thumb = document.createElement("div");
        thumb.className = "thumb";
        if (poster) {
          const img = document.createElement("img");
          img.alt = "";
          img.loading = "lazy";
          img.referrerPolicy = "no-referrer";
          img.src = poster;
          thumb.appendChild(img);
        }

        const right = document.createElement("div");
        const t = document.createElement("div");
        t.className = "t";
        t.textContent = it.title || "—";
        const m = document.createElement("div");
        m.className = "m";
        m.textContent = meta || "";
        right.appendChild(t);
        right.appendChild(m);

        wrap.appendChild(thumb);
        wrap.appendChild(right);
        el.sugList.appendChild(wrap);
      });
    }

    function renderEpisodes(list, currentDriveId, seriesTitle, currentEp, currentSeason) {
      if (!Array.isArray(list) || list.length === 0) {
        el.epHint.textContent = "Chưa có danh sách tập.";
        el.epGrid.innerHTML = `<div class="empty" style="padding:0">Không có tập.</div>`;
        return;
      }

      el.epHint.textContent = `${list.length} tập`;
      el.epGrid.innerHTML = "";

      list.forEach((r, i) => {
        const ep = r._ep || (i + 1);
        const season = r._season || 1;

        const isActive =
          (currentEp && currentSeason && ep === currentEp && season === currentSeason) ||
          (r.driveid === currentDriveId);

        const btn = document.createElement("div");
        btn.className = "ep" + (isActive ? " active" : "");
        btn.textContent = `Tập ${pad2(ep)}`;

        if (!r.driveid) {
          btn.classList.add("disabled");
        } else {
          btn.addEventListener("click", () => {
            window.goWatch(r.driveid, seriesTitle || "", ep, season);
          });
        }

        el.epGrid.appendChild(btn);
      });
    }

    (async () => {
      el.q.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter") applySearchKeyword(el.q.value);
      });

      el.btnEpisodes?.addEventListener("click", () => {
        el.episodesSection?.scrollIntoView({ behavior: "smooth", block: "start" });
      });

      el.btnLike?.addEventListener("click", () => {
        alert("Đã thêm vào yêu thích (demo).");
      });

      const params = new URLSearchParams(location.search);
      const titleQ = (params.get("title") || "Xem phim").trim();
      const epWanted = Number(params.get("ep") || "") || null;
      const seasonWanted = Number(params.get("season") || "") || 1;

      const driveParam = (params.get("drive") || params.get("m") || "").trim();
      let driveCandidate = "";

      if (driveParam) {
        driveCandidate = driveParam;
      } else if (titleQ && epWanted) {
        const row = await fetchMovieByTitleEp(titleQ, seasonWanted, epWanted);
        driveCandidate = row?.driveid || getCurrentDriveId();
      } else {
        driveCandidate = getCurrentDriveId();
      }

      const r = DriveTool.normalize(driveCandidate);
      if (!r.ok) {
        el.title.textContent = "Không có phim để phát";
        el.subtitle.textContent = "Thiếu link/ID hoặc không hợp lệ.";
        el.loading.style.display = "none";
        el.frame.src = "";
        renderBadges({ quality: "—" });
        renderGenres([]);
        el.desc.textContent = "";
        renderSuggestions([]);
        renderEpisodes([], "", titleQ, epWanted, seasonWanted);
        return;
      }

      setCurrentDriveId(r.id);

      const cleanParams = new URLSearchParams();
      if (titleQ) cleanParams.set("title", titleQ);
      if (seasonWanted) cleanParams.set("season", String(seasonWanted));
      if (epWanted) cleanParams.set("ep", String(epWanted));
      history.replaceState({}, "", "watch.html" + (cleanParams.toString() ? "?" + cleanParams.toString() : ""));

      el.frame.src = r.links.preview;
      el.frame.addEventListener("load", () => { el.loading.style.display = "none"; });
      setTimeout(() => { el.loading.style.display = "none"; }, 6500);

      el.title.textContent = titleQ || "Xem phim";
      el.subtitle.textContent = "Đang tải thông tin…";
      renderBadges({ quality: "FHD", kind: "anime" });
      renderGenres([]);
      el.desc.textContent = "";
      setPoster("");

      const info = await fetchMovieByDriveId(r.id);
      const seriesTitle = (info?.title || titleQ || "Xem phim").trim();
      el.title.textContent = seriesTitle;
      document.title = seriesTitle + " - Khoii";

      if (info) {
        el.subtitle.textContent = info.kind === "movie" ? "Phim Lẻ" : info.kind === "series" ? "Phim Bộ" : "Anime";
        renderBadges(info);
        renderGenres(info.genres);
        el.desc.textContent = info.desc || "";
        setPoster(info.posterurl || "");
      } else {
        el.subtitle.textContent = "Không tìm thấy dữ liệu phim trong kho (vẫn xem được nếu Drive hợp lệ).";
      }

      if (info?.kind === "movie") {
        el.episodesSection.style.display = "none";
        el.btnEpisodes.style.display = "none";
      } else {
        el.episodesSection.style.display = "";
        el.btnEpisodes.style.display = "";
        const eps = await fetchEpisodesByTitle(seriesTitle, info?.kind || null);

        if (epWanted && eps.length) {
          const hit = eps.find(x => x._season === seasonWanted && x._ep === epWanted);
          if (hit?.driveid && hit.driveid !== r.id) {
            setCurrentDriveId(hit.driveid);
            const rr = DriveTool.normalize(hit.driveid);
            if (rr.ok) el.frame.src = rr.links.preview;
          }
        }

        renderEpisodes(eps, getCurrentDriveId() || r.id, seriesTitle, epWanted, seasonWanted);
      }

      const sug = await fetchSuggestions(getCurrentDriveId() || r.id);
      renderSuggestions(sug);
    })();
  </script>
</body>

</html>
